var W=5.960464477539063e-8,D=4294967296,G=9007199254740992;function q(e){var t,n=new ArrayBuffer(256),i=new DataView(n),s=0;function r(e){for(var r=n.byteLength,a=s+e;r<a;)r<<=1;if(r!==n.byteLength){var o=i;n=new ArrayBuffer(r),i=new DataView(n);for(var c=s+3>>2,h=0;h<c;++h)i.setUint32(h<<2,o.getUint32(h<<2))}return t=e,i}function a(){s+=t}function o(e){a(r(1).setUint8(s,e))}function c(e){for(var t=r(e.length),n=0;n<e.length;++n)t.setUint8(s+n,e[n]);a()}function h(e,t){t<24?o(e<<5|t):t<256?(o(e<<5|24),o(t)):t<65536?(o(e<<5|25),function(e){a(r(2).setUint16(s,e))}(t)):t<4294967296?(o(e<<5|26),function(e){a(r(4).setUint32(s,e))}(t)):(o(e<<5|27),function(e){var t=e%D,n=(e-t)/D,i=r(8);i.setUint32(s,n),i.setUint32(s+4,t),a()}(t))}if(function e(t){var n;if(!1===t)return o(244);if(!0===t)return o(245);if(null===t)return o(246);if(void 0===t)return o(247);switch(typeof t){case"number":if(Math.floor(t)===t){if(0<=t&&t<=G)return h(0,t);if(-G<=t&&t<0)return h(1,-(t+1))}return o(251),function(e){a(r(8).setFloat64(s,e))}(t);case"string":var i=[];for(n=0;n<t.length;++n){var l=t.charCodeAt(n);l<128?i.push(l):l<2048?(i.push(192|l>>6),i.push(128|63&l)):l<55296?(i.push(224|l>>12),i.push(128|l>>6&63),i.push(128|63&l)):(l=(1023&l)<<10,l|=1023&t.charCodeAt(++n),l+=65536,i.push(240|l>>18),i.push(128|l>>12&63),i.push(128|l>>6&63),i.push(128|63&l))}return h(3,i.length),c(i);default:var u;if(Array.isArray(t))for(h(4,u=t.length),n=0;n<u;++n)e(t[n]);else if(t instanceof Uint8Array)h(2,t.length),c(t);else{var f=Object.keys(t);for(h(5,u=f.length),n=0;n<u;++n){var g=f[n];e(g),e(t[g])}}}}(e),"slice"in n)return n.slice(0,s);for(var l=new ArrayBuffer(s),u=new DataView(l),f=0;f<s;++f)u.setUint8(f,i.getUint8(f));return l}function B(e,t,n){var i=new DataView(e),s=0;function r(e,t){return s+=e,t}function a(t){return r(t,new Uint8Array(e,s,t))}function o(){return r(1,i.getUint8(s))}function c(){return r(2,i.getUint16(s))}function h(){return r(4,i.getUint32(s))}function l(){return 255===i.getUint8(s)&&(s+=1,!0)}function u(e){if(e<24)return e;if(24===e)return o();if(25===e)return c();if(26===e)return h();if(27===e)return h()*D+h();if(31===e)return-1;throw"Invalid length encoding"}function f(e){var t=o();if(255===t)return-1;var n=u(31&t);if(n<0||t>>5!==e)throw"Invalid indefinite length element";return n}function g(e,t){for(var n=0;n<t;++n){var i=o();128&i&&(i<224?(i=(31&i)<<6|63&o(),t-=1):i<240?(i=(15&i)<<12|(63&o())<<6|63&o(),t-=2):(i=(15&i)<<18|(63&o())<<12|(63&o())<<6|63&o(),t-=3)),i<65536?e.push(i):(i-=65536,e.push(55296|i>>10),e.push(56320|1023&i))}}"function"!=typeof t&&(t=function(e){return e}),"function"!=typeof n&&(n=function(){});var _=function e(){var h,_,d=o(),v=d>>5,p=31&d;if(7===v)switch(p){case 25:return function(){var e=new ArrayBuffer(4),t=new DataView(e),n=c(),i=32768&n,s=31744&n,r=1023&n;if(31744===s)s=261120;else if(0!==s)s+=114688;else if(0!==r)return(i?-1:1)*r*W;return t.setUint32(0,i<<16|s<<13|r<<13),t.getFloat32(0)}();case 26:return r(4,i.getFloat32(s));case 27:return r(8,i.getFloat64(s))}if((_=u(p))<0&&(v<2||6<v))throw"Invalid length";switch(v){case 0:return _;case 1:return-1-_;case 2:if(_<0){for(var w=[],I=0;(_=f(v))>=0;)I+=_,w.push(a(_));var m=new Uint8Array(I),E=0;for(h=0;h<w.length;++h)m.set(w[h],E),E+=w[h].length;return m}return a(_);case 3:var A=[];if(_<0)for(;(_=f(v))>=0;)g(A,_);else g(A,_);return String.fromCharCode.apply(null,A);case 4:var b;if(_<0)for(b=[];!l();)b.push(e());else for(b=new Array(_),h=0;h<_;++h)b[h]=e();return b;case 5:var C={};for(h=0;h<_||_<0&&!l();++h){C[e()]=e()}return C;case 6:return t(e(),_);case 7:switch(_){case 20:return!1;case 21:return!0;case 22:return null;case 23:return;default:return n(_)}}}();if(s!==e.byteLength)throw"Remaining bytes";return _}const M={encode:q,decode:B},v={READ:0,READ_RSP:1,WRITE:2,WRITE_RSP:3},m={OS:0,IMAGE:1,STAT:2,CONFIG:3,LOG:4,CRASH:5,SPLIT:6,RUN:7,FS:8,SHELL:9},F={ECHO:0,CONS_ECHO_CTRL:1,TASKSTAT:2,MPSTAT:3,DATETIME_STR:4,RESET:5},S={STATE:0,UPLOAD:1,FILE:2,CORELIST:3,CORELOAD:4,ERASE:5};class H{constructor(e={}){this.SMP_SERVICE_UUID="8d53dc1d-1db7-4cd3-868b-8a527460aa84",this.SMP_CHARACTERISTIC_UUID="da2e7828-fbce-4e01-ae9e-261174997c48",this._mtu=140,this._device=null,this._service=null,this._characteristic=null,this._connectCallback=null,this._connectingCallback=null,this._disconnectCallback=null,this._connectionLossCallback=null,this._messageCallback=null,this._imageUploadProgressCallback=null,this._uploadIsInProgress=!1,this._buffer=new Uint8Array,this._logger=e.logger||{info:console.log,error:console.error},this._seq=0,this._userRequestedDisconnect=!1}async _requestDevice(e){const t={acceptAllDevices:!1,optionalServices:[this.SMP_SERVICE_UUID]};return e&&(t.filters=e,t.acceptAllDevices=!1),navigator.bluetooth.requestDevice(t)}async connect(e){try{this._device=await this._requestDevice(e),this._logger.info(`Connecting to device ${this.name}...`),this._device.addEventListener("gattserverdisconnected",(async e=>{this._logger.info(e),!1===this._userRequestedDisconnect?(this._logger.info("Trying to reconnect"),await new Promise((e=>setTimeout(e,1e3))),this._connectionLossCallback&&this._connectionLossCallback(),await this._connect()):this._disconnected()})),await this._connect()}catch(e){return this._logger.error(e),void await this._disconnected()}}async _connect(){try{this._connectingCallback&&this._connectingCallback();const e=await this._device.gatt.connect();this._logger.info("Server connected."),this._service=await e.getPrimaryService(this.SMP_SERVICE_UUID),this._logger.info("Service connected."),this._characteristic=await this._service.getCharacteristic(this.SMP_CHARACTERISTIC_UUID),this._characteristic.addEventListener("characteristicvaluechanged",this._notification.bind(this)),await this._characteristic.startNotifications(),await this._connected(),this._uploadIsInProgress&&this._uploadNext()}catch(e){this._logger.error(e),await this._disconnected()}}disconnect(){return this._userRequestedDisconnect=!0,this._device.gatt.disconnect()}onConnecting(e){return this._connectingCallback=e,this}onConnect(e){return this._connectCallback=e,this}onDisconnect(e){return this._disconnectCallback=e,this}onConnectionLoss(e){return this._connectionLossCallback=e,this}onMessage(e){return this._messageCallback=e,this}onImageUploadProgress(e){return this._imageUploadProgressCallback=e,this}onImageUploadFinished(e){return this._imageUploadFinishedCallback=e,this}async _connected(){this._connectCallback&&this._connectCallback()}async _disconnected(){this._logger.info("Disconnected."),this._disconnectCallback&&this._disconnectCallback(),this._device=null,this._service=null,this._characteristic=null,this._uploadIsInProgress=!1,this._userRequestedDisconnect=!1}get name(){return this._device&&this._device.name}async _sendMessage(e,t,n,i){let s=[];typeof i<"u"&&(s=[...new Uint8Array(M.encode(i))]);const r=255&s.length,a=[e,0,s.length>>8,r,t>>8,255&t,this._seq,n,...s];await this._characteristic.writeValueWithoutResponse(Uint8Array.from(a)),this._seq=(this._seq+1)%256}_notification(e){const t=new Uint8Array(e.target.value.buffer);this._buffer=new Uint8Array([...this._buffer,...t]);const n=256*this._buffer[2]+this._buffer[3];this._buffer.length<n+8||(this._processMessage(this._buffer.slice(0,n+8)),this._buffer=this._buffer.slice(n+8))}_processMessage(e){const[t,n,i,s,r,a,o,c]=e,h=M.decode(e.slice(8).buffer),l=256*i+s,u=256*r+a;if(u===m.IMAGE&&c===S.UPLOAD&&(0===h.rc||void 0===h.rc)&&h.off)return this._uploadOffset=h.off,void this._uploadNext();this._messageCallback&&this._messageCallback({op:t,group:u,id:c,data:h,length:l})}cmdReset(){return this._sendMessage(v.WRITE,m.OS,F.RESET)}smpEcho(e){return this._sendMessage(v.WRITE,m.OS,F.ECHO,{d:e})}cmdImageState(){return this._sendMessage(v.READ,m.IMAGE,S.STATE)}cmdImageErase(){return this._sendMessage(v.WRITE,m.IMAGE,S.ERASE,{})}cmdImageTest(e){return this._sendMessage(v.WRITE,m.IMAGE,S.STATE,{hash:e,confirm:!1})}cmdImageConfirm(e){return this._sendMessage(v.WRITE,m.IMAGE,S.STATE,{hash:e,confirm:!0})}_hash(e){return crypto.subtle.digest("SHA-256",e)}async _uploadNext(){if(this._uploadOffset>=this._uploadImage.byteLength)return this._uploadIsInProgress=!1,void this._imageUploadFinishedCallback();const e={data:new Uint8Array,off:this._uploadOffset};0===this._uploadOffset&&(e.len=this._uploadImage.byteLength,e.sha=new Uint8Array(await this._hash(this._uploadImage))),this._imageUploadProgressCallback({percentage:Math.floor(this._uploadOffset/this._uploadImage.byteLength*100)});const t=this._mtu-M.encode(e).byteLength-8;e.data=new Uint8Array(this._uploadImage.slice(this._uploadOffset,this._uploadOffset+t)),this._uploadOffset+=t,this._sendMessage(v.WRITE,m.IMAGE,S.UPLOAD,e)}async cmdUpload(e,t=0){this._uploadIsInProgress?this._logger.error("Upload is already in progress."):(this._uploadIsInProgress=!0,this._uploadOffset=0,this._uploadImage=e,this._uploadSlot=t,this._uploadNext())}async imageInfo(e){const t={},n=new Uint8Array(e);if(n.length<32)throw new Error("Invalid image (too short file)");if(61!==n[0]||184!==n[1]||243!==n[2]||150!==n[3])throw new Error("Invalid image (wrong magic bytes)");if(0!==n[4]||0!==n[5]||0!==n[6]||0!==n[7])throw new Error("Invalid image (wrong load address)");const i=n[8]+256*n[9];if(0!==n[10]||0!==n[11])throw new Error("Invalid image (wrong protected TLV area size)");const s=n[12]+256*n[13]+65536*n[14]+n[15]*2**24;if(t.imageSize=s,n.length<s+i)throw new Error("Invalid image (wrong image size)");if(0!==n[16]||0!==n[17]||0!==n[18]||0!==n[19])throw new Error("Invalid image (wrong flags)");const r=`${n[20]}.${n[21]}.${n[22]+256*n[23]}`;return t.version=r,t.hash=[...new Uint8Array(await this._hash(e.slice(0,s+32)))].map((e=>e.toString(16).padStart(2,"0"))).join(""),t}}export{S as I,H as M,F as O,m as a};