import{e as Ut,r as De,s as Re,a as Ie,b as st,c as be,d as it,h as W,f as ot,E as ct,H as Mt,g as lt,i as Ce,j as Te,k as we,l as Ae,m as Ue,p as Ve,U as Pt,n as de,o as R,q as ft,t as Lt,u as kt,v as We,I as Ne,w as dt,x as xt,y as Ot,z as Nt,A as Ct,B as Tt,C as Vt,D as Ft,F as Bt,G as Gt,J as Ht,L as $t,N as jt,K as zt,M as qt,O as Wt,P as Xt,Q as Kt,R as Yt,S as xe,T as Zt,V as Qt,W as pe,X as Jt,Y as Se,Z as en,_ as Me,$ as tn,a0 as nn,a1 as ge,a2 as rn,a3 as ce,a4 as J,a5 as k,a6 as z,a7 as I,a8 as ee,a9 as x,aa as A,ab as U,ac as ut,ad as le,ae as Y,af as X,ag as oe,ah as G,ai as Ee,aj as Oe}from"./render.hOjBFm4t.js";/* empty css                                */const an="5";typeof window<"u"&&((window.__svelte??={}).v??=new Set).add(an);Ut();const sn=typeof requestIdleCallback>"u"?r=>setTimeout(r,1):requestIdleCallback;let Pe=[],Le=[];function on(){var r=Pe;Pe=[],De(r)}function cn(){var r=Le;Le=[],De(r)}function ln(r){Pe.length===0&&queueMicrotask(on),Pe.push(r)}function fn(r){Le.length===0&&sn(cn),Le.push(r)}function dn(r){throw new Error("https://svelte.dev/e/lifecycle_outside_component")}let Xe=!1;function vt(){Xe||(Xe=!0,document.addEventListener("reset",r=>{Promise.resolve().then(()=>{if(!r.defaultPrevented)for(const e of r.target.elements)e.__on_r?.()})},{capture:!0}))}function ht(r){var e=st,t=be;Re(null),Ie(null);try{return r()}finally{Re(e),Ie(t)}}function un(r,e,t,n=t){r.addEventListener(e,()=>ht(t));const a=r.__on_r;a?r.__on_r=()=>{a(),n(!0)}:r.__on_r=()=>n(!0),vt()}function N(r,e,[t,n]=[0,0]){W&&t===0&&ot();var a=r,i=null,s=null,c=Pt,o=t>0?ct:0,h=!1;const l=(g,w=!0)=>{h=!0,_(w,g)},_=(g,w)=>{if(c===(c=g))return;let u=!1;if(W&&n!==-1){if(t===0){const M=a.data;M===Mt?n=0:M===lt?n=1/0:(n=parseInt(M.substring(1)),n!==n&&(n=c?1/0:-1))}const y=n>t;!!c===y&&(a=Ce(),Te(a),we(!1),u=!0,n=-1)}c?(i?Ae(i):w&&(i=Ue(()=>w(a))),s&&Ve(s,()=>{s=null})):(s?Ae(s):w&&(s=Ue(()=>w(a,[t+1,n]))),i&&Ve(i,()=>{i=null})),u&&we(!0)};it(()=>{h=!1,e(l),h||_(null,null)},o),W&&(a=de)}function Fe(r,e){return e}function vn(r,e,t,n){for(var a=[],i=e.length,s=0;s<i;s++)Nt(e[s].e,a,!0);var c=i>0&&a.length===0&&t!==null;if(c){var o=t.parentNode;Ct(o),o.append(t),n.clear(),se(r,e[0].prev,e[i-1].next)}Tt(a,()=>{for(var h=0;h<i;h++){var l=e[h];c||(n.delete(l.k),se(r,l.prev,l.next)),Vt(l.e,!c)}})}function Be(r,e,t,n,a,i=null){var s=r,c={flags:e,items:new Map,first:null};W&&ot();var o=null,h=!1,l=ft(()=>{var _=t();return Gt(_)?_:_==null?[]:dt(_)});it(()=>{var _=R(l),g=_.length;if(h&&g===0)return;h=g===0;let w=!1;if(W){var u=s.data===lt;u!==(g===0)&&(s=Ce(),Te(s),we(!1),w=!0)}if(W){for(var y=null,M,m=0;m<g;m++){if(de.nodeType===8&&de.data===Lt){s=de,w=!0,we(!1);break}var f=_[m],S=n(f,m);M=gt(de,c,y,null,f,S,m,a,e,t),c.items.set(S,M),y=M}g>0&&Te(Ce())}W||hn(_,c,s,a,e,n,t),i!==null&&(g===0?o?Ae(o):o=Ue(()=>i(s)):o!==null&&Ve(o,()=>{o=null})),w&&we(!0),R(l)}),W&&(s=de)}function hn(r,e,t,n,a,i,s){var c=r.length,o=e.items,h=e.first,l=h,_,g=null,w=[],u=[],y,M,m,f;for(f=0;f<c;f+=1){if(y=r[f],M=i(y,f),m=o.get(M),m===void 0){var S=l?l.e.nodes_start:t;g=gt(S,e,g,g===null?e.first:g.next,y,M,f,n,a,s),o.set(M,g),w=[],u=[],l=g.next;continue}if(gn(m,y,f),(m.e.f&Ne)!==0&&Ae(m.e),m!==l){if(_!==void 0&&_.has(m)){if(w.length<u.length){var p=u[0],d;g=p.prev;var E=w[0],v=w[w.length-1];for(d=0;d<w.length;d+=1)Ke(w[d],p,t);for(d=0;d<u.length;d+=1)_.delete(u[d]);se(e,E.prev,v.next),se(e,g,E),se(e,v,p),l=p,g=v,f-=1,w=[],u=[]}else _.delete(m),Ke(m,l,t),se(e,m.prev,m.next),se(e,m,g===null?e.first:g.next),se(e,g,m),g=m;continue}for(w=[],u=[];l!==null&&l.k!==M;)(l.e.f&Ne)===0&&(_??=new Set).add(l),u.push(l),l=l.next;if(l===null)continue;m=l}w.push(m),g=m,l=m.next}if(l!==null||_!==void 0){for(var b=_===void 0?[]:dt(_);l!==null;)(l.e.f&Ne)===0&&b.push(l),l=l.next;var O=b.length;if(O>0){var F=null;vn(e,b,F,o)}}be.first=e.first&&e.first.e,be.last=g&&g.e}function gn(r,e,t,n){Ot(r.v,e),r.i=t}function gt(r,e,t,n,a,i,s,c,o,h){var l=(o&Ft)!==0,_=(o&Bt)===0,g=l?_?kt(a):We(a):a,w=(o&xt)===0?s:We(s),u={i:w,v:g,k:i,a:null,e:null,prev:t,next:n};try{return u.e=Ue(()=>c(r,g,w,h),W),u.e.prev=t&&t.e,u.e.next=n&&n.e,t===null?e.first=u:(t.next=u,t.e.next=u.e),n!==null&&(n.prev=u,n.e.prev=u.e),u}finally{}}function Ke(r,e,t){for(var n=r.next?r.next.e.nodes_start:t,a=e?e.e.nodes_start:t,i=r.e.nodes_start;i!==n;){var s=Ht(i);a.before(i),i=s}}function se(r,e,t){e===null?r.first=t:(e.next=t,e.e.next=t&&t.e),t!==null&&(t.prev=e,t.e.prev=e&&e.e)}function pt(r){var e,t,n="";if(typeof r=="string"||typeof r=="number")n+=r;else if(typeof r=="object")if(Array.isArray(r)){var a=r.length;for(e=0;e<a;e++)r[e]&&(t=pt(r[e]))&&(n&&(n+=" "),n+=t)}else for(t in r)r[t]&&(n&&(n+=" "),n+=t);return n}function pn(){for(var r,e,t=0,n="",a=arguments.length;t<a;t++)(r=arguments[t])&&(e=pt(r))&&(n&&(n+=" "),n+=e);return n}function Ye(r){return typeof r=="object"?pn(r):r??""}const Ze=[...` 	
\r\f \v\uFEFF`];function _n(r,e,t){var n=r==null?"":""+r;if(e&&(n=n?n+" "+e:e),t){for(var a in t)if(t[a])n=n?n+" "+a:a;else if(n.length)for(var i=a.length,s=0;(s=n.indexOf(a,s))>=0;){var c=s+i;(s===0||Ze.includes(n[s-1]))&&(c===n.length||Ze.includes(n[c]))?n=(s===0?"":n.substring(0,s))+n.substring(c+1):s=c}}return n===""?null:n}function ie(r,e,t,n,a,i){var s=r.__className;if(W||s!==t){var c=_n(t,n,i);(!W||c!==r.getAttribute("class"))&&(c==null?r.removeAttribute("class"):r.className=c),r.__className=t}else if(i&&a!==i)for(var o in i){var h=!!i[o];(a==null||h!==!!a[o])&&r.classList.toggle(o,h)}return i}const mn=Symbol("is custom element"),wn=Symbol("is html");function bn(r){if(W){var e=!1,t=()=>{if(!e){if(e=!0,r.hasAttribute("value")){var n=r.value;ve(r,"value",null),r.value=n}if(r.hasAttribute("checked")){var a=r.checked;ve(r,"checked",null),r.checked=a}}};r.__on_r=t,fn(t),vt()}}function ve(r,e,t,n){var a=En(r);W&&(a[e]=r.getAttribute(e),e==="src"||e==="srcset"||e==="href"&&r.nodeName==="LINK")||a[e]!==(a[e]=t)&&(e==="loading"&&(r[$t]=t),t==null?r.removeAttribute(e):typeof t!="string"&&yn(r).includes(e)?r[e]=t:r.setAttribute(e,t))}function En(r){return r.__attributes??={[mn]:r.nodeName.includes("-"),[wn]:r.namespaceURI===jt}}var Qe=new Map;function yn(r){var e=Qe.get(r.nodeName);if(e)return e;Qe.set(r.nodeName,e=[]);for(var t,n=r,a=Element.prototype;a!==n;){t=qt(n);for(var i in t)t[i].set&&e.push(i);n=zt(n)}return e}const Sn=()=>performance.now(),re={tick:r=>requestAnimationFrame(r),now:()=>Sn(),tasks:new Set};function _t(){const r=re.now();re.tasks.forEach(e=>{e.c(r)||(re.tasks.delete(e),e.f())}),re.tasks.size!==0&&re.tick(_t)}function Dn(r){let e;return re.tasks.size===0&&re.tick(_t),{promise:new Promise(t=>{re.tasks.add(e={c:r,f:t})}),abort(){re.tasks.delete(e)}}}function Je(r,e){ht(()=>{r.dispatchEvent(new CustomEvent(e))})}function Rn(r){if(r==="float")return"cssFloat";if(r==="offset")return"cssOffset";if(r.startsWith("--"))return r;const e=r.split("-");return e.length===1?e[0]:e[0]+e.slice(1).map(t=>t[0].toUpperCase()+t.slice(1)).join("")}function et(r){const e={},t=r.split(";");for(const n of t){const[a,i]=n.split(":");if(!a||i===void 0)break;const s=Rn(a.trim());e[s]=i.trim()}return e}const In=r=>r;function tt(r,e,t,n){var a=(r&Zt)!==0,i="in",s,c=e.inert,o=e.style.overflow,h,l;function _(){var M=st,m=be;Re(null),Ie(null);try{return s??=t()(e,n?.()??{},{direction:i})}finally{Re(M),Ie(m)}}var g={is_global:a,in(){e.inert=c,h?.abort(),Je(e,"introstart"),h=mt(e,_(),l,1,()=>{Je(e,"introend"),h?.abort(),h=s=void 0,e.style.overflow=o})},out(M){{M?.(),s=void 0;return}},stop:()=>{h?.abort()}},w=be;if((w.transitions??=[]).push(g),Wt){var u=a;if(!u){for(var y=w.parent;y&&(y.f&ct)!==0;)for(;(y=y.parent)&&(y.f&Xt)===0;);u=!y||(y.f&Kt)!==0}u&&Yt(()=>{xe(()=>g.in())})}}function mt(r,e,t,n,a){if(Qt(e)){var i,s=!1;return ln(()=>{if(!s){var y=e({direction:"in"});i=mt(r,y,t,n,a)}}),{abort:()=>{s=!0,i?.abort()},deactivate:()=>i.deactivate(),reset:()=>i.reset(),t:()=>i.t()}}if(!e?.duration)return a(),{abort:pe,deactivate:pe,reset:pe,t:()=>n};const{delay:c=0,css:o,tick:h,easing:l=In}=e;var _=[];if(h&&h(0,1),o){var g=et(o(0,1));_.push(g,g)}var w=()=>1-n,u=r.animate(_,{duration:c});return u.onfinish=()=>{var y=1-n,M=n-y,m=e.duration*Math.abs(M),f=[];if(m>0){var S=!1;if(o)for(var p=Math.ceil(m/16.666666666666668),d=0;d<=p;d+=1){var E=y+M*l(d/p),v=et(o(E,1-E));f.push(v),S||=v.overflow==="hidden"}S&&(r.style.overflow="hidden"),w=()=>{var b=u.currentTime;return y+M*l(b/m)},h&&Dn(()=>{if(u.playState!=="running")return!1;var b=w();return h(b,1-b),!0})}u=r.animate(f,{duration:m,fill:"forwards"}),u.onfinish=()=>{w=()=>n,h?.(n,1-n),a()}},{abort:()=>{u&&(u.cancel(),u.effect=null,u.onfinish=pe)},deactivate:()=>{a=pe},reset:()=>{},t:()=>w()}}function An(r,e,t=e){un(r,"change",n=>{var a=n?r.defaultChecked:r.checked;t(a)}),(W&&r.defaultChecked!==r.checked||xe(e)==null)&&t(r.checked),Jt(()=>{var n=e();r.checked=!!n})}function ze(r=!1){const e=Se,t=e.l.u;if(!t)return;let n=()=>nn(e.s);if(r){let a=0,i={};const s=ge(()=>{let c=!1;const o=e.s;for(const h in o)o[h]!==i[h]&&(i[h]=o[h],c=!0);return c&&a++,a});n=()=>R(s)}t.b.length&&en(()=>{nt(e,n),De(t.b)}),Me(()=>{const a=xe(()=>t.m.map(tn));return()=>{for(const i of a)typeof i=="function"&&i()}}),t.a.length&&Me(()=>{nt(e,n),De(t.a)})}function nt(r,e){if(r.l.s)for(const t of r.l.s)R(t);e()}function wt(r){Se===null&&dn(),rn&&Se.l!==null?Un(Se).m.push(r):Me(()=>{const e=xe(r);if(typeof e=="function")return e})}function Un(r){var e=r.l;return e.u??={a:[],b:[],m:[]}}const Mn={src:"/build_assets/monkey_program.BSsup4eG.png"},Pn={src:"/build_assets/bluetooth.CLxde-uU.svg"};class H{static LEVEL_DEBUG=0;static LEVEL_INFO=1;static LEVEL_WARNING=2;static LEVEL_ERROR=3;static LEVEL_IMPORTANT=4;static#r="gray";static#a="white";static#s="yellow";static#i="red";static#o="blue";#n;#e;constructor(e,t){this.#n=e,this.#e=t}#t(e,t){if(typeof e=="object"){console.log(`%c${this.#n}: ⬇︎`,`color: ${t}`),console.log(e);return}console.log(`%c${this.#n}: ${e}`,`color: ${t}`)}debug(e){this.#e<=H.LEVEL_DEBUG&&this.#t(e,H.#r)}info(e){this.#e<=H.LEVEL_INFO&&this.#t(e,H.#a)}warning(e){this.#e<=H.LEVEL_WARNING&&this.#t(e,H.#s)}error(e){this.#e<=H.LEVEL_ERROR&&this.#t(e,H.#i)}important(e){this.#e<=H.LEVEL_IMPORTANT&&this.#t(e,H.#o)}}const Ln=r=>crypto.subtle.digest("SHA-256",r);let _e=new H("bluetooth",H.LEVEL_INFO);class kn{constructor(e,t,n=8){this.serviceUUID=e,this.characteristicUUID=t,this.headerSize=n,this.device=null,this.service=null,this.characteristic=null,this.mtu=250,this.buffer=new Uint8Array([]),this.state={type:"disconnected"},this._onConnect=new Set,this._onDisconnect=new Set,this._onConnecting=new Set,this._onConnectionLoss=new Set,this._onConnectionReestablished=new Set,this._onDataReceived=new Set}onConnect(e){this._onConnect.add(e)}onDisconnect(e){this._onDisconnect.add(e)}onConnecting(e){this._onConnecting.add(e)}onConnectionLoss(e){this._onConnectionLoss.add(e)}onConnectionReestablished(e){this._onConnectionReestablished.add(e)}onDataReceived(e){this._onDataReceived.add(e)}async _requestDevice(e){const t={optionalServices:[this.serviceUUID]};return e?t.filters=e:t.acceptAllDevices=!0,navigator.bluetooth.requestDevice(t)}async connect(e){if(this.state.type!=="disconnected"){console.warn("Already connecting or connected.");return}this.state={type:"selectingDevice"};try{this.device=await this._requestDevice(e),this.state={type:"connecting"},this._onConnecting.forEach(t=>t()),console.debug(`Connecting to device ${this.device.name}...`),this.device.addEventListener("gattserverdisconnected",this._handleDisconnection.bind(this)),await this._connectDevice()}catch(t){t.name==="NotFoundError"?(console.debug("Device selection canceled."),this.state={type:"disconnected"}):(console.error("Connection error:",t),await this._handleDisconnected())}}async _connectDevice(){if(!this.device){console.error("No device to connect to");return}try{const e=await this.device.gatt.connect();console.debug("Server connected. Awaiting service..."),this.service=await e.getPrimaryService(this.serviceUUID),console.debug("Service connected."),this.characteristic=await this.service.getCharacteristic(this.characteristicUUID),this.characteristic.addEventListener("characteristicvaluechanged",this._notification.bind(this)),await this.characteristic.startNotifications(),(this.state.type==="connecting"||this.state.type==="connectionLoss")&&(this.state.type==="connectionLoss"?this._onConnectionReestablished.forEach(t=>t()):this._onConnect.forEach(t=>t()),this.state={type:"connected"})}catch(e){console.error("Error during connection:",e),await this._handleDisconnected()}}disconnect(){if(this.state.type!=="connected"){console.warn("Cannot disconnect because not connected.");return}this.state={type:"disconnecting"},this.device&&this.device.gatt&&this.device.gatt.disconnect()}async _handleDisconnection(){console.debug("Device disconnected"),this.state.type==="connected"?(this.state={type:"connectionLoss"},this._onConnectionLoss.forEach(e=>e()),await this._reconnect()):this.state.type==="disconnecting"&&await this._handleDisconnected()}async _reconnect(){try{await new Promise(e=>setTimeout(e,1e3)),await this._connectDevice()}catch(e){console.error("Reconnection error:",e)}}async _handleDisconnected(){this.state={type:"disconnected"},this._onDisconnect.forEach(e=>e()),this.device=null,this.service=null,this.characteristic=null}get name(){return this.device?.name}get maxPayloadSize(){return this.mtu-3-this.headerSize}async sendMessage(e){if(!this.characteristic)throw _e.debug("Characteristic not available"),new Error("Characteristic not available");await this.characteristic.writeValueWithoutResponse(e)}async _notification(e){const t=e.target;_e.debug("Notification received"),_e.debug(t.value);const n=new Uint8Array(t.value.buffer);for(this.buffer=new Uint8Array([...this.buffer,...n]);this.buffer.length>=this.headerSize;){const a=this.buffer[2]<<8|this.buffer[3],i=this.headerSize+a;if(this.buffer.length>=i){const s=this.buffer.slice(0,i);_e.debug("Processing message"),_e.debug(s),this._onDataReceived.forEach(c=>c(s)),this.buffer=this.buffer.slice(i)}else break}}}const q=new kn("8d53dc1d-1db7-4cd3-868b-8a527460aa84","da2e7828-fbce-4e01-ae9e-261174997c48"),K=ce({connectionState:"disconnected",deviceName:"unknown device name"});q.onConnect(()=>{K.connectionState="connected",K.deviceName=q.name||"unknown device name"});q.onConnecting(()=>{K.connectionState="connecting"});q.onDisconnect(()=>{window.location.reload()});q.onConnectionLoss(()=>{K.connectionState="connectionLoss"});q.onConnectionReestablished(()=>{K.connectionState="connected"});var xn=k("<div></div>");function On(r,e){J(e,!1),ze();var t=xn();let n;z(a=>n=ie(t,1,"status-circle svelte-1jdrd47",null,n,a),[()=>({connected:K.connectionState==="connected","connection-loss":K.connectionState==="connectionLoss"})],ft),I(r,t),ee()}var Nn=5960464477539063e-23,Ge=4294967296,Cn=9007199254740992;function Tn(r){var e=new ArrayBuffer(256),t=new DataView(e),n,a=0;function i(f){for(var S=e.byteLength,p=a+f;S<p;)S<<=1;if(S!==e.byteLength){var d=t;e=new ArrayBuffer(S),t=new DataView(e);for(var E=a+3>>2,v=0;v<E;++v)t.setUint32(v<<2,d.getUint32(v<<2))}return n=f,t}function s(){a+=n}function c(f){s(i(8).setFloat64(a,f))}function o(f){s(i(1).setUint8(a,f))}function h(f){for(var S=i(f.length),p=0;p<f.length;++p)S.setUint8(a+p,f[p]);s()}function l(f){s(i(2).setUint16(a,f))}function _(f){s(i(4).setUint32(a,f))}function g(f){var S=f%Ge,p=(f-S)/Ge,d=i(8);d.setUint32(a,p),d.setUint32(a+4,S),s()}function w(f,S){S<24?o(f<<5|S):S<256?(o(f<<5|24),o(S)):S<65536?(o(f<<5|25),l(S)):S<4294967296?(o(f<<5|26),_(S)):(o(f<<5|27),g(S))}function u(f){var S;if(f===!1)return o(244);if(f===!0)return o(245);if(f===null)return o(246);if(f===void 0)return o(247);switch(typeof f){case"number":if(Math.floor(f)===f){if(0<=f&&f<=Cn)return w(0,f);if(-9007199254740992<=f&&f<0)return w(1,-(f+1))}return o(251),c(f);case"string":var p=[];for(S=0;S<f.length;++S){var d=f.charCodeAt(S);d<128?p.push(d):d<2048?(p.push(192|d>>6),p.push(128|d&63)):d<55296?(p.push(224|d>>12),p.push(128|d>>6&63),p.push(128|d&63)):(d=(d&1023)<<10,d|=f.charCodeAt(++S)&1023,d+=65536,p.push(240|d>>18),p.push(128|d>>12&63),p.push(128|d>>6&63),p.push(128|d&63))}return w(3,p.length),h(p);default:var E;if(Array.isArray(f))for(E=f.length,w(4,E),S=0;S<E;++S)u(f[S]);else if(f instanceof Uint8Array)w(2,f.length),h(f);else{var v=Object.keys(f);for(E=v.length,w(5,E),S=0;S<E;++S){var b=v[S];u(b),u(f[b])}}}}if(u(r),"slice"in e)return e.slice(0,a);for(var y=new ArrayBuffer(a),M=new DataView(y),m=0;m<a;++m)M.setUint8(m,t.getUint8(m));return y}function Vn(r,e,t){var n=new DataView(r),a=0;typeof e!="function"&&(e=function(p){return p}),typeof t!="function"&&(t=function(){});function i(p,d){return a+=p,d}function s(p){return i(p,new Uint8Array(r,a,p))}function c(){var p=new ArrayBuffer(4),d=new DataView(p),E=_(),v=E&32768,b=E&31744,O=E&1023;if(b===31744)b=261120;else if(b!==0)b+=114688;else if(O!==0)return(v?-1:1)*O*Nn;return d.setUint32(0,v<<16|b<<13|O<<13),d.getFloat32(0)}function o(){return i(4,n.getFloat32(a))}function h(){return i(8,n.getFloat64(a))}function l(){return i(1,n.getUint8(a))}function _(){return i(2,n.getUint16(a))}function g(){return i(4,n.getUint32(a))}function w(){return g()*Ge+g()}function u(){return n.getUint8(a)!==255?!1:(a+=1,!0)}function y(p){if(p<24)return p;if(p===24)return l();if(p===25)return _();if(p===26)return g();if(p===27)return w();if(p===31)return-1;throw"Invalid length encoding"}function M(p){var d=l();if(d===255)return-1;var E=y(d&31);if(E<0||d>>5!==p)throw"Invalid indefinite length element";return E}function m(p,d){for(var E=0;E<d;++E){var v=l();v&128&&(v<224?(v=(v&31)<<6|l()&63,d-=1):v<240?(v=(v&15)<<12|(l()&63)<<6|l()&63,d-=2):(v=(v&15)<<18|(l()&63)<<12|(l()&63)<<6|l()&63,d-=3)),v<65536?p.push(v):(v-=65536,p.push(55296|v>>10),p.push(56320|v&1023))}}function f(){var p=l(),d=p>>5,E=p&31,v,b;if(d===7)switch(E){case 25:return c();case 26:return o();case 27:return h()}if(b=y(E),b<0&&(d<2||6<d))throw"Invalid length";switch(d){case 0:return b;case 1:return-1-b;case 2:if(b<0){for(var O=[],F=0;(b=M(d))>=0;)F+=b,O.push(s(b));var Q=new Uint8Array(F),te=0;for(v=0;v<O.length;++v)Q.set(O[v],te),te+=O[v].length;return Q}return s(b);case 3:var D=[];if(b<0)for(;(b=M(d))>=0;)m(D,b);else m(D,b);return String.fromCharCode.apply(null,D);case 4:var P;if(b<0)for(P=[];!u();)P.push(f());else for(P=new Array(b),v=0;v<b;++v)P[v]=f();return P;case 5:var V={};for(v=0;v<b||b<0&&!u();++v){var C=f();V[C]=f()}return V;case 6:return e(f(),b);case 7:switch(b){case 20:return!1;case 21:return!0;case 22:return null;case 23:return;default:return t(b)}}}var S=f();if(a!==r.byteLength)throw"Remaining bytes";return S}const He={encode:Tn,decode:Vn};let me=new H("mcumgr",H.LEVEL_INFO);const fe={EOK:0,EUNKNOWN:1,ENOMEM:2,EINVAL:3,ETIMEOUT:4,ENOENT:5,EBADSTATE:6,EMSGSIZE:7,ENOTSUP:8,ECORRUPT:9,EBUSY:10,EACCESSDENIED:11,UNSUPPORTED_TOO_OLD:12,UNSUPPORTED_TOO_NEW:13,EPERUSER:256},ne={READ:0,READ_RSP:1,WRITE:2,WRITE_RSP:3};class Fn{constructor(e){this.bluetoothManager=e,this.smpSequenceNumber=0,this.responseResolvers={},this.SMP_HEADER_SIZE=8,this.SMP_HEADER_OP_IDX=0,this.SMP_HEADER_FLAGS_IDX=1,this.SMP_HEADER_LEN_HI_IDX=2,this.SMP_HEADER_LEN_LO_IDX=3,this.SMP_HEADER_GROUP_HI_IDX=4,this.SMP_HEADER_GROUP_LO_IDX=5,this.SMP_HEADER_SEQ_IDX=6,this.SMP_HEADER_ID_IDX=7,this.bluetoothManager.onDataReceived(this._processMessage.bind(this))}get maxPayloadSize(){return this.bluetoothManager.maxPayloadSize}_buildSMPMessage(e,t,n,a,i,s=new Uint8Array([])){const c=s.length,o=new Uint8Array(this.SMP_HEADER_SIZE);return o[this.SMP_HEADER_OP_IDX]=e,o[this.SMP_HEADER_FLAGS_IDX]=t,o[this.SMP_HEADER_LEN_HI_IDX]=c>>8&255,o[this.SMP_HEADER_LEN_LO_IDX]=c&255,o[this.SMP_HEADER_GROUP_HI_IDX]=n>>8&255,o[this.SMP_HEADER_GROUP_LO_IDX]=n&255,o[this.SMP_HEADER_SEQ_IDX]=a,o[this.SMP_HEADER_ID_IDX]=i,new Uint8Array([...o,...s])}async sendMessage(e,t,n,a=new Uint8Array([])){const i=this.smpSequenceNumber;this.smpSequenceNumber=(this.smpSequenceNumber+1)%256;const c=this._buildSMPMessage(e,0,t,i,n,a);return new Promise(async(o,h)=>{this.responseResolvers[i]={resolve:o,reject:h};try{await this.bluetoothManager.sendMessage(c)}catch(l){me.debug(`Failed to send bluetooth characteristic message: ${l}`),delete this.responseResolvers[i],h(l)}})}async _processMessage(e){const[t,n,a,i,s,c,o,h]=e.slice(0,this.SMP_HEADER_SIZE),l=e.slice(this.SMP_HEADER_SIZE);me.debug("payload"),me.debug(l);let _;try{_=He.decode(l.buffer)}catch(w){me.error("Error decoding CBOR:",w)}const g=this.responseResolvers[o];g?(g.resolve(_),delete this.responseResolvers[o]):me.warning(`No resolver found for sequence number ${o}`)}}const bt=new Fn(q);let j=new H("img_mgr",H.LEVEL_WARNING);const $e=(r,e)=>{if(e.major>r.major)return!0;if(e.major===r.major){if(e.minor>r.minor)return!0;if(e.minor===r.minor&&e.revision>r.revision)return!0}return!1};class Bn{constructor(e){this.IMAGE_GROUP_ID=1,this.state=0,this.mcumgr=e}async uploadImage(e,t){if(this.state===1)return j.error("Upload already in progress"),!1;this.state=1;let n=0,a=e.byteLength;try{let i=new Uint8Array(await Ln(e));const s=this.mcumgr.maxPayloadSize;for(;n<a;){let c={off:n,data:new Uint8Array([])};n===0&&(j.debug("Starting image upload"),c.len=a,c.sha=i);let o=He.encode(c);const h=o.byteLength;j.debug(`maxPayloadSize: ${s}, initialPayloadLength: ${h}`);const l=s-h-20;if(l<=0)return j.error("MTU too small to send data"),this.state=0,!1;const _=Math.min(n+l,a),g=new Uint8Array(e.slice(n,_));c.data=g,o=He.encode(c),j.debug(`total encoded size: ${o.byteLength}`),o.byteLength>s&&j.warning(`Payload too large: ${o.byteLength} > ${s}`);const w=await this.mcumgr.sendMessage(ne.WRITE,this.IMAGE_GROUP_ID,1,new Uint8Array(o));if(w.rc!==void 0&&w.rc!==fe.EOK)return this.state=0,!1;n=w.off,t?.(Math.floor(n/a*100))}return this.state=0,!0}catch(i){return j.error("Error during image upload:",i),this.state=0,!1}}async getFirmwareVersion(){j.debug("Getting firmware version..."),j.debug(`Sending message: op=${ne.READ}, group=${this.IMAGE_GROUP_ID}, id=0`);const e=await this.mcumgr.sendMessage(ne.READ,this.IMAGE_GROUP_ID,0);if(j.debug("Received response:",e),e.images===void 0||e.images.length===0)throw j.error("No image state found in response"),new Error("No image state found");j.debug(`Found ${e.images.length} images in response`);const t=e.images.find(i=>i.active);if(j.debug("Active image:",t),!t)throw j.error("No active image found - device may not use Image Manager"),new Error("Device does not use Image Manager");const n=t.version.split(".").map(Number);j.debug(`Parsed version numbers: major=${n[0]}, minor=${n[1]}, revision=${n[2]}`);const a={versionString:t.version,major:n[0],minor:n[1],revision:n[2]};return j.debug("Returning firmware version:",a),a}}function Gn(r){const e=r.split(`
`),t={release:null,dev:null,versions:[]};let n=null,a=!1;return e.forEach(i=>{if(i=i.trim(),i.startsWith("#")){const s=i.match(/# (\d+)\.(\d+)\.(\d+)(?:\[(.*?)\])?\s*(.*?)\s*((?:-\w+\s*)*)$/);if(s){const c=parseInt(s[1],10),o=parseInt(s[2],10),h=parseInt(s[3],10),l={versionString:`${c}.${o}.${h}`,major:c,minor:o,revision:h},_=s[4]?s[4].trim():null,g=s[5].trim(),u=s[6].trim().split(/\s+/).filter(Boolean),y=u.includes("-obsolete"),M=u.includes("-dev");y||((!t.dev||$e(t.dev,l))&&(t.dev=l),M||(!t.release||$e(t.release,l))&&(t.release=l)),a=h===0,n={version:l,isObsolete:y,isDev:M,highlight:g||null,date:_,summary:null,changes:[]},t.versions.push(n)}}else if(i.startsWith("-")){const s=i.substring(1).trim();n&&(n.changes.push(s),a=!1)}else i!==""&&n&&a&&n.version.revision===0&&(n.summary?n.summary+=`
`:n.summary="",n.summary+=i)}),t}const je=new Bn(bt),$=ce({firmwareVersion:null,changelog:null});q.onConnect(()=>{yt(),Et()});q.onConnectionReestablished(()=>{yt(),Et()});q.onDisconnect(()=>{$.firmwareVersion=null});q.onConnectionLoss(()=>{$.firmwareVersion=null});const Et=async()=>{const t=await(await fetch("/firmware/MONKEY/changelog.md")).text(),n=Gn(t);console.log(n),$.changelog=n},yt=async()=>{const r=await je.getFirmwareVersion();console.log("Firmware version:",r.versionString),$.firmwareVersion=r};var Hn=k("<b> </b>"),$n=k('<span style="color: #f39c21;">BETA</span>'),jn=k(" <br>",1),zn=k('<div class="changelog-item svelte-17jyhkt"><p class="svelte-17jyhkt"><span class="changelog-header"> <!> <!></span> <span><i> </i></span></p> <!></div>'),qn=k('<div id="changelog" class="svelte-17jyhkt"><h3>Changelog</h3> <!></div>');function Wn(r,e){J(e,!0);const t=ge(()=>$.changelog);var n=qn(),a=x(A(n),2);Be(a,17,()=>R(t)?.versions,Fe,(i,s)=>{var c=ut(),o=le(c);{var h=l=>{var _=zn(),g=A(_),w=A(g),u=A(w),y=x(u);{var M=v=>{var b=Hn(),O=A(b,!0);U(b),z(()=>X(O,R(s).highlight)),I(v,b)};N(y,v=>{R(s).highlight&&v(M)})}var m=x(y,2);{var f=v=>{var b=$n();I(v,b)};N(m,v=>{R(s).isDev&&v(f)})}U(w);var S=x(w,2),p=A(S),d=A(p,!0);U(p),U(S),U(g);var E=x(g,2);Be(E,17,()=>R(s).changes,Fe,(v,b)=>{Y();var O=jn(),F=le(O);Y(),z(()=>X(F,`- ${R(b)??""}`)),I(v,O)}),U(_),z(()=>{X(u,`${R(s).version.versionString??""} `),X(d,R(s).date??"")}),I(l,_)};N(o,l=>{!R(s).isObsolete&&(!R(s).isDev||e.beta)&&l(h)})}I(i,c)}),U(n),I(r,n),ee()}var Xn=k('<div class="toggle-container svelte-iljyih"><label class="switch svelte-iljyih"><input type="checkbox" class="svelte-iljyih"> <span class="slider svelte-iljyih"></span></label></div>');function Kn(r,e){J(e,!0);let t=oe(ce(e.init));Me(()=>{e.onChange?.(R(t))});var n=Xn(),a=A(n),i=A(a);bn(i),Y(2),U(a),U(n),An(i,()=>R(t),s=>G(t,s)),I(r,n),ee()}var Yn=k('<div class="spinner svelte-mopcv7"></div>'),Zn=k('<div class="checkmark svelte-mopcv7">✓</div>'),Qn=k('<div class="spinner svelte-mopcv7"></div>'),Jn=k('<div class="checkmark svelte-mopcv7">✓</div>'),er=k("(<!>)",1),tr=k('<div class="spinner svelte-mopcv7"></div>'),nr=k('<div class="checkmark svelte-mopcv7">✓</div>'),rr=k('<div class="spinner svelte-mopcv7"></div>'),ar=k('<div class="checkmark svelte-mopcv7">✓</div>'),sr=k('<div class="checkmark svelte-mopcv7">✓</div>'),ir=k('<div class="update-stages svelte-mopcv7"><div><!> fetching new firmware</div> <div><!> uploading firmware <!></div> <div><!> applying update (waiting on device)</div> <div><!> verifying update</div> <div><!> done!</div></div>');function or(r,e){J(e,!0);var t=ir(),n=A(t);let a;var i=A(n);{var s=D=>{var P=Yn();I(D,P)},c=(D,P)=>{{var V=C=>{var B=Zn();I(C,B)};N(D,C=>{["uploading","applying","verifying","done"].includes(e.stage)&&C(V)},P)}};N(i,D=>{e.stage==="fetching"?D(s):D(c,!1)})}Y(),U(n);var o=x(n,2);let h;var l=A(o);{var _=D=>{var P=Qn();I(D,P)},g=(D,P)=>{{var V=C=>{var B=Jn();I(C,B)};N(D,C=>{["applying","verifying","done"].includes(e.stage)&&C(V)},P)}};N(l,D=>{e.stage==="uploading"?D(_):D(g,!1)})}var w=x(l,2);{var u=D=>{var P=er(),V=x(le(P));{var C=Z=>{var ae=Ee("starting");I(Z,ae)},B=Z=>{var ae=Ee();z(()=>X(ae,`${e.uploadProgress??""}%`)),I(Z,ae)};N(V,Z=>{e.uploadProgress===0?Z(C):Z(B,!1)})}Y(),I(D,P)};N(w,D=>{e.stage==="uploading"&&D(u)})}U(o);var y=x(o,2);let M;var m=A(y);{var f=D=>{var P=tr();I(D,P)},S=(D,P)=>{{var V=C=>{var B=nr();I(C,B)};N(D,C=>{["verifying","done"].includes(e.stage)&&C(V)},P)}};N(m,D=>{e.stage==="applying"?D(f):D(S,!1)})}Y(),U(y);var p=x(y,2);let d;var E=A(p);{var v=D=>{var P=rr();I(D,P)},b=(D,P)=>{{var V=C=>{var B=ar();I(C,B)};N(D,C=>{["done"].includes(e.stage)&&C(V)},P)}};N(E,D=>{e.stage==="verifying"?D(v):D(b,!1)})}Y(),U(p);var O=x(p,2);let F;var Q=A(O);{var te=D=>{var P=sr();I(D,P)};N(Q,D=>{e.stage==="done"&&D(te)})}Y(),U(O),U(t),z((D,P,V,C,B)=>{a=ie(n,1,"stage svelte-mopcv7",null,a,D),h=ie(o,1,"stage svelte-mopcv7",null,h,P),M=ie(y,1,"stage svelte-mopcv7",null,M,V),d=ie(p,1,"stage svelte-mopcv7",null,d,C),F=ie(O,1,"stage svelte-mopcv7",null,F,B)},[()=>({active:e.stage==="fetching"}),()=>({active:e.stage==="uploading"}),()=>({active:e.stage==="applying"}),()=>({active:e.stage==="verifying"}),()=>({active:e.stage==="done"})]),I(r,t),ee()}async function rt(r,e,t,n){try{G(e,"fetching");const a=R(t)?$.changelog.dev.versionString:$.changelog.release.versionString;G(e,"uploading");const i=await fetch(`/firmware/MONKEY/app_update_${a}.bin`).then(o=>o.arrayBuffer());if(!await je.uploadImage(i,o=>{G(n,ce(o))}))throw"failed to upload image";G(e,"applying"),await new Promise(o=>{q.onConnectionReestablished(()=>{o(null)})}),G(e,"verifying");const c=await je.getFirmwareVersion();if(c.versionString!==a)throw new Error(`Update failed: Device firmware version is ${c.versionString} but expected ${a}`);G(e,"done"),await new Promise(o=>setTimeout(o,2e3)),G(e,"idle"),G(n,0)}catch(a){console.log(a),G(e,"failed"),await new Promise(i=>setTimeout(i,2e3)),G(e,"idle")}}var cr=k("<h1>Failed to upload firmware</h1> <span>Please refresh the page and reboot the device and try again.</span>",1),lr=k('<h1>Your device is up to date!</h1> <span class="tagline">Your device is running the newest firmware. To get notifications when new firmware versions are available, add your email at the bottom of this page.</span>',1),fr=k('<h1>New update available</h1> <span class="tagline">Your device is ready to be updated</span> <span> </span> <button class="update-buttons" style="background-color: #B7FF9E;">Start update</button>',1),dr=k('<h1>Downgrade available</h1> <span class="tagline">Your device running a beta firmware. Downgrade to stable release</span> <span> </span> <button class="update-buttons" style="background-color: #fffb9e;">Start downgrade</button>',1),ur=k("<h1>Waiting on device..</h1>"),vr=k('<div class="content svelte-pnszsd"><div class="top-bar svelte-pnszsd"><span>Beta</span><!></div> <div class="main-content svelte-pnszsd"><div class="console svelte-pnszsd"><!></div> <hr> <!></div></div>');function hr(r,e){J(e,!0);let t=oe(!1),n=oe("idle"),a=oe(0);const i=m=>G(t,ce(m)),s=ge(()=>R(t)?$.changelog?.dev.versionString:$.changelog?.release.versionString);let c=ge(()=>{if($.firmwareVersion==null||$.changelog==null)return null;const m=$.firmwareVersion,f=R(t)?$.changelog.dev:$.changelog.release;return f.versionString==m.versionString?"up-to-date":$e(m,f)?"upgrade":"downgrade"});var o=vr(),h=A(o),l=x(A(h));Kn(l,{init:!1,onChange:i}),U(h);var _=x(h,2),g=A(_),w=A(g);{var u=m=>{or(m,{get stage(){return R(n)},get uploadProgress(){return R(a)}})},y=(m,f)=>{{var S=d=>{var E=cr();Y(2),I(d,E)},p=(d,E)=>{{var v=O=>{var F=lr();Y(2),I(O,F)},b=(O,F)=>{{var Q=D=>{var P=fr(),V=x(le(P),4),C=A(V);U(V);var B=x(V,2);B.__click=[rt,n,t,a],z(()=>X(C,`v${$.firmwareVersion.versionString??""} ➔ v${R(s)??""}`)),I(D,P)},te=(D,P)=>{{var V=B=>{var Z=dr(),ae=x(le(Z),4),It=A(ae);U(ae);var At=x(ae,2);At.__click=[rt,n,t,a],z(()=>X(It,`v${$.firmwareVersion.versionString??""} ➔ v${R(s)??""}`)),I(B,Z)},C=B=>{var Z=ur();I(B,Z)};N(D,B=>{R(c)==="downgrade"?B(V):B(C,!1)},P)}};N(O,D=>{R(c)==="upgrade"?D(Q):D(te,!1)},F)}};N(d,O=>{R(c)==="up-to-date"?O(v):O(b,!1)},E)}};N(m,d=>{R(n)==="failed"?d(S):d(p,!1)},f)}};N(w,m=>{R(n)!=="idle"&&R(n)!=="failed"?m(u):m(y,!1)})}U(g);var M=x(g,4);Wn(M,{get beta(){return R(t)}}),U(_),U(o),I(r,o),ee()}Oe(["click"]);const ue=10,ye=15;class he{constructor(){this.data=[]}push8(e){if(e<0||e>255)throw new RangeError(`Value ${e} is out of range for an 8-bit unsigned integer`);this.data.push(e&255)}push16(e){if(e<0||e>65535)throw new RangeError(`Value ${e} is out of range for a 16-bit unsigned integer`);this.data.push(e&255),this.data.push(e>>8&255)}push32(e){if(e<0||e>4294967295)throw new RangeError(`Value ${e} is out of range for a 32-bit unsigned integer`);this.data.push(e&255),this.data.push(e>>8&255),this.data.push(e>>16&255),this.data.push(e>>24&255)}pop8(){if(this.data.length<1)throw new RangeError("Attempted to pop from an empty array");return this.data.shift()}pop16(){if(this.data.length<2)throw new RangeError("Not enough data to pop 16 bits");const e=this.data.shift(),t=this.data.shift();return e|t<<8}pop32(){if(this.data.length<4)throw new RangeError("Not enough data to pop 32 bits");const e=this.data.shift(),t=this.data.shift(),n=this.data.shift(),a=this.data.shift();return(e|t<<8|n<<16|a<<24)>>>0}add(e){this.data.push(...e.data)}static from(e){const t=new he;return t.data=Array.from(e),t}}function gr(r){let e=new he;e.push32(r.reserved0),e.push32(r.reserved1),e.push32(r.reserved2),e.push32(r.reserved3);for(let a=0;a<ue;a++)e.push16(r.pages[a].id);let t=new he,n=new he;for(let a=0;a<ue;a++){let i=r.pages[a];for(let s=0;s<ye;s++){let c=i.loops[s];if(c==null){t.push16(65535);continue}t.push16(n.data.length),n.push8(c.length_beats),n.push8(c.events.length);for(const o of c.events){const[h,l]=o;n.push8(l.note&127);const _=l.state<<7|l.velocity&127;n.push8(_),n.push16(h)}}}return e.add(t),e.add(n),Uint8Array.from(e.data)}function pr(r){let e=he.from(r),t={reserved0:e.pop32(),reserved1:e.pop32(),reserved2:e.pop32(),reserved3:e.pop32(),pages:[]};for(let a=0;a<ue;a++)t.pages.push({id:e.pop16(),loops:[]});let n=[];for(let a=0;a<ue*ye;a++)n.push(e.pop16()!==65535);for(let a=0;a<ue;a++){let i=t.pages[a];for(let s=0;s<ye;s++){if(n[a*ue+s]==!1){i.loops.push(null);continue}let c={length_beats:e.pop8(),events:[]},o=e.pop8();for(let h=0;h<o;h++){let l=e.pop8()&127,_=e.pop8(),g=_>>7&1,w=_&127,u=e.pop16();c.events.push([u,{note:l,state:g,velocity:w}])}i.loops.push(c)}}return t}async function _r(r){if(r?.length>10)return console.log("pack length too long"),null;console.log("received IDs:"),console.log(r);const e=Array(10).fill(-1);r.length>0&&r.forEach((s,c)=>e[c]=s);const t=e.pop();e.unshift(t),console.log("created IDs:"),console.log(e);const n="MONKEY",a=[];for(const s of e)if(s===-1)a.push({id:65535,loops:new Array(ye).fill(null)});else try{const o=await(await fetch(`/samples/${n}/DRM/${s}.json`)).json();a.push(o)}catch(c){console.error(`Failed to fetch page for ID ${s}:`,c),a.push({id:65535,loops:new Array(ye).fill(null)})}return{reserved0:4294967295,reserved1:4294967295,reserved2:4294967295,reserved3:4294967295,pages:a}}let L=new H("smpl_mgr",H.LEVEL_INFO);class mr{constructor(e){this.GROUP_ID=100,this.state=0,this.mcumgr=e}async isSet(){L.debug("Checking if any samples are set");const e=await this.mcumgr.sendMessage(ne.READ,this.GROUP_ID,2);return e.rc!==void 0&&e.rc!==fe.EOK?(L.error(`Error response received, rc: ${e.rc}`),Promise.reject(e.rc)):e.set}async getIDs(){L.debug("Getting sample ID");const e=await this.mcumgr.sendMessage(ne.READ,this.GROUP_ID,0);if(e.rc!==void 0&&e.rc!==fe.EOK)return L.error(`Error response received, rc: ${e.rc}`),Promise.reject(e.rc);const t=e;return L.debug(`Received sample IDs: ${t.ids}`),t.ids}async getSpaceUsed(){L.debug("Getting space used");const e=await this.mcumgr.sendMessage(ne.READ,this.GROUP_ID,3);if(e.rc!==void 0&&e.rc!==fe.EOK)return L.error(`Error response received, rc: ${e.rc}`),Promise.reject(e.rc);const t=e;return L.debug(`Received storage, total: ${t.tot}, used: ${t.usd}`),t}async uploadSamples(e,t){if(L.debug("Starting sample upload process"),this.state!==0)return L.error("Cant start upload when not in idle state"),Promise.reject("Cant start upload when not in idle state");this.state=1;const n=this.mcumgr.maxPayloadSize,a=gr(e),i=a.byteLength;let s=0;for(;this.state===1&&s<i;){L.debug(`Current offset: ${s}, Total length: ${i}`);let c={off:s,data:new Uint8Array([]),len:i},o=this._payloadUploadEncode(c);L.debug(`Initial payload size (without data): ${o.byteLength} bytes`);const h=n-o.byteLength-20;if(L.debug(`Max data size for this chunk: ${h} bytes`),h<=0)return L.error("MTU too small to send data"),this.state=0,!1;const l=Math.min(s+h,i),_=new Uint8Array(a.slice(s,l));if(L.debug(`Data chunk length: ${_.byteLength} bytes (from offset ${s} to ${l})`),c.data=_,o=this._payloadUploadEncode(c),L.debug(`Payload size after adding data: ${o.byteLength} bytes`),o.byteLength>n)return L.warning(`Payload too large: ${o.byteLength} > ${n}`),this.state=0,!1;try{L.debug("Sending payload to mcumgr");const g=await this.mcumgr.sendMessage(ne.WRITE,this.GROUP_ID,1,o);if(L.debug("Received response from mcumgr"),g.rc!==void 0&&g.rc!==fe.EOK)return L.error(`Error response received, rc: ${g.rc}`),this.state=0,!1;const w=g;L.debug(`Response success, new offset: ${w.off}`),s=w.off;const u=Math.floor(s/i*100);if(L.debug(`Upload progress: ${u}%`),t?.(u),s>=i){L.debug("Upload complete"),this.state=0;break}}catch(g){return L.error("Error during upload:",g),this.state=0,!1}}return L.debug("Successfully uploaded samples"),!0}async downloadSamples(e){if(L.debug("Starting sample download process"),this.state!==0)return L.error("Cant start download when not in idle state"),Promise.reject("Cant start download when not in idle state");this.state=2;let t=new Uint8Array([]),n=0,a=0,i={off:n},s=this._payloadDownloadEncode(i);try{const c=await this.mcumgr.sendMessage(ne.READ,this.GROUP_ID,1,s);if(c.rc!==void 0&&c.rc!==fe.EOK)return L.error(`Error response received, rc: ${c.rc}`),this.state=0,null;const o=c;if(L.debug(`Received first chunk, offset: ${o.off}, data length: ${o.data.byteLength}`),o.len===void 0)return L.error("Length not received in first chunk"),this.state=0,null;if(o.off!==n)return L.error("Invalid offset received in first chunk"),this.state=0,null;t=o.data,n=o.off+o.data.byteLength,a=o.len,e?.(Math.floor(n/a*100))}catch(c){return L.error("Error during download:",c),this.state=0,null}for(;n<a;){L.debug(`Current offset: ${n}, Total length: ${a}`),i={off:n},s=this._payloadDownloadEncode(i);try{const c=await this.mcumgr.sendMessage(ne.READ,this.GROUP_ID,1,s);if(c.rc!==void 0&&c.rc!==fe.EOK)return L.error(`Error response received, rc: ${c.rc}`),this.state=0,null;const o=c;if(L.debug(`Received chunk, offset: ${o.off}, data length: ${o.data.byteLength}`),t=new Uint8Array([...t,...o.data]),n=o.off+o.data.byteLength,e?.(Math.floor(n/a*100)),n>=a){L.debug("Download complete"),this.state=0;break}}catch(c){return L.error("Error during download:",c),this.state=0,null}}return L.debug("Successfully downloaded samples"),Promise.resolve(pr(t))}_payloadUploadEncode(e){L.debug(`Encoding payload: len=${e.len}, off=${e.off}, data=${e.data.byteLength} bytes`);const t=e.len&255,n=e.len>>8&255,a=e.len>>16&255,i=e.len>>24&255,s=e.off&255,c=e.off>>8&255,o=e.off>>16&255,h=e.off>>24&255;return new Uint8Array([t,n,a,i,s,c,o,h,...e.data])}_payloadDownloadEncode(e){L.debug(`Encoding payload: off=${e.off}`);const t=e.off&255,n=e.off>>8&255,a=e.off>>16&255,i=e.off>>24&255;return new Uint8Array([t,n,a,i])}}const ke=new mr(bt),T=ce({isSupported:!1,isset:null,storageTotal:null,storageUsed:null,IDs:null,names:null,uploadPercentage:null});q.onConnect(()=>{T.isSupported=!1,(async()=>await Dt()&&await qe())(),br()});q.onConnectionReestablished(()=>{T.isSupported=!1,(async()=>await Dt()&&await qe())()});async function St(){await wr([2,3,1,57005])}async function wr(r){const e=await _r(r);T.uploadPercentage=0,await ke.uploadSamples(e,t=>T.uploadPercentage=t),T.uploadPercentage=null,await qe()}async function qe(){try{const r=await ke.getIDs();T.IDs=r;const e=await ke.getSpaceUsed();T.storageUsed=e.usd,T.storageTotal=e.tot}catch(r){console.log(r)}}async function Dt(){console.log("checking sample manager state");try{return T.isset=await ke.isSet(),T.isSupported=!0,T.isset||(console.log("no samples are set, setting default"),await St(),T.isset=!0),!0}catch(r){console.log(r)}return!1}async function br(){const t=await(await fetch("/samples/MONKEY/DRM/samples.json")).json();T.names=t}var Er=k("<tr><td></td><td> </td></tr>"),yr=k("<tr><td>0</td><td> </td></tr>"),Sr=k('<table class="svelte-80b3kr"><tbody><tr><th>Preset number</th><th>Pack name</th></tr><!><!></tbody></table>'),Dr=k('<div class="content svelte-80b3kr"><div class="main-content svelte-80b3kr"><div class="console svelte-80b3kr"><h1>Sample Manager</h1> <span>The presets in <b>DRM</b> are each a pack of drum loop samples. Here you can see which are currently loaded on your device.</span></div> <button><!></button> <div> </div> <!> <p>🚧 You will soon be able to upload other drum loops 🚧</p> <br> <br> <br> <br> <p><i>This page is <a target="_blank" href="https://github.com/ReinBentdal/wavy-website">open-source</a></i>. Contributions are very welcome.</p></div></div>');function Rr(r,e){J(e,!0);const t=ge(()=>T.storageUsed!=null&&T.storageTotal!=null?(T.storageUsed/T.storageTotal*100).toFixed(1):"??.?"),n=ge(()=>T.IDs?.map(u=>[u,T?.names[u.toString()]??"no name"])??null);var a=Dr(),i=A(a),s=x(A(i),2);s.__click=function(...u){St?.apply(this,u)};var c=A(s);{var o=u=>{var y=Ee();z(()=>X(y,`Uploading... ${T.uploadPercentage??""}%`)),I(u,y)},h=u=>{var y=Ee("Reupload default samples");I(u,y)};N(c,u=>{T.uploadPercentage!=null?u(o):u(h,!1)})}U(s);var l=x(s,2),_=A(l);U(l);var g=x(l,2);{var w=u=>{var y=Sr(),M=A(y),m=x(A(M));Be(m,17,()=>R(n).slice(1),Fe,(p,d,E)=>{var v=Er(),b=A(v);b.textContent=E+1;var O=x(b),F=A(O,!0);U(O),U(v),z(()=>X(F,R(d)[0]==65535?"-":R(d)[1])),I(p,v)});var f=x(m);{var S=p=>{var d=yr(),E=x(A(d)),v=A(E,!0);U(E),U(d),z(()=>X(v,R(n)[0][0]==65535?"-":R(n)[0][1])),I(p,d)};N(f,p=>{R(n).length>0&&p(S)})}U(M),U(y),I(u,y)};N(g,u=>{R(n)!=null&&u(w)})}Y(12),U(i),U(a),z(()=>{s.disabled=T.uploadPercentage!=null,X(_,`Storage used: ${R(t)??""}%`)}),I(r,a),ee()}Oe(["click"]);const Ir=r=>r;function at(r,{delay:e=0,duration:t=400,easing:n=Ir}={}){const a=+getComputedStyle(r).opacity;return{delay:e,duration:t,easing:n,css:i=>`opacity: ${i*a}`}}function Ar(r,e){J(e,!1),ze();var t=ut(),n=le(t);N(n,a=>{}),I(r,t),ee()}var Ur=()=>q.disconnect(),Mr=r=>T.isSupported==!1&&r.preventDefault(),Pr=k("<div><!></div>"),Lr=k("<div><!></div>"),kr=k('<div><nav class="svelte-33jtfm"><div class="svelte-33jtfm"><button><i class="bi-bluetooth-disconnect"></i> disconnect</button> <span> </span> <!> <span> </span> <!></div> <div class="svelte-33jtfm"><a href="#device-update">Device Update</a> <a href="#sample-manager">Sample Manager</a></div></nav> <!></div>');function Rt(r,e){J(e,!0);const t={DeviceUpdate:"DeviceUpdate",SampleManager:"SampleManager"};let n=oe(ce(t.DeviceUpdate));function a(){const E=window.location.hash.slice(1);G(n,ce(E==="sample-manager"?t.SampleManager:t.DeviceUpdate))}wt(()=>{window.addEventListener("hashchange",a),a()});var i=kr(),s=A(i),c=A(s),o=A(c);o.__click=[Ur];var h=x(o,2),l=A(h,!0);U(h);var _=x(h,2);On(_,{});var g=x(_,2),w=A(g);U(g);var u=x(g,2);Ar(u,{}),U(c);var y=x(c,2),M=A(y),m=x(M,2);let f;m.__click=[Mr],U(y),U(s);var S=x(s,2);{var p=E=>{var v=Pr(),b=A(v);hr(b,{}),U(v),tt(1,v,()=>at,()=>({duration:200})),I(E,v)},d=(E,v)=>{{var b=O=>{var F=Lr(),Q=A(F);Rr(Q,{}),U(F),tt(1,F,()=>at,()=>({duration:200})),I(O,F)};N(E,O=>{R(n)===t.SampleManager&&O(b)},v)}};N(S,E=>{R(n)===t.DeviceUpdate?E(p):E(d,!1)})}U(i),z(E=>{X(l,K.deviceName),X(w,`v${$?.firmwareVersion?.versionString??"?.?.?"}`),ie(M,1,Ye(R(n)===t.DeviceUpdate?"active":""),"svelte-33jtfm"),f=ie(m,1,Ye(R(n)===t.SampleManager?"active":""),"svelte-33jtfm",f,E),ve(m,"title",T.isSupported?"":"firmware version 1.2.0 or greater is required")},[()=>({disabled:!T.isSupported})]),I(r,i),ee()}Oe(["click"]);const xr={monkeyConnect:"/resources/guides/monkey-connect"};async function Or(r,e){await q.connect(e)}var Nr=k('<div class="spinner">loading</div>'),Cr=k('<p class="note" style="text-align: center;">It looks like your browser is not supported :/<br> <span> </span></p>'),Tr=k('<i class="bi-bluetooth"></i> Click to connect',1),Vr=k('<button class="btn btn-primary svelte-1sjmqc7"><img alt="bluetooth logo" height="15px"> <!></button> <p class="note" style="max-width: 400px; text-align: center;">If you are having problems finding your device, make sure it is not already connected to anything else. <a>read more</a></p>',1),Fr=k('<img alt="Monkey programmer" id="programmer-monkey"> <div style="display:flex; align-items: center; flex-direction: column;"><h1>device utility</h1> <span class="tagline">update and configure your device directly in the browser!</span></div> <!>',1),Br=k('<div class="main-content"><!></div>');function Gr(r,e){J(e,!0);const n=[{namePrefix:"WAVY MONKEY",services:["03B80E5A-EDE8-4B33-A751-6CE34EC4C700".toLowerCase()]}];let a=oe(!1),i=oe(!0),s=oe("");wt(async()=>{if(!navigator.bluetooth){G(i,!1),G(a,!1),G(s,"Web Bluetooth is not available in your browser.");return}try{await navigator.bluetooth.getAvailability(),G(a,!0)}catch{G(s,"Could not detect Bluetooth adapter."),G(a,!1)}finally{G(i,!1)}});var c=Br(),o=A(c);{var h=_=>{var g=Fr(),w=le(g),u=x(w,4);{var y=m=>{var f=Nr();I(m,f)},M=(m,f)=>{{var S=d=>{var E=Cr(),v=x(A(E),3),b=A(v,!0);U(v),U(E),z(()=>X(b,R(s))),I(d,E)},p=d=>{var E=Vr(),v=le(E);v.__click=[Or,n];var b=A(v),O=x(b,2);{var F=P=>{var V=Ee("Connecting...");I(P,V)},Q=P=>{var V=Tr();Y(),I(P,V)};N(O,P=>{K.connectionState==="connecting"?P(F):P(Q,!1)})}U(v);var te=x(v,2),D=x(A(te));U(te),z(()=>{v.disabled=K.connectionState==="connecting",ve(b,"src",Pn.src),ve(D,"href",xr.monkeyConnect)}),I(d,E)};N(m,d=>{R(a)?d(p,!1):d(S)},f)}};N(u,m=>{R(i)?m(y):m(M,!1)})}z(()=>ve(w,"src",Mn.src)),I(_,g)},l=_=>{Rt(_,{})};N(o,_=>{K.connectionState!=="connected"?_(h):_(l,!1)})}U(c),I(r,c),ee()}Oe(["click"]);var Hr=k('<section style="flex-grow: 2; display: flex; flex-direction: column; align-items: center;"><!></section>');function zr(r,e){J(e,!1),ze();var t=Hr(),n=A(t);{var a=s=>{Gr(s,{})},i=s=>{Rt(s,{})};N(n,s=>{K.connectionState=="disconnected"||K.connectionState=="connecting"?s(a):s(i,!1)})}U(t),I(r,t),ee()}export{zr as default};
