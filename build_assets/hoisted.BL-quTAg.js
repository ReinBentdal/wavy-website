var X=5.960464477539063e-8,$=4294967296,K=9007199254740992;function Z(e){var t,n=new ArrayBuffer(256),r=new DataView(n),i=0;function s(e){for(var s=n.byteLength,a=i+e;s<a;)s<<=1;if(s!==n.byteLength){var c=r;n=new ArrayBuffer(s),r=new DataView(n);for(var o=i+3>>2,l=0;l<o;++l)r.setUint32(l<<2,c.getUint32(l<<2))}return t=e,r}function a(){i+=t}function c(e){a(s(1).setUint8(i,e))}function o(e){for(var t=s(e.length),n=0;n<e.length;++n)t.setUint8(i+n,e[n]);a()}function l(e,t){t<24?c(e<<5|t):t<256?(c(e<<5|24),c(t)):t<65536?(c(e<<5|25),function(e){a(s(2).setUint16(i,e))}(t)):t<4294967296?(c(e<<5|26),function(e){a(s(4).setUint32(i,e))}(t)):(c(e<<5|27),function(e){var t=e%$,n=(e-t)/$,r=s(8);r.setUint32(i,n),r.setUint32(i+4,t),a()}(t))}if(function e(t){var n;if(!1===t)return c(244);if(!0===t)return c(245);if(null===t)return c(246);if(void 0===t)return c(247);switch(typeof t){case"number":if(Math.floor(t)===t){if(0<=t&&t<=K)return l(0,t);if(-K<=t&&t<0)return l(1,-(t+1))}return c(251),function(e){a(s(8).setFloat64(i,e))}(t);case"string":var r=[];for(n=0;n<t.length;++n){var h=t.charCodeAt(n);h<128?r.push(h):h<2048?(r.push(192|h>>6),r.push(128|63&h)):h<55296?(r.push(224|h>>12),r.push(128|h>>6&63),r.push(128|63&h)):(h=(1023&h)<<10,h|=1023&t.charCodeAt(++n),h+=65536,r.push(240|h>>18),r.push(128|h>>12&63),r.push(128|h>>6&63),r.push(128|63&h))}return l(3,r.length),o(r);default:var u;if(Array.isArray(t))for(l(4,u=t.length),n=0;n<u;++n)e(t[n]);else if(t instanceof Uint8Array)l(2,t.length),o(t);else{var d=Object.keys(t);for(l(5,u=d.length),n=0;n<u;++n){var g=d[n];e(g),e(t[g])}}}}(e),"slice"in n)return n.slice(0,i);for(var h=new ArrayBuffer(i),u=new DataView(h),d=0;d<i;++d)u.setUint8(d,r.getUint8(d));return h}function ee(e,t,n){var r=new DataView(e),i=0;function s(e,t){return i+=e,t}function a(t){return s(t,new Uint8Array(e,i,t))}function c(){return s(1,r.getUint8(i))}function o(){return s(2,r.getUint16(i))}function l(){return s(4,r.getUint32(i))}function h(){return 255===r.getUint8(i)&&(i+=1,!0)}function u(e){if(e<24)return e;if(24===e)return c();if(25===e)return o();if(26===e)return l();if(27===e)return l()*$+l();if(31===e)return-1;throw"Invalid length encoding"}function d(e){var t=c();if(255===t)return-1;var n=u(31&t);if(n<0||t>>5!==e)throw"Invalid indefinite length element";return n}function g(e,t){for(var n=0;n<t;++n){var r=c();128&r&&(r<224?(r=(31&r)<<6|63&c(),t-=1):r<240?(r=(15&r)<<12|(63&c())<<6|63&c(),t-=2):(r=(15&r)<<18|(63&c())<<12|(63&c())<<6|63&c(),t-=3)),r<65536?e.push(r):(r-=65536,e.push(55296|r>>10),e.push(56320|1023&r))}}"function"!=typeof t&&(t=function(e){return e}),"function"!=typeof n&&(n=function(){});var f=function e(){var l,f,_=c(),m=_>>5,p=31&_;if(7===m)switch(p){case 25:return function(){var e=new ArrayBuffer(4),t=new DataView(e),n=o(),r=32768&n,i=31744&n,s=1023&n;if(31744===i)i=261120;else if(0!==i)i+=114688;else if(0!==s)return(r?-1:1)*s*X;return t.setUint32(0,r<<16|i<<13|s<<13),t.getFloat32(0)}();case 26:return s(4,r.getFloat32(i));case 27:return s(8,r.getFloat64(i))}if((f=u(p))<0&&(m<2||6<m))throw"Invalid length";switch(m){case 0:return f;case 1:return-1-f;case 2:if(f<0){for(var v=[],w=0;(f=d(m))>=0;)w+=f,v.push(a(f));var b=new Uint8Array(w),I=0;for(l=0;l<v.length;++l)b.set(v[l],I),I+=v[l].length;return b}return a(f);case 3:var E=[];if(f<0)for(;(f=d(m))>=0;)g(E,f);else g(E,f);return String.fromCharCode.apply(null,E);case 4:var y;if(f<0)for(y=[];!h();)y.push(e());else for(y=new Array(f),l=0;l<f;++l)y[l]=e();return y;case 5:var A={};for(l=0;l<f||f<0&&!h();++l){A[e()]=e()}return A;case 6:return t(e(),f);case 7:switch(f){case 20:return!1;case 21:return!0;case 22:return null;case 23:return;default:return n(f)}}}();if(i!==e.byteLength)throw"Remaining bytes";return f}const W={encode:Z,decode:ee},S={READ:0,READ_RSP:1,WRITE:2,WRITE_RSP:3},w={OS:0,IMAGE:1,STAT:2,CONFIG:3,LOG:4,CRASH:5,SPLIT:6,RUN:7,FS:8,SHELL:9},L={ECHO:0,CONS_ECHO_CTRL:1,TASKSTAT:2,MPSTAT:3,DATETIME_STR:4,RESET:5},T={STATE:0,UPLOAD:1,FILE:2,CORELIST:3,CORELOAD:4,ERASE:5};class te{constructor(e={}){this.SMP_SERVICE_UUID="8d53dc1d-1db7-4cd3-868b-8a527460aa84",this.SMP_CHARACTERISTIC_UUID="da2e7828-fbce-4e01-ae9e-261174997c48",this._mtu=140,this._device=null,this._service=null,this._characteristic=null,this._connectCallback=null,this._connectingCallback=null,this._disconnectCallback=null,this._connectionLossCallback=null,this._messageCallback=null,this._imageUploadProgressCallback=null,this._uploadIsInProgress=!1,this._buffer=new Uint8Array,this._logger=e.logger||{info:console.log,error:console.error},this._seq=0,this._userRequestedDisconnect=!1}async _requestDevice(e){const t={acceptAllDevices:!1,optionalServices:[this.SMP_SERVICE_UUID]};return e&&(t.filters=e,t.acceptAllDevices=!1),navigator.bluetooth.requestDevice(t)}async connect(e){try{this._device=await this._requestDevice(e),this._logger.info(`Connecting to device ${this.name}...`),this._device.addEventListener("gattserverdisconnected",(async e=>{this._logger.info(e),!1===this._userRequestedDisconnect?(this._logger.info("Trying to reconnect"),await new Promise((e=>setTimeout(e,1e3))),this._connectionLossCallback&&this._connectionLossCallback(),await this._connect()):this._disconnected()})),await this._connect()}catch(e){return this._logger.error(e),void await this._disconnected()}}async _connect(){try{this._connectingCallback&&this._connectingCallback();const e=await this._device.gatt.connect();this._logger.info("Server connected."),this._service=await e.getPrimaryService(this.SMP_SERVICE_UUID),this._logger.info("Service connected."),this._characteristic=await this._service.getCharacteristic(this.SMP_CHARACTERISTIC_UUID),this._characteristic.addEventListener("characteristicvaluechanged",this._notification.bind(this)),await this._characteristic.startNotifications(),await this._connected(),this._uploadIsInProgress&&this._uploadNext()}catch(e){this._logger.error(e),await this._disconnected()}}disconnect(){return this._userRequestedDisconnect=!0,this._device.gatt.disconnect()}onConnecting(e){return this._connectingCallback=e,this}onConnect(e){return this._connectCallback=e,this}onDisconnect(e){return this._disconnectCallback=e,this}onConnectionLoss(e){return this._connectionLossCallback=e,this}onMessage(e){return this._messageCallback=e,this}onImageUploadProgress(e){return this._imageUploadProgressCallback=e,this}onImageUploadFinished(e){return this._imageUploadFinishedCallback=e,this}async _connected(){this._connectCallback&&this._connectCallback()}async _disconnected(){this._logger.info("Disconnected."),this._disconnectCallback&&this._disconnectCallback(),this._device=null,this._service=null,this._characteristic=null,this._uploadIsInProgress=!1,this._userRequestedDisconnect=!1}get name(){return this._device&&this._device.name}async _sendMessage(e,t,n,r){let i=[];typeof r<"u"&&(i=[...new Uint8Array(W.encode(r))]);const s=255&i.length,a=[e,0,i.length>>8,s,t>>8,255&t,this._seq,n,...i];await this._characteristic.writeValueWithoutResponse(Uint8Array.from(a)),this._seq=(this._seq+1)%256}_notification(e){const t=new Uint8Array(e.target.value.buffer);this._buffer=new Uint8Array([...this._buffer,...t]);const n=256*this._buffer[2]+this._buffer[3];this._buffer.length<n+8||(this._processMessage(this._buffer.slice(0,n+8)),this._buffer=this._buffer.slice(n+8))}_processMessage(e){const[t,n,r,i,s,a,c,o]=e,l=W.decode(e.slice(8).buffer),h=256*r+i,u=256*s+a;if(u===w.IMAGE&&o===T.UPLOAD&&(0===l.rc||void 0===l.rc)&&l.off)return this._uploadOffset=l.off,void this._uploadNext();this._messageCallback&&this._messageCallback({op:t,group:u,id:o,data:l,length:h})}cmdReset(){return this._sendMessage(S.WRITE,w.OS,L.RESET)}smpEcho(e){return this._sendMessage(S.WRITE,w.OS,L.ECHO,{d:e})}cmdImageState(){return this._sendMessage(S.READ,w.IMAGE,T.STATE)}cmdImageErase(){return this._sendMessage(S.WRITE,w.IMAGE,T.ERASE,{})}cmdImageTest(e){return this._sendMessage(S.WRITE,w.IMAGE,T.STATE,{hash:e,confirm:!1})}cmdImageConfirm(e){return this._sendMessage(S.WRITE,w.IMAGE,T.STATE,{hash:e,confirm:!0})}_hash(e){return crypto.subtle.digest("SHA-256",e)}async _uploadNext(){if(this._uploadOffset>=this._uploadImage.byteLength)return this._uploadIsInProgress=!1,void this._imageUploadFinishedCallback();const e={data:new Uint8Array,off:this._uploadOffset};0===this._uploadOffset&&(e.len=this._uploadImage.byteLength,e.sha=new Uint8Array(await this._hash(this._uploadImage))),this._imageUploadProgressCallback({percentage:Math.floor(this._uploadOffset/this._uploadImage.byteLength*100)});const t=this._mtu-W.encode(e).byteLength-8;e.data=new Uint8Array(this._uploadImage.slice(this._uploadOffset,this._uploadOffset+t)),this._uploadOffset+=t,this._sendMessage(S.WRITE,w.IMAGE,T.UPLOAD,e)}async cmdUpload(e,t=0){this._uploadIsInProgress?this._logger.error("Upload is already in progress."):(this._uploadIsInProgress=!0,this._uploadOffset=0,this._uploadImage=e,this._uploadSlot=t,this._uploadNext())}async imageInfo(e){const t={},n=new Uint8Array(e);if(n.length<32)throw new Error("Invalid image (too short file)");if(61!==n[0]||184!==n[1]||243!==n[2]||150!==n[3])throw new Error("Invalid image (wrong magic bytes)");if(0!==n[4]||0!==n[5]||0!==n[6]||0!==n[7])throw new Error("Invalid image (wrong load address)");const r=n[8]+256*n[9];if(0!==n[10]||0!==n[11])throw new Error("Invalid image (wrong protected TLV area size)");const i=n[12]+256*n[13]+65536*n[14]+n[15]*2**24;if(t.imageSize=i,n.length<i+r)throw new Error("Invalid image (wrong image size)");if(0!==n[16]||0!==n[17]||0!==n[18]||0!==n[19])throw new Error("Invalid image (wrong flags)");const s=`${n[20]}.${n[21]}.${n[22]+256*n[23]}`;return t.version=s,t.hash=[...new Uint8Array(await this._hash(e.slice(0,i+32)))].map((e=>e.toString(16).padStart(2,"0"))).join(""),t}}class G{constructor(e,t){this.validScreens=t,this.current=void 0,this.callbacks={},e&&(this.isValidScreen(e)?(this.current=e,document.getElementById(this.current).style.display="block",this.triggerCallback(this.current)):console.error(`Invalid initial screen: ${e}`))}set(e){this.isValidScreen(e)?(void 0!==this.current&&(document.getElementById(this.current).style.removeProperty("display"),this.triggerCallback(this.current,"hide")),this.current=e,document.getElementById(this.current).style.display="block",this.triggerCallback(this.current)):console.error(`Invalid screen ID: ${e}`)}get(){return this.current}on(e,t,n="show"){this.isValidScreen(e)?(this.callbacks[e]||(this.callbacks[e]={}),this.callbacks[e][n]=t):console.error(`Invalid screen ID for callbacks: ${e}`)}triggerCallback(e,t="show"){this.callbacks[e]&&this.callbacks[e][t]&&this.callbacks[e][t]()}isValidScreen(e){return this.validScreens.includes(e)&&null!==document.getElementById(e)}}const D="MONKEY",R="r2",H={MONKEY:{r1:"0.6.1",r2:"0.6.5"}},O=document.getElementById("button-connect"),ne=document.getElementById("button-disconnect"),re=document.getElementById("device-name"),ie=document.getElementById("device-fw-version"),se=document.getElementById("latest-fw-version"),ce=document.getElementById("update-button"),ae=document.getElementById("upload-status"),k=document.getElementById("changelog"),V=new G("initial-screen",["initial-screen","connected-screen","reconnect-screen"]);V.on("connected-screen",(()=>{k.innerHTML=""}),"hide");const Y=new G(null,["bt-available-screen","bt-unavailable-screen"]),A=new G("update-waiting-screen",["update-waiting-screen","update-good-screen","update-idle-screen","update-prepare-screen","update-uploading-screen","update-complete-screen"]);navigator&&navigator.bluetooth&&navigator.bluetooth.getAvailability()?Y.set("bt-available-screen"):Y.set("bt-unavailable-screen");const m=new te;function J(e){return e.split(".").map(Number)}function B(e,t){for(let n=0;n<e.length;n++){if(e[n]<t[n])return-1;if(e[n]>t[n])return 1}return 0}async function oe(e,t,n,r){let i=(await fetch(`/firmware/${e}/${t}/changelog.json`).then((e=>e.json()))).versions.filter((e=>{let t=[e.major,e.minor,e.patch];return B(t,n)>0&&B(t,r)<=0}));return i.sort(((e,t)=>-B([e.major,e.minor,e.patch],[t.major,t.minor,t.patch]))),i}function le(e){k.innerHTML="",e.forEach((e=>{k.innerHTML+=`<b>${e.major}.${e.minor}.${e.patch}</b><br/><ul>`,e.changes.forEach((e=>{k.innerHTML+=`<li>${e}</li>`})),k.innerHTML+="</ul><br/>"}))}m.onConnecting((()=>{console.log("Connecting..."),O.disabled=!0,O.innerText="Connecting..."})),m.onConnect((()=>{re.innerText=m.name,m.cmdImageState(),se.innerHTML=H[D][R],V.set("connected-screen")})),m.onDisconnect((()=>{O.disabled=!1,O.innerText="Connect via Bluetooth",V.set("initial-screen")})),m.onConnectionLoss((()=>{V.set("reconnect-screen")})),m.onMessage((({op:e,group:t,id:n,data:r,length:i})=>{switch(t){case w.OS:switch(n){case L.ECHO:alert(r.r);break;case L.TASKSTAT:console.table(r.tasks);break;case L.MPSTAT:console.log(r)}break;case w.IMAGE:if(n===T.STATE)r.images.forEach((e=>{if(e.active){ie.innerHTML=e.version;let t=J(e.version),n=J(H[D][R]);B(t,n)<0?(A.set("update-idle-screen"),oe(D,R,t,n).then((e=>{le(e)}))):A.set("update-good-screen")}}));break;default:console.log("Unknown group")}})),m.onImageUploadProgress((({percentage:e})=>{0!=e&&"update-uploading-screen"!=A.get()&&A.set("update-uploading-screen"),ae.innerText=`${e}%`})),m.onImageUploadFinished((()=>{A.set("update-complete-screen")})),O.addEventListener("click",(async()=>{let e=[{namePrefix:"WAVY MONKEY",services:["03B80E5A-EDE8-4B33-A751-6CE34EC4C700".toLowerCase()]}];await m.connect(e)})),ne.addEventListener("click",(async()=>{m.disconnect()})),ce.addEventListener("click",(async()=>{try{A.set("update-prepare-screen"),fetch(`/firmware/${D}/${R}/app_update_${H[D][R]}.bin`).then((e=>e.arrayBuffer())).then((e=>{m.cmdUpload(e)}))}catch{A.set("update-idle-screen")}}));