var $=5960464477539063e-23,C=4294967296,B=9007199254740992;function k(E){var t=new ArrayBuffer(256),e=new DataView(t),h,s=0;function f(i){for(var a=t.byteLength,r=s+i;a<r;)a<<=1;if(a!==t.byteLength){var n=e;t=new ArrayBuffer(a),e=new DataView(t);for(var l=s+3>>2,o=0;o<l;++o)e.setUint32(o<<2,n.getUint32(o<<2))}return h=i,e}function g(){s+=h}function w(i){g(f(8).setFloat64(s,i))}function d(i){g(f(1).setUint8(s,i))}function m(i){for(var a=f(i.length),r=0;r<i.length;++r)a.setUint8(s+r,i[r]);g()}function u(i){g(f(2).setUint16(s,i))}function L(i){g(f(4).setUint32(s,i))}function I(i){var a=i%C,r=(i-a)/C,n=f(8);n.setUint32(s,r),n.setUint32(s+4,a),g()}function U(i,a){a<24?d(i<<5|a):a<256?(d(i<<5|24),d(a)):a<65536?(d(i<<5|25),u(a)):a<4294967296?(d(i<<5|26),L(a)):(d(i<<5|27),I(a))}function y(i){var a;if(i===!1)return d(244);if(i===!0)return d(245);if(i===null)return d(246);if(i===void 0)return d(247);switch(typeof i){case"number":if(Math.floor(i)===i){if(0<=i&&i<=B)return U(0,i);if(-B<=i&&i<0)return U(1,-(i+1))}return d(251),w(i);case"string":var r=[];for(a=0;a<i.length;++a){var n=i.charCodeAt(a);n<128?r.push(n):n<2048?(r.push(192|n>>6),r.push(128|n&63)):n<55296?(r.push(224|n>>12),r.push(128|n>>6&63),r.push(128|n&63)):(n=(n&1023)<<10,n|=i.charCodeAt(++a)&1023,n+=65536,r.push(240|n>>18),r.push(128|n>>12&63),r.push(128|n>>6&63),r.push(128|n&63))}return U(3,r.length),m(r);default:var l;if(Array.isArray(i))for(l=i.length,U(4,l),a=0;a<l;++a)y(i[a]);else if(i instanceof Uint8Array)U(2,i.length),m(i);else{var o=Object.keys(i);for(l=o.length,U(5,l),a=0;a<l;++a){var c=o[a];y(c),y(i[c])}}}}if(y(E),"slice"in t)return t.slice(0,s);for(var T=new ArrayBuffer(s),O=new DataView(T),S=0;S<s;++S)O.setUint8(S,e.getUint8(S));return T}function z(E,t,e){var h=new DataView(E),s=0;typeof t!="function"&&(t=function(r){return r}),typeof e!="function"&&(e=function(){});function f(r,n){return s+=r,n}function g(r){return f(r,new Uint8Array(E,s,r))}function w(){var r=new ArrayBuffer(4),n=new DataView(r),l=L(),o=l&32768,c=l&31744,R=l&1023;if(c===31744)c=261120;else if(c!==0)c+=114688;else if(R!==0)return(o?-1:1)*R*$;return n.setUint32(0,o<<16|c<<13|R<<13),n.getFloat32(0)}function d(){return f(4,h.getFloat32(s))}function m(){return f(8,h.getFloat64(s))}function u(){return f(1,h.getUint8(s))}function L(){return f(2,h.getUint16(s))}function I(){return f(4,h.getUint32(s))}function U(){return I()*C+I()}function y(){return h.getUint8(s)!==255?!1:(s+=1,!0)}function T(r){if(r<24)return r;if(r===24)return u();if(r===25)return L();if(r===26)return I();if(r===27)return U();if(r===31)return-1;throw"Invalid length encoding"}function O(r){var n=u();if(n===255)return-1;var l=T(n&31);if(l<0||n>>5!==r)throw"Invalid indefinite length element";return l}function S(r,n){for(var l=0;l<n;++l){var o=u();o&128&&(o<224?(o=(o&31)<<6|u()&63,n-=1):o<240?(o=(o&15)<<12|(u()&63)<<6|u()&63,n-=2):(o=(o&15)<<18|(u()&63)<<12|(u()&63)<<6|u()&63,n-=3)),o<65536?r.push(o):(o-=65536,r.push(55296|o>>10),r.push(56320|o&1023))}}function i(){var r=u(),n=r>>5,l=r&31,o,c;if(n===7)switch(l){case 25:return w();case 26:return d();case 27:return m()}if(c=T(l),c<0&&(n<2||6<n))throw"Invalid length";switch(n){case 0:return c;case 1:return-1-c;case 2:if(c<0){for(var R=[],P=0;(c=O(n))>=0;)P+=c,R.push(g(c));var V=new Uint8Array(P),G=0;for(o=0;o<R.length;++o)V.set(R[o],G),G+=R[o].length;return V}return g(c);case 3:var M=[];if(c<0)for(;(c=O(n))>=0;)S(M,c);else S(M,c);return String.fromCharCode.apply(null,M);case 4:var b;if(c<0)for(b=[];!y();)b.push(i());else for(b=new Array(c),o=0;o<c;++o)b[o]=i();return b;case 5:var N={};for(o=0;o<c||c<0&&!y();++o){var H=i();N[H]=i()}return N;case 6:return t(i(),c);case 7:switch(c){case 20:return!1;case 21:return!0;case 22:return null;case 23:return;default:return e(c)}}}var a=i();if(s!==E.byteLength)throw"Remaining bytes";return a}const D={encode:k,decode:z},W=(E,t)=>{if(!E)throw new Error(`Assertion failed: ${t}`)};class p{static LEVEL_DEBUG=0;static LEVEL_INFO=1;static LEVEL_WARNING=2;static LEVEL_ERROR=3;static LEVEL_IMPORTANT=4;static#c="gray";static#l="white";static#e="yellow";static#h="red";static#s="blue";#o;#t;constructor(t,e){this.#o=t,this.#t=e}#i(t,e){if(typeof t=="object"){console.log(`%c${this.#o}: ⬇︎`,`color: ${e}`),console.log(t);return}console.log(`%c${this.#o}: ${t}`,`color: ${e}`)}debug(t){this.#t<=p.LEVEL_DEBUG&&this.#i(t,p.#c)}info(t){this.#t<=p.LEVEL_INFO&&this.#i(t,p.#l)}warning(t){this.#t<=p.LEVEL_WARNING&&this.#i(t,p.#e)}error(t){this.#t<=p.LEVEL_ERROR&&this.#i(t,p.#h)}important(t){this.#t<=p.LEVEL_IMPORTANT&&this.#i(t,p.#s)}}const q=E=>crypto.subtle.digest("SHA-256",E),j=async E=>{const t={},e=new Uint8Array(E);if(e.length<32)throw new Error("Invalid image (too short file)");if(e[0]!==61||e[1]!==184||e[2]!==243||e[3]!==150)throw new Error("Invalid image (wrong magic bytes)");if(e[4]!==0||e[5]!==0||e[6]!==0||e[7]!==0)throw new Error("Invalid image (wrong load address)");const h=e[8]+e[9]*2**8;if(e[10]!==0||e[11]!==0)throw new Error("Invalid image (wrong protected TLV area size)");const s=e[12]+e[13]*2**8+e[14]*2**16+e[15]*2**24;if(t.imageSize=s,e.length<s+h)throw new Error("Invalid image (wrong image size)");if(e[16]!==0||e[17]!==0||e[18]!==0||e[19]!==0)throw new Error("Invalid image (wrong flags)");const f=`${e[20]}.${e[21]}.${e[22]+e[23]*2**8}`;return t.version=f,t.hash=[...new Uint8Array(await q(E.slice(0,s+32)))].map(g=>g.toString(16).padStart(2,"0")).join(""),t};let x=new p("MCUManager",p.LEVEL_DEBUG);const K={0:"No error, OK.",1:"Unknown error.",2:"Not enough memory; this error is reported when there is not enough memory to complete response.",3:"Invalid value; a request contains an invalid value.",4:"Timeout; the operation for some reason could not be completed in assumed time.",5:"No entry; the error means that request frame has been missing some information that is required to perform action. It may also mean that requested information is not available.",6:"Bad state; the error means that application or device is in a state that would not allow it to perform or complete a requested action.",7:"Response too long; this error is issued when buffer assigned for gathering response is not big enough.",8:"Not supported; usually issued when requested Group ID or Command ID is not supported by application.",9:"Corrupted payload received.",10:"Device is busy with processing previous SMP request and may not process incoming one. Client should re-try later.",256:"This is base error number of user defined error codes."},A={READ:0,READ_RSP:1,WRITE:2,WRITE_RSP:3},Z=Object.fromEntries(Object.entries(A).map(([E,t])=>[t,E])),_={OS:0,IMAGE:1,STAT:2,CONFIG:3,LOG:4,CRASH:5,SPLIT:6,RUN:7,FS:8,SHELL:9},F={ECHO:0,CONS_ECHO_CTRL:1,TASKSTAT:2,MPSTAT:3,DATETIME_STR:4,RESET:5},v={STATE:0,UPLOAD:1,FILE:2,CORELIST:3,CORELOAD:4,ERASE:5};class J{#c;#l;#e;#h;#s;#o;#t;#i;#d;#g;#E;#f;#r;#w;#n;#u;#U;#x;constructor(t={}){this.SMP_SERVICE_UUID="8d53dc1d-1db7-4cd3-868b-8a527460aa84",this.SMP_CHARACTERISTIC_UUID="da2e7828-fbce-4e01-ae9e-261174997c48",this.SMP_HEADER_SIZE=8,this.#l=140,this.#e=null,this.#h=null,this.#s=null,this.#o=null,this.#t=null,this.#i=null,this.#d=null,this.#g=null,this.#E=null,this.#f=!1,this.#r=new Uint8Array,this.#w=0,this.#c=!1}async#R(t){const e={acceptAllDevices:!1,optionalServices:[this.SMP_SERVICE_UUID]};return t&&(e.filters=t,e.acceptAllDevices=!1),navigator.bluetooth.requestDevice(e)}async connect(t){try{this.#e=await this.#R(t),x.debug(`Connecting to device ${this.name}...`),this.#e.addEventListener("gattserverdisconnected",async e=>{x.debug(e),this.#c===!1?(x.debug("Trying to reconnect"),await new Promise(h=>setTimeout(h,1e3)),this.#d&&this.#d(),await this.#I()):this.#p()}),await this.#I()}catch(e){x.error(e),await this.#p();return}}async#I(){try{this.#t&&this.#t();const t=await this.#e.gatt.connect();x.debug("Server connected. Awaiting SMP service..."),this.#h=await t.getPrimaryService(this.SMP_SERVICE_UUID),x.debug("Service connected."),this.#s=await this.#h.getCharacteristic(this.SMP_CHARACTERISTIC_UUID),this.#s.addEventListener("characteristicvaluechanged",this.#A.bind(this)),await this.#s.startNotifications(),await this.#_(),this.#f&&this.#m()}catch(t){x.error(t),await this.#p()}}disconnect(){return this.#c=!0,this.#e.gatt.disconnect()}onConnecting(t){return this.#t=t,this}onConnect(t){return this.#o=t,this}onDisconnect(t){return this.#i=t,this}onConnectionLoss(t){return this.#d=t,this}onMessage(t){return this.#g=t,this}onImageUploadProgress(t){return this.#E=t,this}onImageUploadFinished(t){return this.#x=t,this}async#_(){this.#o&&this.#o()}async#p(){x.debug("Disconnected."),this.#i&&this.#i(),this.#e=null,this.#h=null,this.#s=null,this.#f=!1,this.#c=!1}get name(){return this.#e&&this.#e.name}cmdReset(){return this.#a(A.WRITE,_.OS,F.RESET)}smpEcho(t){return this.#a(A.WRITE,_.OS,F.ECHO,{d:t})}cmdImageState(){return this.#a(A.READ,_.IMAGE,v.STATE)}cmdImageErase(){return this.#a(A.WRITE,_.IMAGE,v.ERASE,{})}cmdImageTest(t){return this.#a(A.WRITE,_.IMAGE,v.STATE,{hash:t,confirm:!1})}cmdImageConfirm(t){return this.#a(A.WRITE,_.IMAGE,v.STATE,{hash:t,confirm:!0})}cmdCustom(t,e,h,s,f=!0){return this.#a(h,t,e,s,f)}async cmdUpload(t,e=0){if(this.#f){x.error("Upload is already in progress.");return}this.#f=!0,this.#n=0,this.#u=t,this.#U=e,this.#m()}#A(t){const e=new Uint8Array(t.target.value.buffer);this.#r=new Uint8Array([...this.#r,...e]);const h=this.#r[2]*256+this.#r[3];this.#r.length<h+8||(this.#y(this.#r.slice(0,h+8)),this.#r=this.#r.slice(h+8))}async#m(){if(this.#n>=this.#u.byteLength){this.#f=!1,this.#x();return}const t={data:new Uint8Array,off:this.#n};this.#n===0&&(t.len=this.#u.byteLength,t.sha=new Uint8Array(await q(this.#u)));const e=this.#l-D.encode(t).byteLength-this.SMP_HEADER_SIZE;t.data=new Uint8Array(this.#u.slice(this.#n,this.#n+e)),this.#n+=e,this.#a(A.WRITE,_.IMAGE,v.UPLOAD,t),this.#E&&this.#E({percentage:Math.floor(this.#n/this.#u.byteLength*100)})}#y(t){const[e,h,s,f,g,w,d,m]=t,u=D.decode(t.slice(8).buffer),L=s*256+f,I=g*256+w;if(I===_.IMAGE&&m===v.UPLOAD&&(u.rc===0||u.rc===void 0)&&u.off){x.debug(`Block uploaded successfully, offset: ${u.off}`),this.#n=u.off,this.#m();return}this.#g&&this.#g({op:e,group:I,id:m,data:u,length:L})}async#a(t,e,h,s,f=!0){let g=typeof s<"u";var w=[];g&&(f?w=[...new Uint8Array(D.encode(s))]:w=s);let d=this.#S(t,e,h,w);const m=[...d,...w];this.#w=(this.#w+1)%256,x.debug("Sending message:");let u={header:d,data:w};x.debug(u),await this.#s.writeValueWithoutResponse(Uint8Array.from(m))}#S(t,e,h,s){const g=s.length&255,w=s.length>>8;W(w<256,"Message too long");const d=e&255,m=e>>8;return W(m<256,"Group too high"),[t,0,w,g,m,d,this.#w,h]}}export{v as I,p as L,_ as M,F as O,K as S,J as a,Z as b,j as i};
