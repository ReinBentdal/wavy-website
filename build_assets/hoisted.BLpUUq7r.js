import{Q as Pe,R as Re,k as $e}from"./lit-html.CzCPjovT.js";import"./hoisted.DvC32OUy.js";class A{static LEVEL_DEBUG=0;static LEVEL_INFO=1;static LEVEL_WARNING=2;static LEVEL_ERROR=3;static LEVEL_IMPORTANT=4;static#n="gray";static#r="white";static#i="yellow";static#o="red";static#a="blue";#s;#e;constructor(e,t){this.#s=e,this.#e=t}#t(e,t){if(typeof e=="object"){console.log(`%c${this.#s}: ⬇︎`,`color: ${t}`),console.log(e);return}console.log(`%c${this.#s}: ${e}`,`color: ${t}`)}debug(e){this.#e<=A.LEVEL_DEBUG&&this.#t(e,A.#n)}info(e){this.#e<=A.LEVEL_INFO&&this.#t(e,A.#r)}warning(e){this.#e<=A.LEVEL_WARNING&&this.#t(e,A.#i)}error(e){this.#e<=A.LEVEL_ERROR&&this.#t(e,A.#o)}important(e){this.#e<=A.LEVEL_IMPORTANT&&this.#t(e,A.#a)}}const Oe=r=>crypto.subtle.digest("SHA-256",r);var Le=5960464477539063e-23,J=4294967296,he=9007199254740992;function xe(r){var e=new ArrayBuffer(256),t=new DataView(e),s,n=0;function i(h){for(var p=e.byteLength,l=n+h;p<l;)p<<=1;if(p!==e.byteLength){var d=t;e=new ArrayBuffer(p),t=new DataView(e);for(var y=n+3>>2,f=0;f<y;++f)t.setUint32(f<<2,d.getUint32(f<<2))}return s=h,t}function a(){n+=s}function c(h){a(i(8).setFloat64(n,h))}function o(h){a(i(1).setUint8(n,h))}function m(h){for(var p=i(h.length),l=0;l<h.length;++l)p.setUint8(n+l,h[l]);a()}function u(h){a(i(2).setUint16(n,h))}function w(h){a(i(4).setUint32(n,h))}function v(h){var p=h%J,l=(h-p)/J,d=i(8);d.setUint32(n,l),d.setUint32(n+4,p),a()}function b(h,p){p<24?o(h<<5|p):p<256?(o(h<<5|24),o(p)):p<65536?(o(h<<5|25),u(p)):p<4294967296?(o(h<<5|26),w(p)):(o(h<<5|27),v(p))}function _(h){var p;if(h===!1)return o(244);if(h===!0)return o(245);if(h===null)return o(246);if(h===void 0)return o(247);switch(typeof h){case"number":if(Math.floor(h)===h){if(0<=h&&h<=he)return b(0,h);if(-he<=h&&h<0)return b(1,-(h+1))}return o(251),c(h);case"string":var l=[];for(p=0;p<h.length;++p){var d=h.charCodeAt(p);d<128?l.push(d):d<2048?(l.push(192|d>>6),l.push(128|d&63)):d<55296?(l.push(224|d>>12),l.push(128|d>>6&63),l.push(128|d&63)):(d=(d&1023)<<10,d|=h.charCodeAt(++p)&1023,d+=65536,l.push(240|d>>18),l.push(128|d>>12&63),l.push(128|d>>6&63),l.push(128|d&63))}return b(3,l.length),m(l);default:var y;if(Array.isArray(h))for(y=h.length,b(4,y),p=0;p<y;++p)_(h[p]);else if(h instanceof Uint8Array)b(2,h.length),m(h);else{var f=Object.keys(h);for(y=f.length,b(5,y),p=0;p<y;++p){var E=f[p];_(E),_(h[E])}}}}if(_(r),"slice"in e)return e.slice(0,n);for(var U=new ArrayBuffer(n),$=new DataView(U),I=0;I<n;++I)$.setUint8(I,t.getUint8(I));return U}function Ie(r,e,t){var s=new DataView(r),n=0;typeof e!="function"&&(e=function(l){return l}),typeof t!="function"&&(t=function(){});function i(l,d){return n+=l,d}function a(l){return i(l,new Uint8Array(r,n,l))}function c(){var l=new ArrayBuffer(4),d=new DataView(l),y=w(),f=y&32768,E=y&31744,O=y&1023;if(E===31744)E=261120;else if(E!==0)E+=114688;else if(O!==0)return(f?-1:1)*O*Le;return d.setUint32(0,f<<16|E<<13|O<<13),d.getFloat32(0)}function o(){return i(4,s.getFloat32(n))}function m(){return i(8,s.getFloat64(n))}function u(){return i(1,s.getUint8(n))}function w(){return i(2,s.getUint16(n))}function v(){return i(4,s.getUint32(n))}function b(){return v()*J+v()}function _(){return s.getUint8(n)!==255?!1:(n+=1,!0)}function U(l){if(l<24)return l;if(l===24)return u();if(l===25)return w();if(l===26)return v();if(l===27)return b();if(l===31)return-1;throw"Invalid length encoding"}function $(l){var d=u();if(d===255)return-1;var y=U(d&31);if(y<0||d>>5!==l)throw"Invalid indefinite length element";return y}function I(l,d){for(var y=0;y<d;++y){var f=u();f&128&&(f<224?(f=(f&31)<<6|u()&63,d-=1):f<240?(f=(f&15)<<12|(u()&63)<<6|u()&63,d-=2):(f=(f&15)<<18|(u()&63)<<12|(u()&63)<<6|u()&63,d-=3)),f<65536?l.push(f):(f-=65536,l.push(55296|f>>10),l.push(56320|f&1023))}}function h(){var l=u(),d=l>>5,y=l&31,f,E;if(d===7)switch(y){case 25:return c();case 26:return o();case 27:return m()}if(E=U(y),E<0&&(d<2||6<d))throw"Invalid length";switch(d){case 0:return E;case 1:return-1-E;case 2:if(E<0){for(var O=[],ie=0;(E=$(d))>=0;)ie+=E,O.push(a(E));var oe=new Uint8Array(ie),ae=0;for(f=0;f<O.length;++f)oe.set(O[f],ae),ae+=O[f].length;return oe}return a(E);case 3:var Y=[];if(E<0)for(;(E=$(d))>=0;)I(Y,E);else I(Y,E);return String.fromCharCode.apply(null,Y);case 4:var k;if(E<0)for(k=[];!_();)k.push(h());else for(k=new Array(E),f=0;f<E;++f)k[f]=h();return k;case 5:var ce={};for(f=0;f<E||E<0&&!_();++f){var De=h();ce[De]=h()}return ce;case 6:return e(h(),E);case 7:switch(E){case 20:return!1;case 21:return!0;case 22:return null;case 23:return;default:return t(E)}}}var p=h();if(n!==r.byteLength)throw"Remaining bytes";return p}const ee={encode:xe,decode:Ie};let P=new A("mcumgr",A.LEVEL_DEBUG);const H={EOK:0,EUNKNOWN:1,ENOMEM:2,EINVAL:3,ETIMEOUT:4,ENOENT:5,EBADSTATE:6,EMSGSIZE:7,ENOTSUP:8,ECORRUPT:9,EBUSY:10,EACCESSDENIED:11,UNSUPPORTED_TOO_OLD:12,UNSUPPORTED_TOO_NEW:13,EPERUSER:256},N={READ:0,READ_RSP:1,WRITE:2,WRITE_RSP:3};class Me{constructor(){this.device=null,this.service=null,this.characteristic=null,this.mtu=140,this.buffer=new Uint8Array([]),this.smpSequenceNumber=0,this.responseResolvers={},this.state={type:"disconnected"},this.onConnect=null,this.onDisconnect=null,this.onConnecting=null,this.onConnectionLoss=null,this.onConnectionReestablished=null,this.onDeviceSelection=null,this.onDeviceSelectionCancel=null,this.SMP_SERVICE_UUID="8d53dc1d-1db7-4cd3-868b-8a527460aa84",this.SMP_CHARACTERISTIC_UUID="da2e7828-fbce-4e01-ae9e-261174997c48",this.SMP_HEADER_SIZE=8,this.SMP_HEADER_OP_IDX=0,this.SMP_HEADER_FLAGS_IDX=1,this.SMP_HEADER_LEN_HI_IDX=2,this.SMP_HEADER_LEN_LO_IDX=3,this.SMP_HEADER_GROUP_HI_IDX=4,this.SMP_HEADER_GROUP_LO_IDX=5,this.SMP_HEADER_SEQ_IDX=6,this.SMP_HEADER_ID_IDX=7}async requestDevice(e){const t={optionalServices:[this.SMP_SERVICE_UUID]};return e?t.filters=e:t.acceptAllDevices=!0,this.onDeviceSelection?.(),navigator.bluetooth.requestDevice(t)}async connect(e){if(this.state.type!=="disconnected"){console.warn("Already connecting or connected.");return}this.state={type:"selectingDevice"};try{this.device=await this.requestDevice(e),this.state={type:"connecting"},this.onConnecting?.(),console.debug(`Connecting to device ${this.device.name}...`),this.device.addEventListener("gattserverdisconnected",this.handleDisconnection.bind(this)),await this.connectDevice()}catch(t){t.name==="NotFoundError"?(console.debug("Device selection canceled."),this.state={type:"disconnected"},this.onDeviceSelectionCancel?.()):(console.error("Connection error:",t),await this.handleDisconnected())}}async connectDevice(){if(!this.device){console.error("No device to connect to");return}try{const e=await this.device.gatt.connect();console.debug("Server connected. Awaiting SMP service..."),this.service=await e.getPrimaryService(this.SMP_SERVICE_UUID),console.debug("Service connected."),this.characteristic=await this.service.getCharacteristic(this.SMP_CHARACTERISTIC_UUID),this.characteristic.addEventListener("characteristicvaluechanged",this.notification.bind(this)),await this.characteristic.startNotifications(),(this.state.type==="connecting"||this.state.type==="connectionLoss")&&(this.state.type==="connectionLoss"?this.onConnectionReestablished?.():this.onConnect?.(),this.state={type:"connected"})}catch(e){console.error("Error during connection:",e),await this.handleDisconnected()}}disconnect(){if(this.state.type!=="connected"){console.warn("Cannot disconnect because not connected.");return}this.state={type:"disconnecting"},this.device&&this.device.gatt&&this.device.gatt.disconnect()}async handleDisconnection(){console.debug("Device disconnected"),this.state.type==="connected"?(this.state={type:"connectionLoss"},this.onConnectionLoss?.(),await this.reconnect()):this.state.type==="disconnecting"&&await this.handleDisconnected()}async reconnect(){try{await new Promise(e=>setTimeout(e,1e3)),await this.connectDevice()}catch(e){console.error("Reconnection error:",e)}}async handleDisconnected(){this.state={type:"disconnected"},this.onDisconnect?.(),this.device=null,this.service=null,this.characteristic=null}get name(){return this.device?.name}get maxPayloadSize(){return this.mtu-3-this.SMP_HEADER_SIZE}buildSMPMessage(e,t,s,n,i,a=new Uint8Array([])){const c=a.length,o=new Uint8Array(this.SMP_HEADER_SIZE);return o[this.SMP_HEADER_OP_IDX]=e,o[this.SMP_HEADER_FLAGS_IDX]=t,o[this.SMP_HEADER_LEN_HI_IDX]=c>>8&255,o[this.SMP_HEADER_LEN_LO_IDX]=c&255,o[this.SMP_HEADER_GROUP_HI_IDX]=s>>8&255,o[this.SMP_HEADER_GROUP_LO_IDX]=s&255,o[this.SMP_HEADER_SEQ_IDX]=n,o[this.SMP_HEADER_ID_IDX]=i,new Uint8Array([...o,...a])}async sendMessage(e,t,s,n=new Uint8Array([])){const i=this.smpSequenceNumber;this.smpSequenceNumber=(this.smpSequenceNumber+1)%256;const c=this.buildSMPMessage(e,0,t,i,s,n);return new Promise(async(o,m)=>{this.responseResolvers[i]={resolve:o,reject:m};try{if(!this.characteristic)throw P.debug("Characteristic not available"),new Error("Characteristic not available");await this.characteristic.writeValueWithoutResponse(c)}catch(u){P.dbg(`Failed to send bluetooth characteristic message: ${u}`),delete this.responseResolvers[i],m(u)}})}async notification(e){const t=e.target;P.debug("Notification received"),P.debug(t.value);const s=new Uint8Array(t.value.buffer);for(this.buffer=new Uint8Array([...this.buffer,...s]);this.buffer.length>=this.SMP_HEADER_SIZE;){const n=this.buffer[2]<<8|this.buffer[3],i=this.SMP_HEADER_SIZE+n;if(this.buffer.length>=i){const a=this.buffer.slice(0,i);P.debug("Processing message"),P.debug(a),await this.processMessage(a),this.buffer=this.buffer.slice(i)}else break}}async processMessage(e){const[t,s,n,i,a,c,o,m]=e.slice(0,this.SMP_HEADER_SIZE),u=e.slice(this.SMP_HEADER_SIZE);P.debug("payload"),P.debug(u);let w;try{w=ee.decode(u.buffer)}catch(b){P.error("Error decoding CBOR:",b)}const v=this.responseResolvers[o];v?(v.resolve(w),delete this.responseResolvers[o]):P.warn(`No resolver found for sequence number ${o}`)}}let C=new A("img_mgr",A.LEVEL_DEBUG);const j=(r,e)=>{if(e.major>r.major)return!0;if(e.major===r.major){if(e.minor>r.minor)return!0;if(e.minor===r.minor&&e.revision>r.revision)return!0}return!1};class Ce{constructor(e){this.IMAGE_GROUP_ID=1,this.state=0,this.mcumgr=e}async uploadImage(e,t){if(this.state===1){C.error("Upload already in progress");return}this.state=1;let s=0,n=e.byteLength;try{let i=new Uint8Array(await Oe(e));const a=this.mcumgr.maxPayloadSize;for(;s<n;){let c={off:s,data:new Uint8Array([])};s===0&&(C.debug("Starting image upload"),c.len=n,c.sha=i);let o=ee.encode(c);const m=o.byteLength;C.debug(`maxPayloadSize: ${a}, initialPayloadLength: ${m}`);const u=a-m-20;if(u<=0)return C.error("MTU too small to send data"),this.state=0,!1;const w=Math.min(s+u,n),v=new Uint8Array(e.slice(s,w));c.data=v,o=ee.encode(c),o.byteLength>a&&C.warn(`Payload too large: ${o.byteLength} > ${a}`);const b=await this.mcumgr.sendMessage(N.WRITE,this.IMAGE_GROUP_ID,1,new Uint8Array(o));if(b.rc!==void 0&&b.rc!==H.EOK)return this.state=0,!1;s=b.off,t?.(Math.floor(s/n*100))}return this.state=0,!0}catch(i){return C.error("Error during image upload:",i),this.state=0,!1}}async getFirmwareVersion(){const e=await this.mcumgr.sendMessage(N.READ,this.IMAGE_GROUP_ID,0);if(e.images===void 0||e.images.length===0)throw new Error("No image state found");const t=e.images.find(n=>n.active);if(!t)throw new Error("Device does not use Image Manager");const s=t.version.split(".").map(Number);return{versionString:t.version,major:s[0],minor:s[1],revision:s[2]}}}function Te(r){const e=r.split(`
`),t={release:null,dev:null,versions:[]};let s=null,n=!1;return e.forEach(i=>{if(i=i.trim(),i.startsWith("#")){const a=i.match(/# (\d+)\.(\d+)\.(\d+)(?:\[(.*?)\])?\s*(.*?)\s*((?:-\w+\s*)*)$/);if(a){const c=parseInt(a[1],10),o=parseInt(a[2],10),m=parseInt(a[3],10),u={versionString:`${c}.${o}.${m}`,major:c,minor:o,revision:m},w=a[4]?a[4].trim():null,v=a[5].trim(),_=a[6].trim().split(/\s+/).filter(Boolean),U=_.includes("-obsolete"),$=_.includes("-dev");U||((!t.dev||j(t.dev,u))&&(t.dev=u),$||(!t.release||j(t.release,u))&&(t.release=u)),n=m===0,s={version:u,isObsolete:U,isDev:$,highlight:v||null,date:w,summary:null,changes:[]},t.versions.push(s)}}else if(i.startsWith("-")){const a=i.substring(1).trim();s&&(s.changes.push(a),n=!1)}else i!==""&&s&&n&&s.version.revision===0&&(s.summary?s.summary+=`
`:s.summary="",s.summary+=i)}),t}const M=10,z=15;class V{constructor(){this.data=[]}push8(e){if(e<0||e>255)throw new RangeError(`Value ${e} is out of range for an 8-bit unsigned integer`);this.data.push(e&255)}push16(e){if(e<0||e>65535)throw new RangeError(`Value ${e} is out of range for a 16-bit unsigned integer`);this.data.push(e&255),this.data.push(e>>8&255)}push32(e){if(e<0||e>4294967295)throw new RangeError(`Value ${e} is out of range for a 32-bit unsigned integer`);this.data.push(e&255),this.data.push(e>>8&255),this.data.push(e>>16&255),this.data.push(e>>24&255)}pop8(){if(this.data.length<1)throw new RangeError("Attempted to pop from an empty array");return this.data.shift()}pop16(){if(this.data.length<2)throw new RangeError("Not enough data to pop 16 bits");const e=this.data.shift(),t=this.data.shift();return e|t<<8}pop32(){if(this.data.length<4)throw new RangeError("Not enough data to pop 32 bits");const e=this.data.shift(),t=this.data.shift(),s=this.data.shift(),n=this.data.shift();return(e|t<<8|s<<16|n<<24)>>>0}add(e){this.data.push(...e.data)}static from(e){const t=new V;return t.data=Array.from(e),t}}function Ne(r){let e=new V;e.push32(r.reserved0),e.push32(r.reserved1),e.push32(r.reserved2),e.push32(r.reserved3);for(let n=0;n<M;n++)e.push16(r.pages[n].id);let t=new V,s=new V;for(let n=0;n<M;n++){let i=r.pages[n];for(let a=0;a<z;a++){let c=i.loops[a];if(c==null){t.push16(65535);continue}t.push16(s.data.length),s.push8(c.length),s.push8(c.events.length);for(const o of c.events){const[m,u]=o;s.push8(u.note&127);const w=u.state<<7|u.velocity&127;s.push8(w),s.push16(m)}}}return e.add(t),e.add(s),Uint8Array.from(e.data)}function Ve(r){let e=V.from(r),t={reserved0:e.pop32(),reserved1:e.pop32(),reserved2:e.pop32(),reserved3:e.pop32(),pages:[]};for(let n=0;n<M;n++)t.pages.push({id:e.pop16(),loops:[]});let s=[];for(let n=0;n<M*z;n++)s.push(e.pop16()!==65535);for(let n=0;n<M;n++){let i=t.pages[n];for(let a=0;a<z;a++){if(s[n*M+a]==!1){i.loops.push(null);continue}let c={length:e.pop8(),events:[]},o=e.pop8();for(let m=0;m<o;m++){let u=e.pop8()&127,w=e.pop8(),v=w>>7&1,b=w&127,_=e.pop16();c.events.push([_,{note:u,state:v,velocity:b}])}i.loops.push(c)}}return t}function Be(){const r={note:36,velocity:100,state:1},e={note:36,velocity:0,state:0},t={note:38,velocity:100,state:1},s={note:38,velocity:0,state:0},n={note:42,velocity:100,state:1},i={note:42,velocity:0,state:0};function a(v){const b=[];for(const _ in v){const U=parseInt(_,10);for(const $ of v[U])b.push([U,$])}return b.sort((_,U)=>_[0]-U[0]),b}const c={length:48,events:a({0:[r,n],6:[e,i],12:[n],18:[i],24:[r,t,n],30:[e,s,i],36:[n],42:[i]})},o={length:32,events:a({0:[r],12:[t],24:[e,s]})},m=[],u={id:65278,loops:new Array(z).fill(null)};u.loops[0]=c,u.loops[1]=o,u.loops[2]=o,m.push(u);for(let v=1;v<M;v++){const b={id:65535,loops:new Array(z).fill(null)};m.push(b)}return{reserved0:4294967295,reserved1:4294967295,reserved2:4294967295,reserved3:4294967295,pages:m}}let g=new A("smpl_mgr",A.LEVEL_DEBUG);class ke{constructor(e){this.GROUP_ID=100,this.state=0,this.mcumgr=e}async getIDs(){g.debug("Getting sample ID");const e=await this.mcumgr.sendMessage(N.READ,this.GROUP_ID,0);if(e.rc===void 0||e.rc!==H.EOK)return g.error(`Error response received, rc: ${e.rc}`),Promise.reject("Error response received");const t=e;return g.debug(`Received sample IDs: ${t.ids}`),t.ids}async uploadSamples(e,t){if(g.debug("Starting sample upload process"),this.state!==0)return g.error("Cant start upload when not in idle state"),Promise.reject("Cant start upload when not in idle state");this.state=1;const s=this.mcumgr.maxPayloadSize,n=Ne(e),i=n.byteLength;let a=0;for(;this.state===1&&a<i;){g.debug(`Current offset: ${a}, Total length: ${i}`);let c={off:a,data:new Uint8Array([]),len:i},o=this._payloadUploadEncode(c);g.debug(`Initial payload size (without data): ${o.byteLength} bytes`);const m=s-o.byteLength-20;if(g.debug(`Max data size for this chunk: ${m} bytes`),m<=0)return g.error("MTU too small to send data"),this.state=0,!1;const u=Math.min(a+m,i),w=new Uint8Array(n.slice(a,u));if(g.debug(`Data chunk length: ${w.byteLength} bytes (from offset ${a} to ${u})`),c.data=w,o=this._payloadUploadEncode(c),g.debug(`Payload size after adding data: ${o.byteLength} bytes`),o.byteLength>s)return g.warn(`Payload too large: ${o.byteLength} > ${s}`),this.state=0,!1;try{g.debug("Sending payload to mcumgr");const v=await this.mcumgr.sendMessage(N.WRITE,this.GROUP_ID,1,o);if(g.debug("Received response from mcumgr"),v.rc!==void 0&&v.rc!==H.EOK)return g.error(`Error response received, rc: ${v.rc}`),this.state=0,!1;const b=v;g.debug(`Response success, new offset: ${b.off}`),a=b.off;const _=Math.floor(a/i*100);if(g.debug(`Upload progress: ${_}%`),t?.(_),a>=i){g.debug("Upload complete"),this.state=0;break}}catch(v){return g.error("Error during upload:",v),this.state=0,!1}}return g.debug("Successfully uploaded samples"),!0}async downloadSamples(e){if(g.debug("Starting sample download process"),this.state!==0)return g.error("Cant start download when not in idle state"),Promise.reject("Cant start download when not in idle state");this.state=2;let t=new Uint8Array([]),s=0,n=0,i={off:s},a=this._payloadDownloadEncode(i);try{const c=await this.mcumgr.sendMessage(N.READ,this.GROUP_ID,1,a);if(c.rc!==void 0&&c.rc!==H.EOK)return g.error(`Error response received, rc: ${c.rc}`),this.state=0,null;const o=c;if(g.debug(`Received first chunk, offset: ${o.off}, data length: ${o.data.byteLength}`),o.len===void 0)return g.error("Length not received in first chunk"),this.state=0,null;if(o.off!==s)return g.error("Invalid offset received in first chunk"),this.state=0,null;t=o.data,s=o.off+o.data.byteLength,n=o.len,e?.(Math.floor(s/n*100))}catch(c){return g.error("Error during download:",c),this.state=0,null}for(;s<n;){g.debug(`Current offset: ${s}, Total length: ${n}`),i={off:s},a=this._payloadDownloadEncode(i);try{const c=await this.mcumgr.sendMessage(N.READ,this.GROUP_ID,1,a);if(c.rc!==void 0&&c.rc!==H.EOK)return g.error(`Error response received, rc: ${c.rc}`),this.state=0,null;const o=c;if(g.debug(`Received chunk, offset: ${o.off}, data length: ${o.data.byteLength}`),t=new Uint8Array([...t,...o.data]),s=o.off+o.data.byteLength,e?.(Math.floor(s/n*100)),s>=n){g.debug("Download complete"),this.state=0;break}}catch(c){return g.error("Error during download:",c),this.state=0,null}}return g.debug("Successfully downloaded samples"),Promise.resolve(Ve(t))}_payloadUploadEncode(e){g.debug(`Encoding payload: len=${e.len}, off=${e.off}, data=${e.data.byteLength} bytes`);const t=e.len&255,s=e.len>>8&255,n=e.len>>16&255,i=e.len>>24&255,a=e.off&255,c=e.off>>8&255,o=e.off>>16&255,m=e.off>>24&255;return new Uint8Array([t,s,n,i,a,c,o,m,...e.data])}_payloadDownloadEncode(e){g.debug(`Encoding payload: off=${e.off}`);const t=e.off&255,s=e.off>>8&255,n=e.off>>16&255,i=e.off>>24&255;return new Uint8Array([t,s,n,i])}}/**
 * @license
 * Copyright 2019 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */const F=globalThis,ne=F.ShadowRoot&&(F.ShadyCSS===void 0||F.ShadyCSS.nativeShadow)&&"adoptedStyleSheets"in Document.prototype&&"replace"in CSSStyleSheet.prototype,Ee=Symbol(),le=new WeakMap;let He=class{constructor(e,t,s){if(this._$cssResult$=!0,s!==Ee)throw Error("CSSResult is not constructable. Use `unsafeCSS` or `css` instead.");this.cssText=e,this.t=t}get styleSheet(){let e=this.o;const t=this.t;if(ne&&e===void 0){const s=t!==void 0&&t.length===1;s&&(e=le.get(t)),e===void 0&&((this.o=e=new CSSStyleSheet).replaceSync(this.cssText),s&&le.set(t,e))}return e}toString(){return this.cssText}};const Ge=r=>new He(typeof r=="string"?r:r+"",void 0,Ee),We=(r,e)=>{if(ne)r.adoptedStyleSheets=e.map(t=>t instanceof CSSStyleSheet?t:t.styleSheet);else for(const t of e){const s=document.createElement("style"),n=F.litNonce;n!==void 0&&s.setAttribute("nonce",n),s.textContent=t.cssText,r.appendChild(s)}},de=ne?r=>r:r=>r instanceof CSSStyleSheet?(e=>{let t="";for(const s of e.cssRules)t+=s.cssText;return Ge(t)})(r):r;/**
 * @license
 * Copyright 2017 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */const{is:ze,defineProperty:Fe,getOwnPropertyDescriptor:je,getOwnPropertyNames:qe,getOwnPropertySymbols:Xe,getPrototypeOf:Ke}=Object,K=globalThis,ue=K.trustedTypes,Ze=ue?ue.emptyScript:"",Ye=K.reactiveElementPolyfillSupport,G=(r,e)=>r,te={toAttribute(r,e){switch(e){case Boolean:r=r?Ze:null;break;case Object:case Array:r=r==null?r:JSON.stringify(r)}return r},fromAttribute(r,e){let t=r;switch(e){case Boolean:t=r!==null;break;case Number:t=r===null?null:Number(r);break;case Object:case Array:try{t=JSON.parse(r)}catch{t=null}}return t}},ve=(r,e)=>!ze(r,e),fe={attribute:!0,type:String,converter:te,reflect:!1,hasChanged:ve};Symbol.metadata??=Symbol("metadata"),K.litPropertyMetadata??=new WeakMap;class T extends HTMLElement{static addInitializer(e){this._$Ei(),(this.l??=[]).push(e)}static get observedAttributes(){return this.finalize(),this._$Eh&&[...this._$Eh.keys()]}static createProperty(e,t=fe){if(t.state&&(t.attribute=!1),this._$Ei(),this.elementProperties.set(e,t),!t.noAccessor){const s=Symbol(),n=this.getPropertyDescriptor(e,s,t);n!==void 0&&Fe(this.prototype,e,n)}}static getPropertyDescriptor(e,t,s){const{get:n,set:i}=je(this.prototype,e)??{get(){return this[t]},set(a){this[t]=a}};return{get(){return n?.call(this)},set(a){const c=n?.call(this);i.call(this,a),this.requestUpdate(e,c,s)},configurable:!0,enumerable:!0}}static getPropertyOptions(e){return this.elementProperties.get(e)??fe}static _$Ei(){if(this.hasOwnProperty(G("elementProperties")))return;const e=Ke(this);e.finalize(),e.l!==void 0&&(this.l=[...e.l]),this.elementProperties=new Map(e.elementProperties)}static finalize(){if(this.hasOwnProperty(G("finalized")))return;if(this.finalized=!0,this._$Ei(),this.hasOwnProperty(G("properties"))){const t=this.properties,s=[...qe(t),...Xe(t)];for(const n of s)this.createProperty(n,t[n])}const e=this[Symbol.metadata];if(e!==null){const t=litPropertyMetadata.get(e);if(t!==void 0)for(const[s,n]of t)this.elementProperties.set(s,n)}this._$Eh=new Map;for(const[t,s]of this.elementProperties){const n=this._$Eu(t,s);n!==void 0&&this._$Eh.set(n,t)}this.elementStyles=this.finalizeStyles(this.styles)}static finalizeStyles(e){const t=[];if(Array.isArray(e)){const s=new Set(e.flat(1/0).reverse());for(const n of s)t.unshift(de(n))}else e!==void 0&&t.push(de(e));return t}static _$Eu(e,t){const s=t.attribute;return s===!1?void 0:typeof s=="string"?s:typeof e=="string"?e.toLowerCase():void 0}constructor(){super(),this._$Ep=void 0,this.isUpdatePending=!1,this.hasUpdated=!1,this._$Em=null,this._$Ev()}_$Ev(){this._$ES=new Promise(e=>this.enableUpdating=e),this._$AL=new Map,this._$E_(),this.requestUpdate(),this.constructor.l?.forEach(e=>e(this))}addController(e){(this._$EO??=new Set).add(e),this.renderRoot!==void 0&&this.isConnected&&e.hostConnected?.()}removeController(e){this._$EO?.delete(e)}_$E_(){const e=new Map,t=this.constructor.elementProperties;for(const s of t.keys())this.hasOwnProperty(s)&&(e.set(s,this[s]),delete this[s]);e.size>0&&(this._$Ep=e)}createRenderRoot(){const e=this.shadowRoot??this.attachShadow(this.constructor.shadowRootOptions);return We(e,this.constructor.elementStyles),e}connectedCallback(){this.renderRoot??=this.createRenderRoot(),this.enableUpdating(!0),this._$EO?.forEach(e=>e.hostConnected?.())}enableUpdating(e){}disconnectedCallback(){this._$EO?.forEach(e=>e.hostDisconnected?.())}attributeChangedCallback(e,t,s){this._$AK(e,s)}_$EC(e,t){const s=this.constructor.elementProperties.get(e),n=this.constructor._$Eu(e,s);if(n!==void 0&&s.reflect===!0){const i=(s.converter?.toAttribute!==void 0?s.converter:te).toAttribute(t,s.type);this._$Em=e,i==null?this.removeAttribute(n):this.setAttribute(n,i),this._$Em=null}}_$AK(e,t){const s=this.constructor,n=s._$Eh.get(e);if(n!==void 0&&this._$Em!==n){const i=s.getPropertyOptions(n),a=typeof i.converter=="function"?{fromAttribute:i.converter}:i.converter?.fromAttribute!==void 0?i.converter:te;this._$Em=n,this[n]=a.fromAttribute(t,i.type),this._$Em=null}}requestUpdate(e,t,s){if(e!==void 0){if(s??=this.constructor.getPropertyOptions(e),!(s.hasChanged??ve)(this[e],t))return;this.P(e,t,s)}this.isUpdatePending===!1&&(this._$ES=this._$ET())}P(e,t,s){this._$AL.has(e)||this._$AL.set(e,t),s.reflect===!0&&this._$Em!==e&&(this._$Ej??=new Set).add(e)}async _$ET(){this.isUpdatePending=!0;try{await this._$ES}catch(t){Promise.reject(t)}const e=this.scheduleUpdate();return e!=null&&await e,!this.isUpdatePending}scheduleUpdate(){return this.performUpdate()}performUpdate(){if(!this.isUpdatePending)return;if(!this.hasUpdated){if(this.renderRoot??=this.createRenderRoot(),this._$Ep){for(const[n,i]of this._$Ep)this[n]=i;this._$Ep=void 0}const s=this.constructor.elementProperties;if(s.size>0)for(const[n,i]of s)i.wrapped!==!0||this._$AL.has(n)||this[n]===void 0||this.P(n,this[n],i)}let e=!1;const t=this._$AL;try{e=this.shouldUpdate(t),e?(this.willUpdate(t),this._$EO?.forEach(s=>s.hostUpdate?.()),this.update(t)):this._$EU()}catch(s){throw e=!1,this._$EU(),s}e&&this._$AE(t)}willUpdate(e){}_$AE(e){this._$EO?.forEach(t=>t.hostUpdated?.()),this.hasUpdated||(this.hasUpdated=!0,this.firstUpdated(e)),this.updated(e)}_$EU(){this._$AL=new Map,this.isUpdatePending=!1}get updateComplete(){return this.getUpdateComplete()}getUpdateComplete(){return this._$ES}shouldUpdate(e){return!0}update(e){this._$Ej&&=this._$Ej.forEach(t=>this._$EC(t,this[t])),this._$EU()}updated(e){}firstUpdated(e){}}T.elementStyles=[],T.shadowRootOptions={mode:"open"},T[G("elementProperties")]=new Map,T[G("finalized")]=new Map,Ye?.({ReactiveElement:T}),(K.reactiveElementVersions??=[]).push("2.0.4");/**
 * @license
 * Copyright 2017 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */class W extends T{constructor(){super(...arguments),this.renderOptions={host:this},this.o=void 0}createRenderRoot(){const e=super.createRenderRoot();return this.renderOptions.renderBefore??=e.firstChild,e}update(e){const t=this.render();this.hasUpdated||(this.renderOptions.isConnected=this.isConnected),super.update(e),this.o=Pe(t,this.renderRoot,this.renderOptions)}connectedCallback(){super.connectedCallback(),this.o?.setConnected(!0)}disconnectedCallback(){super.disconnectedCallback(),this.o?.setConnected(!1)}render(){return Re}}W._$litElement$=!0,W.finalized=!0,globalThis.litElementHydrateSupport?.({LitElement:W});const Qe=globalThis.litElementPolyfillSupport;Qe?.({LitElement:W});(globalThis.litElementVersions??=[]).push("4.1.0");/**
 * @license
 * Copyright 2017 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */const Je=r=>(e,t)=>{t!==void 0?t.addInitializer(()=>{customElements.define(r,e)}):customElements.define(r,e)};/**
 * @license
 * Copyright 2017 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */const et=(r,e,t)=>(t.configurable=!0,t.enumerable=!0,Reflect.decorate&&typeof e!="object"&&Object.defineProperty(r,e,t),t);/**
 * @license
 * Copyright 2021 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */function tt(r){return(e,t)=>{const{slot:s,selector:n}=r??{},i="slot"+(s?`[name=${s}]`:":not([name])");return et(e,t,{get(){const a=this.renderRoot?.querySelector(i),c=a?.assignedElements(r)??[];return n===void 0?c:c.filter(o=>o.matches(n))}})}}var st=Object.defineProperty,nt=Object.getOwnPropertyDescriptor,be=(r,e,t,s)=>{for(var n=s>1?void 0:s?nt(e,t):e,i=r.length-1,a;i>=0;i--)(a=r[i])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&st(e,t,n),n};let q=class extends W{constructor(){super(...arguments),this.callbacks={show:{},hide:{}}}static get ready(){return customElements.whenDefined("my-scene")}set(r){this.views.forEach(e=>{const t=e.getAttribute("name");if(t)if(t==r){if(e.hasAttribute("active"))return;this.callbacks.show[r]?.(),e.setAttribute("active","")}else e.hasAttribute("active")&&(e.removeAttribute("active"),this.callbacks.hide[t]?.())})}get(){return this.views.find(r=>r.hasAttribute("active"))?.getAttribute("name")}on(r,e,t){this.callbacks[r][e]=t}render(){return $e`<slot></slot>`}};be([tt({slot:""})],q.prototype,"views",2);q=be([Je("my-scene")],q);const rt=q;function it(){const r=navigator.userAgent;return r.indexOf("Win")!==-1?"Windows":r.indexOf("Mac")!==-1&&r.indexOf("iPhone")===-1&&r.indexOf("iPad")===-1?"MacOS":r.indexOf("Linux")!==-1&&r.indexOf("Android")===-1?"Linux":/Android/i.test(r)?"Android":/iPhone|iPad|iPod/i.test(r)?"iOS":"Unknown"}function S(r){return r.startsWith("#")?document.getElementById(r.slice(1)):document.querySelectorAll(r)}const ot=S("#connect-problem-note"),at=S("#browser-support-note"),x=S("#button-connect"),ct=S(".button-disconnect"),ht=S("#device-name"),re=S("#device-connection-status"),lt=S(".update-version-device"),dt=S(".update-buttons"),Q=S("#upload-status"),ye=S("#changelog"),pe=S("#show-advanced"),ut=S("#upload-samples"),ft=S("#upload-samples-status"),we="MONKEY",D=new Me,se=new Ce(D),pt=new ke(D);let X=!1,_e=null,R=null,L=null;const Se=document.getElementById("scene-main"),ge=document.getElementById("scene-bluetooth"),me=document.getElementById("scene-utility-tools"),B=document.getElementById("scene-updater");rt.ready.then(()=>{if(navigator&&navigator.bluetooth&&navigator.bluetooth.getAvailability())ge.set("available");else{const r={MacOS:"On <u>macOS</u> we recommend to use Chrome or a Chrome based browser.",Windows:"On <u>Windows</u> we recommend to use Chrome or a Chrome based browser.",Linux:"On <u>Linux</u> we recommend to use Chrome or a Chrome based browser.",Android:"On <u>Android</u> we recommend to use Chrome or a Chrome based browser.",iOS:"On iPhone and iPad you can use a browser named <u>Bluefy</u>.",Unknown:"We recommend to use Chrome or a Chrome based browser."},e=it();at.innerHTML=r[e],ge.set("unavailable")}});D.onDeviceSelection=()=>{x.disabled=!0};D.onDeviceSelectionCancel=()=>{x.disabled=!1,ot.classList.remove("hidden")};D.onConnecting=()=>{x.disabled=!0,x.innerText="Connecting..."};D.onConnect=()=>{re.style.backgroundColor="#45C367",ht.innerText=D.name,Ue(),mt(),Se.set("connected")};const gt=x.innerText;D.onDisconnect=()=>{x.disabled=!1,x.innerText=gt,Se.set("disconnected"),ye.innerHTML=""};D.onConnectionLoss=()=>re.style.backgroundColor="#E89209";D.onConnectionReestablished=async()=>{re.style.backgroundColor="#45C367",_e?.(null),B.get()!="updating"&&Ue()};function Ae(){const r=window.location.hash;document.querySelectorAll("nav a").forEach(t=>{t.removeAttribute("active")});const e=document.querySelector(`nav a[href="${r}"]`);e&&e.setAttribute("active",""),r==="#device-update"?me.set("device-update"):r==="#sample-manager"&&me.set("sample-manager")}Ae();window.addEventListener("hashchange",Ae);x.addEventListener("click",async()=>{let e=[{namePrefix:"WAVY MONKEY",services:["03B80E5A-EDE8-4B33-A751-6CE34EC4C700".toLowerCase()]}];await D.connect(e)});ct.forEach(r=>{r.addEventListener("click",async()=>{D.disconnect()})});pe.addEventListener("change",()=>{X=pe.checked,Z()});dt.forEach(r=>{r.addEventListener("click",Et)});ut.addEventListener("click",vt);async function mt(){const e=await(await fetch(`/firmware/${we}/changelog.md`)).text();R=Te(e),console.log(R),Z()}async function Ue(){L=await se.getFirmwareVersion(),Z()}function Z(){if(!L||!R)return;lt.forEach(i=>{i.innerText=L.versionString}),S(".update-version-to").forEach(i=>{i.innerText=X&&j(R.dev,R.release)?R.dev.versionString+" [BETA]":R.release.versionString});let e=!1,t=!0,s=!1,n="";R.versions.forEach(i=>{if(i.isDev&&!X||i.isObsolete)return;const a=j(L,i.version),c=L.versionString===i.version.versionString;a&&(e=!0),(a||c)&&(t=!1),!a&&s&&(n+='<hr width="100%" />'),s=a,n+=`
            <div class="changelog-item" style="${i.isDev?"background-color: #eee;":""}"" ${a?"new":""}>
                <p><b>${i.version.versionString}${i.highlight?" "+i.highlight:""}${i.isDev?" [BETA]":""}</b><span><i>${i.date??""}</i></span></p>
                ${i.changes.map(o=>`- ${o}<br/>`).join("")}
            </div>
        `}),ye.innerHTML=n,e?B.set("update-available"):t?B.set("downgrade-available"):B.set("updated")}async function Et(){try{const r=S("#update-stage-fetch"),e=S("#update-stage-uploading"),t=S("#update-stage-applying"),s=S("#update-stage-verifying"),n=S("#update-stage-done");r.removeAttribute("active"),e.removeAttribute("active"),t.removeAttribute("active"),s.removeAttribute("active"),n.removeAttribute("active"),r.removeAttribute("done"),e.removeAttribute("done"),t.removeAttribute("done"),s.removeAttribute("done"),n.removeAttribute("done"),Q.innerText="",B.set("updating"),r.setAttribute("active","");const i=X?R.dev.versionString:R.release.versionString,a=await fetch(`/firmware/${we}/app_update_${i}.bin`).then(o=>o.arrayBuffer());r.removeAttribute("active"),r.setAttribute("done",""),e.setAttribute("active",""),Q.innerText="(preparing)",await se.uploadImage(a,o=>{Q.innerText=`(${o}%)`}),e.removeAttribute("active"),e.setAttribute("done","");const c=new Promise((o,m)=>_e=o);if(t.setAttribute("active",""),await c,t.removeAttribute("active"),t.setAttribute("done",""),s.setAttribute("active",""),L=await se.getFirmwareVersion(),L.versionString!=i)throw new Error(`Update failed: Device firmware version is ${L.versionString} but expected ${i}`);s.removeAttribute("active"),s.setAttribute("done",""),n.setAttribute("done",""),await new Promise((o,m)=>setTimeout(o,2e3)),Z()}catch(r){console.error(r),B.set("update-available")}}async function vt(){try{pt.uploadSamples(Be(),r=>ft.innerHTML=`${r}%`)}catch{}}
