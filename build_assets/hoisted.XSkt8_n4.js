var j=5960464477539063e-23,P=4294967296,$=9007199254740992;function J(g){var e=new ArrayBuffer(256),r=new DataView(e),n,o=0;function l(t){for(var a=e.byteLength,s=o+t;a<s;)a<<=1;if(a!==e.byteLength){var i=r;e=new ArrayBuffer(a),r=new DataView(e);for(var h=o+3>>2,c=0;c<h;++c)r.setUint32(c<<2,i.getUint32(c<<2))}return n=t,r}function d(){o+=n}function m(t){d(l(8).setFloat64(o,t))}function _(t){d(l(1).setUint8(o,t))}function I(t){for(var a=l(t.length),s=0;s<t.length;++s)a.setUint8(o+s,t[s]);d()}function u(t){d(l(2).setUint16(o,t))}function E(t){d(l(4).setUint32(o,t))}function x(t){var a=t%P,s=(t-a)/P,i=l(8);i.setUint32(o,s),i.setUint32(o+4,a),d()}function b(t,a){a<24?_(t<<5|a):a<256?(_(t<<5|24),_(a)):a<65536?(_(t<<5|25),u(a)):a<4294967296?(_(t<<5|26),E(a)):(_(t<<5|27),x(a))}function U(t){var a;if(t===!1)return _(244);if(t===!0)return _(245);if(t===null)return _(246);if(t===void 0)return _(247);switch(typeof t){case"number":if(Math.floor(t)===t){if(0<=t&&t<=$)return b(0,t);if(-$<=t&&t<0)return b(1,-(t+1))}return _(251),m(t);case"string":var s=[];for(a=0;a<t.length;++a){var i=t.charCodeAt(a);i<128?s.push(i):i<2048?(s.push(192|i>>6),s.push(128|i&63)):i<55296?(s.push(224|i>>12),s.push(128|i>>6&63),s.push(128|i&63)):(i=(i&1023)<<10,i|=t.charCodeAt(++a)&1023,i+=65536,s.push(240|i>>18),s.push(128|i>>12&63),s.push(128|i>>6&63),s.push(128|i&63))}return b(3,s.length),I(s);default:var h;if(Array.isArray(t))for(h=t.length,b(4,h),a=0;a<h;++a)U(t[a]);else if(t instanceof Uint8Array)b(2,t.length),I(t);else{var c=Object.keys(t);for(h=c.length,b(5,h),a=0;a<h;++a){var f=c[a];U(f),U(t[f])}}}}if(U(g),"slice"in e)return e.slice(0,o);for(var C=new ArrayBuffer(o),k=new DataView(C),y=0;y<o;++y)k.setUint8(y,r.getUint8(y));return C}function Q(g,e,r){var n=new DataView(g),o=0;typeof e!="function"&&(e=function(s){return s}),typeof r!="function"&&(r=function(){});function l(s,i){return o+=s,i}function d(s){return l(s,new Uint8Array(g,o,s))}function m(){var s=new ArrayBuffer(4),i=new DataView(s),h=E(),c=h&32768,f=h&31744,v=h&1023;if(f===31744)f=261120;else if(f!==0)f+=114688;else if(v!==0)return(c?-1:1)*v*j;return i.setUint32(0,c<<16|f<<13|v<<13),i.getFloat32(0)}function _(){return l(4,n.getFloat32(o))}function I(){return l(8,n.getFloat64(o))}function u(){return l(1,n.getUint8(o))}function E(){return l(2,n.getUint16(o))}function x(){return l(4,n.getUint32(o))}function b(){return x()*P+x()}function U(){return n.getUint8(o)!==255?!1:(o+=1,!0)}function C(s){if(s<24)return s;if(s===24)return u();if(s===25)return E();if(s===26)return x();if(s===27)return b();if(s===31)return-1;throw"Invalid length encoding"}function k(s){var i=u();if(i===255)return-1;var h=C(i&31);if(h<0||i>>5!==s)throw"Invalid indefinite length element";return h}function y(s,i){for(var h=0;h<i;++h){var c=u();c&128&&(c<224?(c=(c&31)<<6|u()&63,i-=1):c<240?(c=(c&15)<<12|(u()&63)<<6|u()&63,i-=2):(c=(c&15)<<18|(u()&63)<<12|(u()&63)<<6|u()&63,i-=3)),c<65536?s.push(c):(c-=65536,s.push(55296|c>>10),s.push(56320|c&1023))}}function t(){var s=u(),i=s>>5,h=s&31,c,f;if(i===7)switch(h){case 25:return m();case 26:return _();case 27:return I()}if(f=C(h),f<0&&(i<2||6<i))throw"Invalid length";switch(i){case 0:return f;case 1:return-1-f;case 2:if(f<0){for(var v=[],G=0;(f=k(i))>=0;)G+=f,v.push(d(f));var q=new Uint8Array(G),N=0;for(c=0;c<v.length;++c)q.set(v[c],N),N+=v[c].length;return q}return d(f);case 3:var L=[];if(f<0)for(;(f=k(i))>=0;)y(L,f);else y(L,f);return String.fromCharCode.apply(null,L);case 4:var M;if(f<0)for(M=[];!U();)M.push(t());else for(M=new Array(f),c=0;c<f;++c)M[c]=t();return M;case 5:var H={};for(c=0;c<f||f<0&&!U();++c){var Y=t();H[Y]=t()}return H;case 6:return e(t(),f);case 7:switch(f){case 20:return!1;case 21:return!0;case 22:return null;case 23:return;default:return r(f)}}}var a=t();if(o!==g.byteLength)throw"Remaining bytes";return a}const O={encode:J,decode:Q},A={READ:0,READ_RSP:1,WRITE:2,WRITE_RSP:3},w={OS:0,IMAGE:1,STAT:2,CONFIG:3,LOG:4,CRASH:5,SPLIT:6,RUN:7,FS:8,SHELL:9},R={ECHO:0,CONS_ECHO_CTRL:1,TASKSTAT:2,MPSTAT:3,DATETIME_STR:4,RESET:5},S={STATE:0,UPLOAD:1,FILE:2,CORELIST:3,CORELOAD:4,ERASE:5};class X{constructor(e={}){this.SMP_SERVICE_UUID="8d53dc1d-1db7-4cd3-868b-8a527460aa84",this.SMP_CHARACTERISTIC_UUID="da2e7828-fbce-4e01-ae9e-261174997c48",this._mtu=140,this._device=null,this._service=null,this._characteristic=null,this._connectCallback=null,this._connectingCallback=null,this._disconnectCallback=null,this._connectionLossCallback=null,this._messageCallback=null,this._imageUploadProgressCallback=null,this._uploadIsInProgress=!1,this._buffer=new Uint8Array,this._logger=e.logger||{info:console.log,error:console.error},this._seq=0,this._userRequestedDisconnect=!1}async _requestDevice(e){const r={acceptAllDevices:!1,optionalServices:[this.SMP_SERVICE_UUID]};return e&&(r.filters=e,r.acceptAllDevices=!1),navigator.bluetooth.requestDevice(r)}async connect(e){try{this._device=await this._requestDevice(e),this._logger.info(`Connecting to device ${this.name}...`),this._device.addEventListener("gattserverdisconnected",async r=>{this._logger.info(r),this._userRequestedDisconnect===!1?(this._logger.info("Trying to reconnect"),await new Promise(n=>setTimeout(n,1e3)),this._connectionLossCallback&&this._connectionLossCallback(),await this._connect()):this._disconnected()}),await this._connect()}catch(r){this._logger.error(r),await this._disconnected();return}}async _connect(){try{this._connectingCallback&&this._connectingCallback();const e=await this._device.gatt.connect();this._logger.info("Server connected."),this._service=await e.getPrimaryService(this.SMP_SERVICE_UUID),this._logger.info("Service connected."),this._characteristic=await this._service.getCharacteristic(this.SMP_CHARACTERISTIC_UUID),this._characteristic.addEventListener("characteristicvaluechanged",this._notification.bind(this)),await this._characteristic.startNotifications(),await this._connected(),this._uploadIsInProgress&&this._uploadNext()}catch(e){this._logger.error(e),await this._disconnected()}}disconnect(){return this._userRequestedDisconnect=!0,this._device.gatt.disconnect()}onConnecting(e){return this._connectingCallback=e,this}onConnect(e){return this._connectCallback=e,this}onDisconnect(e){return this._disconnectCallback=e,this}onConnectionLoss(e){return this._connectionLossCallback=e,this}onMessage(e){return this._messageCallback=e,this}onImageUploadProgress(e){return this._imageUploadProgressCallback=e,this}onImageUploadFinished(e){return this._imageUploadFinishedCallback=e,this}async _connected(){this._connectCallback&&this._connectCallback()}async _disconnected(){this._logger.info("Disconnected."),this._disconnectCallback&&this._disconnectCallback(),this._device=null,this._service=null,this._characteristic=null,this._uploadIsInProgress=!1,this._userRequestedDisconnect=!1}get name(){return this._device&&this._device.name}async _sendMessage(e,r,n,o){let d=[];typeof o<"u"&&(d=[...new Uint8Array(O.encode(o))]);const m=d.length&255,_=d.length>>8,I=r&255,u=r>>8,E=[e,0,_,m,u,I,this._seq,n,...d];await this._characteristic.writeValueWithoutResponse(Uint8Array.from(E)),this._seq=(this._seq+1)%256}_notification(e){const r=new Uint8Array(e.target.value.buffer);this._buffer=new Uint8Array([...this._buffer,...r]);const n=this._buffer[2]*256+this._buffer[3];this._buffer.length<n+8||(this._processMessage(this._buffer.slice(0,n+8)),this._buffer=this._buffer.slice(n+8))}_processMessage(e){const[r,n,o,l,d,m,_,I]=e,u=O.decode(e.slice(8).buffer),E=o*256+l,x=d*256+m;if(x===w.IMAGE&&I===S.UPLOAD&&(u.rc===0||u.rc===void 0)&&u.off){this._uploadOffset=u.off,this._uploadNext();return}this._messageCallback&&this._messageCallback({op:r,group:x,id:I,data:u,length:E})}cmdReset(){return this._sendMessage(A.WRITE,w.OS,R.RESET)}smpEcho(e){return this._sendMessage(A.WRITE,w.OS,R.ECHO,{d:e})}cmdImageState(){return this._sendMessage(A.READ,w.IMAGE,S.STATE)}cmdImageErase(){return this._sendMessage(A.WRITE,w.IMAGE,S.ERASE,{})}cmdImageTest(e){return this._sendMessage(A.WRITE,w.IMAGE,S.STATE,{hash:e,confirm:!1})}cmdImageConfirm(e){return this._sendMessage(A.WRITE,w.IMAGE,S.STATE,{hash:e,confirm:!0})}_hash(e){return crypto.subtle.digest("SHA-256",e)}async _uploadNext(){if(this._uploadOffset>=this._uploadImage.byteLength){this._uploadIsInProgress=!1,this._imageUploadFinishedCallback();return}const e=8,r={data:new Uint8Array,off:this._uploadOffset};this._uploadOffset===0&&(r.len=this._uploadImage.byteLength,r.sha=new Uint8Array(await this._hash(this._uploadImage))),this._imageUploadProgressCallback({percentage:Math.floor(this._uploadOffset/this._uploadImage.byteLength*100)});const n=this._mtu-O.encode(r).byteLength-e;r.data=new Uint8Array(this._uploadImage.slice(this._uploadOffset,this._uploadOffset+n)),this._uploadOffset+=n,this._sendMessage(A.WRITE,w.IMAGE,S.UPLOAD,r)}async cmdUpload(e,r=0){if(this._uploadIsInProgress){this._logger.error("Upload is already in progress.");return}this._uploadIsInProgress=!0,this._uploadOffset=0,this._uploadImage=e,this._uploadSlot=r,this._uploadNext()}async imageInfo(e){const r={},n=new Uint8Array(e);if(n.length<32)throw new Error("Invalid image (too short file)");if(n[0]!==61||n[1]!==184||n[2]!==243||n[3]!==150)throw new Error("Invalid image (wrong magic bytes)");if(n[4]!==0||n[5]!==0||n[6]!==0||n[7]!==0)throw new Error("Invalid image (wrong load address)");const o=n[8]+n[9]*2**8;if(n[10]!==0||n[11]!==0)throw new Error("Invalid image (wrong protected TLV area size)");const l=n[12]+n[13]*2**8+n[14]*2**16+n[15]*2**24;if(r.imageSize=l,n.length<l+o)throw new Error("Invalid image (wrong image size)");if(n[16]!==0||n[17]!==0||n[18]!==0||n[19]!==0)throw new Error("Invalid image (wrong flags)");const d=`${n[20]}.${n[21]}.${n[22]+n[23]*2**8}`;return r.version=d,r.hash=[...new Uint8Array(await this._hash(e.slice(0,l+32)))].map(m=>m.toString(16).padStart(2,"0")).join(""),r}}class B{constructor(e){this.current=e,this.current!==void 0&&(document.getElementById(this.current).style.display="block")}set(e){this.current!==void 0&&document.getElementById(this.current).style.removeProperty("display"),this.current=e,this.current!==void 0&&(document.getElementById(this.current).style.display="block")}get(){return this.current}}const V="MONKEY",F="r2",K={MONKEY:{r1:"0.6.1",r2:"0.6.2"}},W=new B("initial-screen"),z=new B,T=new B("update-waiting-screen"),D=document.getElementById("button-connect"),Z=document.getElementById("button-disconnect"),ee=document.getElementById("device-name"),te=document.getElementById("device-fw-version"),ne=document.getElementById("latest-fw-version"),se=document.getElementById("update-button"),ie=document.getElementById("upload-status");navigator&&navigator.bluetooth&&navigator.bluetooth.getAvailability()?z.set("bt-available-screen"):z.set("bt-unavailable-screen");const p=new X;p.onConnecting(()=>{console.log("Connecting..."),D.disabled=!0,D.innerText="Connecting..."});p.onConnect(()=>{ee.innerText=p.name,p.cmdImageState(),ne.innerHTML=K[V][F],W.set("connected-screen")});p.onDisconnect(()=>{W.set("initial-screen"),D.disabled=!1,D.innerText="Find device"});p.onConnectionLoss(()=>{W.set("reconnect-screen")});p.onMessage(({op:g,group:e,id:r,data:n,length:o})=>{switch(e){case w.OS:switch(r){case R.ECHO:alert(n.r);break;case R.TASKSTAT:console.table(n.tasks);break;case R.MPSTAT:console.log(n);break}break;case w.IMAGE:switch(r){case S.STATE:n.images.forEach(l=>{l.active&&(te.innerHTML=l.version,l.version==K[V][F]?T.set("update-good-screen"):T.set("update-idle-screen"))});break}break;default:console.log("Unknown group");break}});p.onImageUploadProgress(({percentage:g})=>{g!=0&&T.get()!="update-uploading-screen"&&T.set("update-uploading-screen"),ie.innerText=`${g}%`});p.onImageUploadFinished(()=>{T.set("update-complete-screen")});D.addEventListener("click",async()=>{let e=[{namePrefix:"WAVY MONKEY",services:["03B80E5A-EDE8-4B33-A751-6CE34EC4C700".toLowerCase()]}];await p.connect(e)});Z.addEventListener("click",async()=>{p.disconnect()});se.addEventListener("click",async()=>{try{T.set("update-prepare-screen"),fetch(`/assets/firmware/${V}/${F}/app_update.bin`).then(g=>g.arrayBuffer()).then(g=>{p.cmdUpload(g)})}catch{T.set("update-idle-screen")}});
