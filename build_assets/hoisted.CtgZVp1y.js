import{Q as Le,R as Me,k as Ie}from"./lit-html.CzCPjovT.js";import"./hoisted.DvC32OUy.js";class A{static LEVEL_DEBUG=0;static LEVEL_INFO=1;static LEVEL_WARNING=2;static LEVEL_ERROR=3;static LEVEL_IMPORTANT=4;static#n="gray";static#r="white";static#i="yellow";static#o="red";static#a="blue";#s;#e;constructor(e,t){this.#s=e,this.#e=t}#t(e,t){if(typeof e=="object"){console.log(`%c${this.#s}: ⬇︎`,`color: ${t}`),console.log(e);return}console.log(`%c${this.#s}: ${e}`,`color: ${t}`)}debug(e){this.#e<=A.LEVEL_DEBUG&&this.#t(e,A.#n)}info(e){this.#e<=A.LEVEL_INFO&&this.#t(e,A.#r)}warning(e){this.#e<=A.LEVEL_WARNING&&this.#t(e,A.#i)}error(e){this.#e<=A.LEVEL_ERROR&&this.#t(e,A.#o)}important(e){this.#e<=A.LEVEL_IMPORTANT&&this.#t(e,A.#a)}}const xe=r=>crypto.subtle.digest("SHA-256",r);var Ce=5960464477539063e-23,ee=4294967296,de=9007199254740992;function Te(r){var e=new ArrayBuffer(256),t=new DataView(e),s,n=0;function i(l){for(var g=e.byteLength,h=n+l;g<h;)g<<=1;if(g!==e.byteLength){var d=t;e=new ArrayBuffer(g),t=new DataView(e);for(var w=n+3>>2,f=0;f<w;++f)t.setUint32(f<<2,d.getUint32(f<<2))}return s=l,t}function a(){n+=s}function c(l){a(i(8).setFloat64(n,l))}function o(l){a(i(1).setUint8(n,l))}function m(l){for(var g=i(l.length),h=0;h<l.length;++h)g.setUint8(n+h,l[h]);a()}function u(l){a(i(2).setUint16(n,l))}function y(l){a(i(4).setUint32(n,l))}function v(l){var g=l%ee,h=(l-g)/ee,d=i(8);d.setUint32(n,h),d.setUint32(n+4,g),a()}function b(l,g){g<24?o(l<<5|g):g<256?(o(l<<5|24),o(g)):g<65536?(o(l<<5|25),u(g)):g<4294967296?(o(l<<5|26),y(g)):(o(l<<5|27),v(g))}function _(l){var g;if(l===!1)return o(244);if(l===!0)return o(245);if(l===null)return o(246);if(l===void 0)return o(247);switch(typeof l){case"number":if(Math.floor(l)===l){if(0<=l&&l<=de)return b(0,l);if(-de<=l&&l<0)return b(1,-(l+1))}return o(251),c(l);case"string":var h=[];for(g=0;g<l.length;++g){var d=l.charCodeAt(g);d<128?h.push(d):d<2048?(h.push(192|d>>6),h.push(128|d&63)):d<55296?(h.push(224|d>>12),h.push(128|d>>6&63),h.push(128|d&63)):(d=(d&1023)<<10,d|=l.charCodeAt(++g)&1023,d+=65536,h.push(240|d>>18),h.push(128|d>>12&63),h.push(128|d>>6&63),h.push(128|d&63))}return b(3,h.length),m(h);default:var w;if(Array.isArray(l))for(w=l.length,b(4,w),g=0;g<w;++g)_(l[g]);else if(l instanceof Uint8Array)b(2,l.length),m(l);else{var f=Object.keys(l);for(w=f.length,b(5,w),g=0;g<w;++g){var E=f[g];_(E),_(l[E])}}}}if(_(r),"slice"in e)return e.slice(0,n);for(var D=new ArrayBuffer(n),$=new DataView(D),I=0;I<n;++I)$.setUint8(I,t.getUint8(I));return D}function Ne(r,e,t){var s=new DataView(r),n=0;typeof e!="function"&&(e=function(h){return h}),typeof t!="function"&&(t=function(){});function i(h,d){return n+=h,d}function a(h){return i(h,new Uint8Array(r,n,h))}function c(){var h=new ArrayBuffer(4),d=new DataView(h),w=y(),f=w&32768,E=w&31744,O=w&1023;if(E===31744)E=261120;else if(E!==0)E+=114688;else if(O!==0)return(f?-1:1)*O*Ce;return d.setUint32(0,f<<16|E<<13|O<<13),d.getFloat32(0)}function o(){return i(4,s.getFloat32(n))}function m(){return i(8,s.getFloat64(n))}function u(){return i(1,s.getUint8(n))}function y(){return i(2,s.getUint16(n))}function v(){return i(4,s.getUint32(n))}function b(){return v()*ee+v()}function _(){return s.getUint8(n)!==255?!1:(n+=1,!0)}function D(h){if(h<24)return h;if(h===24)return u();if(h===25)return y();if(h===26)return v();if(h===27)return b();if(h===31)return-1;throw"Invalid length encoding"}function $(h){var d=u();if(d===255)return-1;var w=D(d&31);if(w<0||d>>5!==h)throw"Invalid indefinite length element";return w}function I(h,d){for(var w=0;w<d;++w){var f=u();f&128&&(f<224?(f=(f&31)<<6|u()&63,d-=1):f<240?(f=(f&15)<<12|(u()&63)<<6|u()&63,d-=2):(f=(f&15)<<18|(u()&63)<<12|(u()&63)<<6|u()&63,d-=3)),f<65536?h.push(f):(f-=65536,h.push(55296|f>>10),h.push(56320|f&1023))}}function l(){var h=u(),d=h>>5,w=h&31,f,E;if(d===7)switch(w){case 25:return c();case 26:return o();case 27:return m()}if(E=D(w),E<0&&(d<2||6<d))throw"Invalid length";switch(d){case 0:return E;case 1:return-1-E;case 2:if(E<0){for(var O=[],ae=0;(E=$(d))>=0;)ae+=E,O.push(a(E));var ce=new Uint8Array(ae),le=0;for(f=0;f<O.length;++f)ce.set(O[f],le),le+=O[f].length;return ce}return a(E);case 3:var Y=[];if(E<0)for(;(E=$(d))>=0;)I(Y,E);else I(Y,E);return String.fromCharCode.apply(null,Y);case 4:var H;if(E<0)for(H=[];!_();)H.push(l());else for(H=new Array(E),f=0;f<E;++f)H[f]=l();return H;case 5:var he={};for(f=0;f<E||E<0&&!_();++f){var Oe=l();he[Oe]=l()}return he;case 6:return e(l(),E);case 7:switch(E){case 20:return!1;case 21:return!0;case 22:return null;case 23:return;default:return t(E)}}}var g=l();if(n!==r.byteLength)throw"Remaining bytes";return g}const te={encode:Te,decode:Ne};let P=new A("mcumgr",A.LEVEL_DEBUG);const N={EOK:0,EUNKNOWN:1,ENOMEM:2,EINVAL:3,ETIMEOUT:4,ENOENT:5,EBADSTATE:6,EMSGSIZE:7,ENOTSUP:8,ECORRUPT:9,EBUSY:10,EACCESSDENIED:11,UNSUPPORTED_TOO_OLD:12,UNSUPPORTED_TOO_NEW:13,EPERUSER:256},x={READ:0,READ_RSP:1,WRITE:2,WRITE_RSP:3};class ke{constructor(){this.device=null,this.service=null,this.characteristic=null,this.mtu=140,this.buffer=new Uint8Array([]),this.smpSequenceNumber=0,this.responseResolvers={},this.state={type:"disconnected"},this.onConnect=null,this.onDisconnect=null,this.onConnecting=null,this.onConnectionLoss=null,this.onConnectionReestablished=null,this.onDeviceSelection=null,this.onDeviceSelectionCancel=null,this.SMP_SERVICE_UUID="8d53dc1d-1db7-4cd3-868b-8a527460aa84",this.SMP_CHARACTERISTIC_UUID="da2e7828-fbce-4e01-ae9e-261174997c48",this.SMP_HEADER_SIZE=8,this.SMP_HEADER_OP_IDX=0,this.SMP_HEADER_FLAGS_IDX=1,this.SMP_HEADER_LEN_HI_IDX=2,this.SMP_HEADER_LEN_LO_IDX=3,this.SMP_HEADER_GROUP_HI_IDX=4,this.SMP_HEADER_GROUP_LO_IDX=5,this.SMP_HEADER_SEQ_IDX=6,this.SMP_HEADER_ID_IDX=7}async _requestDevice(e){const t={optionalServices:[this.SMP_SERVICE_UUID]};return e?t.filters=e:t.acceptAllDevices=!0,this.onDeviceSelection?.(),navigator.bluetooth.requestDevice(t)}async connect(e){if(this.state.type!=="disconnected"){console.warn("Already connecting or connected.");return}this.state={type:"selectingDevice"};try{this.device=await this._requestDevice(e),this.state={type:"connecting"},this.onConnecting?.(),console.debug(`Connecting to device ${this.device.name}...`),this.device.addEventListener("gattserverdisconnected",this._handleDisconnection.bind(this)),await this._connectDevice()}catch(t){t.name==="NotFoundError"?(console.debug("Device selection canceled."),this.state={type:"disconnected"},this.onDeviceSelectionCancel?.()):(console.error("Connection error:",t),await this._handleDisconnected())}}async _connectDevice(){if(!this.device){console.error("No device to connect to");return}try{const e=await this.device.gatt.connect();console.debug("Server connected. Awaiting SMP service..."),this.service=await e.getPrimaryService(this.SMP_SERVICE_UUID),console.debug("Service connected."),this.characteristic=await this.service.getCharacteristic(this.SMP_CHARACTERISTIC_UUID),this.characteristic.addEventListener("characteristicvaluechanged",this._notification.bind(this)),await this.characteristic.startNotifications(),(this.state.type==="connecting"||this.state.type==="connectionLoss")&&(this.state.type==="connectionLoss"?this.onConnectionReestablished?.():this.onConnect?.(),this.state={type:"connected"})}catch(e){console.error("Error during connection:",e),await this._handleDisconnected()}}disconnect(){if(this.state.type!=="connected"){console.warn("Cannot disconnect because not connected.");return}this.state={type:"disconnecting"},this.device&&this.device.gatt&&this.device.gatt.disconnect()}async _handleDisconnection(){console.debug("Device disconnected"),this.state.type==="connected"?(this.state={type:"connectionLoss"},this.onConnectionLoss?.(),await this._reconnect()):this.state.type==="disconnecting"&&await this._handleDisconnected()}async _reconnect(){try{await new Promise(e=>setTimeout(e,1e3)),await this._connectDevice()}catch(e){console.error("Reconnection error:",e)}}async _handleDisconnected(){this.state={type:"disconnected"},this.onDisconnect?.(),this.device=null,this.service=null,this.characteristic=null}get name(){return this.device?.name}get maxPayloadSize(){return this.mtu-3-this.SMP_HEADER_SIZE}_buildSMPMessage(e,t,s,n,i,a=new Uint8Array([])){const c=a.length,o=new Uint8Array(this.SMP_HEADER_SIZE);return o[this.SMP_HEADER_OP_IDX]=e,o[this.SMP_HEADER_FLAGS_IDX]=t,o[this.SMP_HEADER_LEN_HI_IDX]=c>>8&255,o[this.SMP_HEADER_LEN_LO_IDX]=c&255,o[this.SMP_HEADER_GROUP_HI_IDX]=s>>8&255,o[this.SMP_HEADER_GROUP_LO_IDX]=s&255,o[this.SMP_HEADER_SEQ_IDX]=n,o[this.SMP_HEADER_ID_IDX]=i,new Uint8Array([...o,...a])}async sendMessage(e,t,s,n=new Uint8Array([])){const i=this.smpSequenceNumber;this.smpSequenceNumber=(this.smpSequenceNumber+1)%256;const c=this._buildSMPMessage(e,0,t,i,s,n);return new Promise(async(o,m)=>{this.responseResolvers[i]={resolve:o,reject:m};try{if(!this.characteristic)throw P.debug("Characteristic not available"),new Error("Characteristic not available");await this.characteristic.writeValueWithoutResponse(c)}catch(u){P.dbg(`Failed to send bluetooth characteristic message: ${u}`),delete this.responseResolvers[i],m(u)}})}async _notification(e){const t=e.target;P.debug("Notification received"),P.debug(t.value);const s=new Uint8Array(t.value.buffer);for(this.buffer=new Uint8Array([...this.buffer,...s]);this.buffer.length>=this.SMP_HEADER_SIZE;){const n=this.buffer[2]<<8|this.buffer[3],i=this.SMP_HEADER_SIZE+n;if(this.buffer.length>=i){const a=this.buffer.slice(0,i);P.debug("Processing message"),P.debug(a),await this._processMessage(a),this.buffer=this.buffer.slice(i)}else break}}async _processMessage(e){const[t,s,n,i,a,c,o,m]=e.slice(0,this.SMP_HEADER_SIZE),u=e.slice(this.SMP_HEADER_SIZE);P.debug("payload"),P.debug(u);let y;try{y=te.decode(u.buffer)}catch(b){P.error("Error decoding CBOR:",b)}const v=this.responseResolvers[o];v?(v.resolve(y),delete this.responseResolvers[o]):P.warn(`No resolver found for sequence number ${o}`)}}let T=new A("img_mgr",A.LEVEL_DEBUG);const j=(r,e)=>{if(e.major>r.major)return!0;if(e.major===r.major){if(e.minor>r.minor)return!0;if(e.minor===r.minor&&e.revision>r.revision)return!0}return!1};class Ve{constructor(e){this.IMAGE_GROUP_ID=1,this.state=0,this.mcumgr=e}async uploadImage(e,t){if(this.state===1){T.error("Upload already in progress");return}this.state=1;let s=0,n=e.byteLength;try{let i=new Uint8Array(await xe(e));const a=this.mcumgr.maxPayloadSize;for(;s<n;){let c={off:s,data:new Uint8Array([])};s===0&&(T.debug("Starting image upload"),c.len=n,c.sha=i);let o=te.encode(c);const m=o.byteLength;T.debug(`maxPayloadSize: ${a}, initialPayloadLength: ${m}`);const u=a-m-20;if(u<=0)return T.error("MTU too small to send data"),this.state=0,!1;const y=Math.min(s+u,n),v=new Uint8Array(e.slice(s,y));c.data=v,o=te.encode(c),o.byteLength>a&&T.warn(`Payload too large: ${o.byteLength} > ${a}`);const b=await this.mcumgr.sendMessage(x.WRITE,this.IMAGE_GROUP_ID,1,new Uint8Array(o));if(b.rc!==void 0&&b.rc!==N.EOK)return this.state=0,!1;s=b.off,t?.(Math.floor(s/n*100))}return this.state=0,!0}catch(i){return T.error("Error during image upload:",i),this.state=0,!1}}async getFirmwareVersion(){const e=await this.mcumgr.sendMessage(x.READ,this.IMAGE_GROUP_ID,0);if(e.images===void 0||e.images.length===0)throw new Error("No image state found");const t=e.images.find(n=>n.active);if(!t)throw new Error("Device does not use Image Manager");const s=t.version.split(".").map(Number);return{versionString:t.version,major:s[0],minor:s[1],revision:s[2]}}}function Be(r){const e=r.split(`
`),t={release:null,dev:null,versions:[]};let s=null,n=!1;return e.forEach(i=>{if(i=i.trim(),i.startsWith("#")){const a=i.match(/# (\d+)\.(\d+)\.(\d+)(?:\[(.*?)\])?\s*(.*?)\s*((?:-\w+\s*)*)$/);if(a){const c=parseInt(a[1],10),o=parseInt(a[2],10),m=parseInt(a[3],10),u={versionString:`${c}.${o}.${m}`,major:c,minor:o,revision:m},y=a[4]?a[4].trim():null,v=a[5].trim(),_=a[6].trim().split(/\s+/).filter(Boolean),D=_.includes("-obsolete"),$=_.includes("-dev");D||((!t.dev||j(t.dev,u))&&(t.dev=u),$||(!t.release||j(t.release,u))&&(t.release=u)),n=m===0,s={version:u,isObsolete:D,isDev:$,highlight:v||null,date:y,summary:null,changes:[]},t.versions.push(s)}}else if(i.startsWith("-")){const a=i.substring(1).trim();s&&(s.changes.push(a),n=!1)}else i!==""&&s&&n&&s.version.revision===0&&(s.summary?s.summary+=`
`:s.summary="",s.summary+=i)}),t}const C=10,z=15;class V{constructor(){this.data=[]}push8(e){if(e<0||e>255)throw new RangeError(`Value ${e} is out of range for an 8-bit unsigned integer`);this.data.push(e&255)}push16(e){if(e<0||e>65535)throw new RangeError(`Value ${e} is out of range for a 16-bit unsigned integer`);this.data.push(e&255),this.data.push(e>>8&255)}push32(e){if(e<0||e>4294967295)throw new RangeError(`Value ${e} is out of range for a 32-bit unsigned integer`);this.data.push(e&255),this.data.push(e>>8&255),this.data.push(e>>16&255),this.data.push(e>>24&255)}pop8(){if(this.data.length<1)throw new RangeError("Attempted to pop from an empty array");return this.data.shift()}pop16(){if(this.data.length<2)throw new RangeError("Not enough data to pop 16 bits");const e=this.data.shift(),t=this.data.shift();return e|t<<8}pop32(){if(this.data.length<4)throw new RangeError("Not enough data to pop 32 bits");const e=this.data.shift(),t=this.data.shift(),s=this.data.shift(),n=this.data.shift();return(e|t<<8|s<<16|n<<24)>>>0}add(e){this.data.push(...e.data)}static from(e){const t=new V;return t.data=Array.from(e),t}}function He(r){let e=new V;e.push32(r.reserved0),e.push32(r.reserved1),e.push32(r.reserved2),e.push32(r.reserved3);for(let n=0;n<C;n++)e.push16(r.pages[n].id);let t=new V,s=new V;for(let n=0;n<C;n++){let i=r.pages[n];for(let a=0;a<z;a++){let c=i.loops[a];if(c==null){t.push16(65535);continue}t.push16(s.data.length),s.push8(c.length_beats),s.push8(c.events.length);for(const o of c.events){const[m,u]=o;s.push8(u.note&127);const y=u.state<<7|u.velocity&127;s.push8(y),s.push16(m)}}}return e.add(t),e.add(s),Uint8Array.from(e.data)}function Ge(r){let e=V.from(r),t={reserved0:e.pop32(),reserved1:e.pop32(),reserved2:e.pop32(),reserved3:e.pop32(),pages:[]};for(let n=0;n<C;n++)t.pages.push({id:e.pop16(),loops:[]});let s=[];for(let n=0;n<C*z;n++)s.push(e.pop16()!==65535);for(let n=0;n<C;n++){let i=t.pages[n];for(let a=0;a<z;a++){if(s[n*C+a]==!1){i.loops.push(null);continue}let c={length_beats:e.pop8(),events:[]},o=e.pop8();for(let m=0;m<o;m++){let u=e.pop8()&127,y=e.pop8(),v=y>>7&1,b=y&127,_=e.pop16();c.events.push([_,{note:u,state:v,velocity:b}])}i.loops.push(c)}}return t}function We(){const r={note:36,velocity:100,state:1},e={note:36,velocity:100,state:0},t={note:38,velocity:100,state:1},s={note:38,velocity:100,state:0},n={note:42,velocity:100,state:1},i={note:42,velocity:100,state:0};function a(v){const b=[];for(const _ in v){const D=parseInt(_,10);for(const $ of v[D])b.push([D,$])}return b.sort((_,D)=>_[0]-D[0]),b}const c={length_beats:2,events:a({0:[r,n],6:[e,i],12:[n],18:[i],24:[r,t,n],30:[e,s,i],36:[n],42:[i]})},o={length_beats:1,events:a({0:[r],12:[t],24:[e,s]})},m=[],u={id:65278,loops:new Array(z).fill(null)};u.loops[0]=c,u.loops[1]=o,u.loops[2]=o,m.push(u);for(let v=1;v<C;v++){const b={id:65535,loops:new Array(z).fill(null)};m.push(b)}return{reserved0:4294967295,reserved1:4294967295,reserved2:4294967295,reserved3:4294967295,pages:m}}let p=new A("smpl_mgr",A.LEVEL_DEBUG);class ze{constructor(e){this.GROUP_ID=100,this.state=0,this.mcumgr=e}async isSet(){p.debug("Getting sample ID");const e=await this.mcumgr.sendMessage(x.READ,this.GROUP_ID,2);return e.rc!==void 0&&e.rc!==N.EOK?(p.error(`Error response received, rc: ${e.rc}`),Promise.reject(e.rc)):e.set}async getIDs(){p.debug("Getting sample ID");const e=await this.mcumgr.sendMessage(x.READ,this.GROUP_ID,0);if(e.rc!==void 0&&e.rc!==N.EOK)return p.error(`Error response received, rc: ${e.rc}`),Promise.reject(e.rc);const t=e;return p.debug(`Received sample IDs: ${t.ids}`),t.ids}async uploadSamples(e,t){if(p.debug("Starting sample upload process"),this.state!==0)return p.error("Cant start upload when not in idle state"),Promise.reject("Cant start upload when not in idle state");this.state=1;const s=this.mcumgr.maxPayloadSize,n=He(e),i=n.byteLength;let a=0;for(;this.state===1&&a<i;){p.debug(`Current offset: ${a}, Total length: ${i}`);let c={off:a,data:new Uint8Array([]),len:i},o=this._payloadUploadEncode(c);p.debug(`Initial payload size (without data): ${o.byteLength} bytes`);const m=s-o.byteLength-20;if(p.debug(`Max data size for this chunk: ${m} bytes`),m<=0)return p.error("MTU too small to send data"),this.state=0,!1;const u=Math.min(a+m,i),y=new Uint8Array(n.slice(a,u));if(p.debug(`Data chunk length: ${y.byteLength} bytes (from offset ${a} to ${u})`),c.data=y,o=this._payloadUploadEncode(c),p.debug(`Payload size after adding data: ${o.byteLength} bytes`),o.byteLength>s)return p.warn(`Payload too large: ${o.byteLength} > ${s}`),this.state=0,!1;try{p.debug("Sending payload to mcumgr");const v=await this.mcumgr.sendMessage(x.WRITE,this.GROUP_ID,1,o);if(p.debug("Received response from mcumgr"),v.rc!==void 0&&v.rc!==N.EOK)return p.error(`Error response received, rc: ${v.rc}`),this.state=0,!1;const b=v;p.debug(`Response success, new offset: ${b.off}`),a=b.off;const _=Math.floor(a/i*100);if(p.debug(`Upload progress: ${_}%`),t?.(_),a>=i){p.debug("Upload complete"),this.state=0;break}}catch(v){return p.error("Error during upload:",v),this.state=0,!1}}return p.debug("Successfully uploaded samples"),!0}async downloadSamples(e){if(p.debug("Starting sample download process"),this.state!==0)return p.error("Cant start download when not in idle state"),Promise.reject("Cant start download when not in idle state");this.state=2;let t=new Uint8Array([]),s=0,n=0,i={off:s},a=this._payloadDownloadEncode(i);try{const c=await this.mcumgr.sendMessage(x.READ,this.GROUP_ID,1,a);if(c.rc!==void 0&&c.rc!==N.EOK)return p.error(`Error response received, rc: ${c.rc}`),this.state=0,null;const o=c;if(p.debug(`Received first chunk, offset: ${o.off}, data length: ${o.data.byteLength}`),o.len===void 0)return p.error("Length not received in first chunk"),this.state=0,null;if(o.off!==s)return p.error("Invalid offset received in first chunk"),this.state=0,null;t=o.data,s=o.off+o.data.byteLength,n=o.len,e?.(Math.floor(s/n*100))}catch(c){return p.error("Error during download:",c),this.state=0,null}for(;s<n;){p.debug(`Current offset: ${s}, Total length: ${n}`),i={off:s},a=this._payloadDownloadEncode(i);try{const c=await this.mcumgr.sendMessage(x.READ,this.GROUP_ID,1,a);if(c.rc!==void 0&&c.rc!==N.EOK)return p.error(`Error response received, rc: ${c.rc}`),this.state=0,null;const o=c;if(p.debug(`Received chunk, offset: ${o.off}, data length: ${o.data.byteLength}`),t=new Uint8Array([...t,...o.data]),s=o.off+o.data.byteLength,e?.(Math.floor(s/n*100)),s>=n){p.debug("Download complete"),this.state=0;break}}catch(c){return p.error("Error during download:",c),this.state=0,null}}return p.debug("Successfully downloaded samples"),Promise.resolve(Ge(t))}_payloadUploadEncode(e){p.debug(`Encoding payload: len=${e.len}, off=${e.off}, data=${e.data.byteLength} bytes`);const t=e.len&255,s=e.len>>8&255,n=e.len>>16&255,i=e.len>>24&255,a=e.off&255,c=e.off>>8&255,o=e.off>>16&255,m=e.off>>24&255;return new Uint8Array([t,s,n,i,a,c,o,m,...e.data])}_payloadDownloadEncode(e){p.debug(`Encoding payload: off=${e.off}`);const t=e.off&255,s=e.off>>8&255,n=e.off>>16&255,i=e.off>>24&255;return new Uint8Array([t,s,n,i])}}/**
 * @license
 * Copyright 2019 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */const F=globalThis,ie=F.ShadowRoot&&(F.ShadyCSS===void 0||F.ShadyCSS.nativeShadow)&&"adoptedStyleSheets"in Document.prototype&&"replace"in CSSStyleSheet.prototype,ye=Symbol(),ue=new WeakMap;let Fe=class{constructor(e,t,s){if(this._$cssResult$=!0,s!==ye)throw Error("CSSResult is not constructable. Use `unsafeCSS` or `css` instead.");this.cssText=e,this.t=t}get styleSheet(){let e=this.o;const t=this.t;if(ie&&e===void 0){const s=t!==void 0&&t.length===1;s&&(e=ue.get(t)),e===void 0&&((this.o=e=new CSSStyleSheet).replaceSync(this.cssText),s&&ue.set(t,e))}return e}toString(){return this.cssText}};const je=r=>new Fe(typeof r=="string"?r:r+"",void 0,ye),qe=(r,e)=>{if(ie)r.adoptedStyleSheets=e.map(t=>t instanceof CSSStyleSheet?t:t.styleSheet);else for(const t of e){const s=document.createElement("style"),n=F.litNonce;n!==void 0&&s.setAttribute("nonce",n),s.textContent=t.cssText,r.appendChild(s)}},fe=ie?r=>r:r=>r instanceof CSSStyleSheet?(e=>{let t="";for(const s of e.cssRules)t+=s.cssText;return je(t)})(r):r;/**
 * @license
 * Copyright 2017 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */const{is:Xe,defineProperty:Ke,getOwnPropertyDescriptor:Ze,getOwnPropertyNames:Ye,getOwnPropertySymbols:Qe,getPrototypeOf:Je}=Object,K=globalThis,pe=K.trustedTypes,et=pe?pe.emptyScript:"",tt=K.reactiveElementPolyfillSupport,G=(r,e)=>r,se={toAttribute(r,e){switch(e){case Boolean:r=r?et:null;break;case Object:case Array:r=r==null?r:JSON.stringify(r)}return r},fromAttribute(r,e){let t=r;switch(e){case Boolean:t=r!==null;break;case Number:t=r===null?null:Number(r);break;case Object:case Array:try{t=JSON.parse(r)}catch{t=null}}return t}},_e=(r,e)=>!Xe(r,e),ge={attribute:!0,type:String,converter:se,reflect:!1,hasChanged:_e};Symbol.metadata??=Symbol("metadata"),K.litPropertyMetadata??=new WeakMap;class k extends HTMLElement{static addInitializer(e){this._$Ei(),(this.l??=[]).push(e)}static get observedAttributes(){return this.finalize(),this._$Eh&&[...this._$Eh.keys()]}static createProperty(e,t=ge){if(t.state&&(t.attribute=!1),this._$Ei(),this.elementProperties.set(e,t),!t.noAccessor){const s=Symbol(),n=this.getPropertyDescriptor(e,s,t);n!==void 0&&Ke(this.prototype,e,n)}}static getPropertyDescriptor(e,t,s){const{get:n,set:i}=Ze(this.prototype,e)??{get(){return this[t]},set(a){this[t]=a}};return{get(){return n?.call(this)},set(a){const c=n?.call(this);i.call(this,a),this.requestUpdate(e,c,s)},configurable:!0,enumerable:!0}}static getPropertyOptions(e){return this.elementProperties.get(e)??ge}static _$Ei(){if(this.hasOwnProperty(G("elementProperties")))return;const e=Je(this);e.finalize(),e.l!==void 0&&(this.l=[...e.l]),this.elementProperties=new Map(e.elementProperties)}static finalize(){if(this.hasOwnProperty(G("finalized")))return;if(this.finalized=!0,this._$Ei(),this.hasOwnProperty(G("properties"))){const t=this.properties,s=[...Ye(t),...Qe(t)];for(const n of s)this.createProperty(n,t[n])}const e=this[Symbol.metadata];if(e!==null){const t=litPropertyMetadata.get(e);if(t!==void 0)for(const[s,n]of t)this.elementProperties.set(s,n)}this._$Eh=new Map;for(const[t,s]of this.elementProperties){const n=this._$Eu(t,s);n!==void 0&&this._$Eh.set(n,t)}this.elementStyles=this.finalizeStyles(this.styles)}static finalizeStyles(e){const t=[];if(Array.isArray(e)){const s=new Set(e.flat(1/0).reverse());for(const n of s)t.unshift(fe(n))}else e!==void 0&&t.push(fe(e));return t}static _$Eu(e,t){const s=t.attribute;return s===!1?void 0:typeof s=="string"?s:typeof e=="string"?e.toLowerCase():void 0}constructor(){super(),this._$Ep=void 0,this.isUpdatePending=!1,this.hasUpdated=!1,this._$Em=null,this._$Ev()}_$Ev(){this._$ES=new Promise(e=>this.enableUpdating=e),this._$AL=new Map,this._$E_(),this.requestUpdate(),this.constructor.l?.forEach(e=>e(this))}addController(e){(this._$EO??=new Set).add(e),this.renderRoot!==void 0&&this.isConnected&&e.hostConnected?.()}removeController(e){this._$EO?.delete(e)}_$E_(){const e=new Map,t=this.constructor.elementProperties;for(const s of t.keys())this.hasOwnProperty(s)&&(e.set(s,this[s]),delete this[s]);e.size>0&&(this._$Ep=e)}createRenderRoot(){const e=this.shadowRoot??this.attachShadow(this.constructor.shadowRootOptions);return qe(e,this.constructor.elementStyles),e}connectedCallback(){this.renderRoot??=this.createRenderRoot(),this.enableUpdating(!0),this._$EO?.forEach(e=>e.hostConnected?.())}enableUpdating(e){}disconnectedCallback(){this._$EO?.forEach(e=>e.hostDisconnected?.())}attributeChangedCallback(e,t,s){this._$AK(e,s)}_$EC(e,t){const s=this.constructor.elementProperties.get(e),n=this.constructor._$Eu(e,s);if(n!==void 0&&s.reflect===!0){const i=(s.converter?.toAttribute!==void 0?s.converter:se).toAttribute(t,s.type);this._$Em=e,i==null?this.removeAttribute(n):this.setAttribute(n,i),this._$Em=null}}_$AK(e,t){const s=this.constructor,n=s._$Eh.get(e);if(n!==void 0&&this._$Em!==n){const i=s.getPropertyOptions(n),a=typeof i.converter=="function"?{fromAttribute:i.converter}:i.converter?.fromAttribute!==void 0?i.converter:se;this._$Em=n,this[n]=a.fromAttribute(t,i.type),this._$Em=null}}requestUpdate(e,t,s){if(e!==void 0){if(s??=this.constructor.getPropertyOptions(e),!(s.hasChanged??_e)(this[e],t))return;this.P(e,t,s)}this.isUpdatePending===!1&&(this._$ES=this._$ET())}P(e,t,s){this._$AL.has(e)||this._$AL.set(e,t),s.reflect===!0&&this._$Em!==e&&(this._$Ej??=new Set).add(e)}async _$ET(){this.isUpdatePending=!0;try{await this._$ES}catch(t){Promise.reject(t)}const e=this.scheduleUpdate();return e!=null&&await e,!this.isUpdatePending}scheduleUpdate(){return this.performUpdate()}performUpdate(){if(!this.isUpdatePending)return;if(!this.hasUpdated){if(this.renderRoot??=this.createRenderRoot(),this._$Ep){for(const[n,i]of this._$Ep)this[n]=i;this._$Ep=void 0}const s=this.constructor.elementProperties;if(s.size>0)for(const[n,i]of s)i.wrapped!==!0||this._$AL.has(n)||this[n]===void 0||this.P(n,this[n],i)}let e=!1;const t=this._$AL;try{e=this.shouldUpdate(t),e?(this.willUpdate(t),this._$EO?.forEach(s=>s.hostUpdate?.()),this.update(t)):this._$EU()}catch(s){throw e=!1,this._$EU(),s}e&&this._$AE(t)}willUpdate(e){}_$AE(e){this._$EO?.forEach(t=>t.hostUpdated?.()),this.hasUpdated||(this.hasUpdated=!0,this.firstUpdated(e)),this.updated(e)}_$EU(){this._$AL=new Map,this.isUpdatePending=!1}get updateComplete(){return this.getUpdateComplete()}getUpdateComplete(){return this._$ES}shouldUpdate(e){return!0}update(e){this._$Ej&&=this._$Ej.forEach(t=>this._$EC(t,this[t])),this._$EU()}updated(e){}firstUpdated(e){}}k.elementStyles=[],k.shadowRootOptions={mode:"open"},k[G("elementProperties")]=new Map,k[G("finalized")]=new Map,tt?.({ReactiveElement:k}),(K.reactiveElementVersions??=[]).push("2.0.4");/**
 * @license
 * Copyright 2017 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */class W extends k{constructor(){super(...arguments),this.renderOptions={host:this},this.o=void 0}createRenderRoot(){const e=super.createRenderRoot();return this.renderOptions.renderBefore??=e.firstChild,e}update(e){const t=this.render();this.hasUpdated||(this.renderOptions.isConnected=this.isConnected),super.update(e),this.o=Le(t,this.renderRoot,this.renderOptions)}connectedCallback(){super.connectedCallback(),this.o?.setConnected(!0)}disconnectedCallback(){super.disconnectedCallback(),this.o?.setConnected(!1)}render(){return Me}}W._$litElement$=!0,W.finalized=!0,globalThis.litElementHydrateSupport?.({LitElement:W});const st=globalThis.litElementPolyfillSupport;st?.({LitElement:W});(globalThis.litElementVersions??=[]).push("4.1.0");/**
 * @license
 * Copyright 2017 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */const nt=r=>(e,t)=>{t!==void 0?t.addInitializer(()=>{customElements.define(r,e)}):customElements.define(r,e)};/**
 * @license
 * Copyright 2017 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */const rt=(r,e,t)=>(t.configurable=!0,t.enumerable=!0,Reflect.decorate&&typeof e!="object"&&Object.defineProperty(r,e,t),t);/**
 * @license
 * Copyright 2021 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */function it(r){return(e,t)=>{const{slot:s,selector:n}=r??{},i="slot"+(s?`[name=${s}]`:":not([name])");return rt(e,t,{get(){const a=this.renderRoot?.querySelector(i),c=a?.assignedElements(r)??[];return n===void 0?c:c.filter(o=>o.matches(n))}})}}var ot=Object.defineProperty,at=Object.getOwnPropertyDescriptor,Se=(r,e,t,s)=>{for(var n=s>1?void 0:s?at(e,t):e,i=r.length-1,a;i>=0;i--)(a=r[i])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&ot(e,t,n),n};let q=class extends W{constructor(){super(...arguments),this.callbacks={show:{},hide:{}}}static get ready(){return customElements.whenDefined("my-scene")}set(r){this.views.forEach(e=>{const t=e.getAttribute("name");if(t)if(t==r){if(e.hasAttribute("active"))return;this.callbacks.show[r]?.(),e.setAttribute("active","")}else e.hasAttribute("active")&&(e.removeAttribute("active"),this.callbacks.hide[t]?.())})}get(){return this.views.find(r=>r.hasAttribute("active"))?.getAttribute("name")}on(r,e,t){this.callbacks[r][e]=t}render(){return Ie`<slot></slot>`}};Se([it({slot:""})],q.prototype,"views",2);q=Se([nt("my-scene")],q);const ct=q;function lt(){const r=navigator.userAgent;return r.indexOf("Win")!==-1?"Windows":r.indexOf("Mac")!==-1&&r.indexOf("iPhone")===-1&&r.indexOf("iPad")===-1?"MacOS":r.indexOf("Linux")!==-1&&r.indexOf("Android")===-1?"Linux":/Android/i.test(r)?"Android":/iPhone|iPad|iPod/i.test(r)?"iOS":"Unknown"}function S(r){return r.startsWith("#")?document.getElementById(r.slice(1)):document.querySelectorAll(r)}const ht=S("#connect-problem-note"),dt=S("#browser-support-note"),M=S("#button-connect"),ut=S(".button-disconnect"),ft=S("#device-name"),oe=S("#device-connection-status"),pt=S(".update-version-device"),gt=S(".update-buttons"),Q=S("#upload-status"),Ae=S("#changelog"),me=S("#show-advanced"),mt=S("#upload-samples"),Ee=S("#upload-samples-status"),De="MONKEY",U=new ke,ne=new Ve(U),re=new ze(U);let ve=null,X=!1,Ue=null,R=null,L=null;const Pe=document.getElementById("scene-main"),be=document.getElementById("scene-bluetooth"),we=document.getElementById("scene-utility-tools"),B=document.getElementById("scene-updater");ct.ready.then(()=>{if(navigator&&navigator.bluetooth&&navigator.bluetooth.getAvailability())be.set("available");else{const r={MacOS:"On <u>macOS</u> we recommend to use Chrome or a Chrome based browser.",Windows:"On <u>Windows</u> we recommend to use Chrome or a Chrome based browser.",Linux:"On <u>Linux</u> we recommend to use Chrome or a Chrome based browser.",Android:"On <u>Android</u> we recommend to use Chrome or a Chrome based browser.",iOS:"On iPhone and iPad you can use a browser named <u>Bluefy</u>.",Unknown:"We recommend to use Chrome or a Chrome based browser."},e=lt();dt.innerHTML=r[e],be.set("unavailable")}});U.onDeviceSelection=()=>{M.disabled=!0};U.onDeviceSelectionCancel=()=>{M.disabled=!1,ht.classList.remove("hidden")};U.onConnecting=()=>{M.disabled=!0,M.innerText="Connecting..."};U.onConnect=()=>{console.log("device connected"),oe.style.backgroundColor="#45C367",ft.innerText=U.name,(async()=>(bt(),await Re(),await vt()))(),Pe.set("connected")};const Et=M.innerText;U.onDisconnect=()=>{M.disabled=!1,M.innerText=Et,Pe.set("disconnected"),Ae.innerHTML=""};U.onConnectionLoss=()=>oe.style.backgroundColor="#E89209";U.onConnectionReestablished=async()=>{console.log("device reconnected"),oe.style.backgroundColor="#45C367",Ue?.(null),(async()=>B.get()!="updating"&&await Re())()};async function vt(){console.log("checking sample manager state");try{await re.isSet()||(console.log("no samples are set, setting default"),await $e()),ve=await re.getIDs(),document.querySelector("#device-tools-header nav").innerHTML=`
			<a href="#device-update" active>Device update</a>
			<a href="#sample-manager">Sample manager</a>
		`,window.addEventListener("hashchange",J),J()}catch{ve=null,document.querySelector("#device-tools-header nav").innerHTML="",window.removeEventListener("hashchange",J)}}function J(){const r=window.location.hash;(r==null||r=="")&&(window.location.hash="#device-update"),document.querySelectorAll("nav a").forEach(t=>{t.removeAttribute("active")});const e=document.querySelector(`nav a[href="${r}"]`);e&&e.setAttribute("active",""),r==="#device-update"?we.set("device-update"):r==="#sample-manager"&&we.set("sample-manager")}M.addEventListener("click",async()=>{let e=[{namePrefix:"WAVY MONKEY",services:["03B80E5A-EDE8-4B33-A751-6CE34EC4C700".toLowerCase()]}];await U.connect(e)});ut.forEach(r=>{r.addEventListener("click",async()=>{U.disconnect()})});me.addEventListener("change",()=>{X=me.checked,Z()});gt.forEach(r=>{r.addEventListener("click",wt)});mt.addEventListener("click",$e);async function bt(){const e=await(await fetch(`/firmware/${De}/changelog.md`)).text();R=Be(e),console.log(R),Z()}async function Re(){L=await ne.getFirmwareVersion(),Z()}function Z(){if(!L||!R)return;pt.forEach(i=>{i.innerText=L.versionString}),S(".update-version-to").forEach(i=>{i.innerText=X&&j(R.release,R.dev)?R.dev.versionString+" [BETA]":R.release.versionString});let e=!1,t=!0,s=!1,n="";R.versions.forEach(i=>{if(i.isDev&&!X||i.isObsolete)return;const a=j(L,i.version),c=L.versionString===i.version.versionString;a&&(e=!0),(a||c)&&(t=!1),!a&&s&&(n+='<hr width="100%" />'),s=a,n+=`
            <div class="changelog-item" style="${i.isDev?"background-color: #eee;":""}"" ${a?"new":""}>
                <p><b>${i.version.versionString}${i.highlight?" "+i.highlight:""}${i.isDev?" [BETA]":""}</b><span><i>${i.date??""}</i></span></p>
                ${i.changes.map(o=>`- ${o}<br/>`).join("")}
            </div>
        `}),Ae.innerHTML=n,e?B.set("update-available"):t?B.set("downgrade-available"):B.set("updated")}async function wt(){try{const r=S("#update-stage-fetch"),e=S("#update-stage-uploading"),t=S("#update-stage-applying"),s=S("#update-stage-verifying"),n=S("#update-stage-done");r.removeAttribute("active"),e.removeAttribute("active"),t.removeAttribute("active"),s.removeAttribute("active"),n.removeAttribute("active"),r.removeAttribute("done"),e.removeAttribute("done"),t.removeAttribute("done"),s.removeAttribute("done"),n.removeAttribute("done"),Q.innerText="",B.set("updating"),r.setAttribute("active","");const i=X?R.dev.versionString:R.release.versionString,a=await fetch(`/firmware/${De}/app_update_${i}.bin`).then(o=>o.arrayBuffer());r.removeAttribute("active"),r.setAttribute("done",""),e.setAttribute("active",""),Q.innerText="(preparing)",await ne.uploadImage(a,o=>{Q.innerText=`(${o}%)`}),e.removeAttribute("active"),e.setAttribute("done","");const c=new Promise((o,m)=>Ue=o);if(t.setAttribute("active",""),await c,t.removeAttribute("active"),t.setAttribute("done",""),s.setAttribute("active",""),L=await ne.getFirmwareVersion(),L.versionString!=i)throw new Error(`Update failed: Device firmware version is ${L.versionString} but expected ${i}`);s.removeAttribute("active"),s.setAttribute("done",""),n.setAttribute("done",""),await new Promise((o,m)=>setTimeout(o,2e3)),Z()}catch(r){console.error(r),B.set("update-available")}}async function $e(){try{re.uploadSamples(We(),r=>Ee.innerHTML=`${r}%`)}catch(r){console.error(r),Ee.innerHTML="Failed to upload"}}
