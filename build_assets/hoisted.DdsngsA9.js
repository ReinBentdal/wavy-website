var j=5.960464477539063e-8,P=4294967296,$=9007199254740992;function J(e){var t,n=new ArrayBuffer(256),s=new DataView(n),i=0;function r(e){for(var r=n.byteLength,a=i+e;r<a;)r<<=1;if(r!==n.byteLength){var c=s;n=new ArrayBuffer(r),s=new DataView(n);for(var o=i+3>>2,l=0;l<o;++l)s.setUint32(l<<2,c.getUint32(l<<2))}return t=e,s}function a(){i+=t}function c(e){a(r(1).setUint8(i,e))}function o(e){for(var t=r(e.length),n=0;n<e.length;++n)t.setUint8(i+n,e[n]);a()}function l(e,t){t<24?c(e<<5|t):t<256?(c(e<<5|24),c(t)):t<65536?(c(e<<5|25),function(e){a(r(2).setUint16(i,e))}(t)):t<4294967296?(c(e<<5|26),function(e){a(r(4).setUint32(i,e))}(t)):(c(e<<5|27),function(e){var t=e%P,n=(e-t)/P,s=r(8);s.setUint32(i,n),s.setUint32(i+4,t),a()}(t))}if(function e(t){var n;if(!1===t)return c(244);if(!0===t)return c(245);if(null===t)return c(246);if(void 0===t)return c(247);switch(typeof t){case"number":if(Math.floor(t)===t){if(0<=t&&t<=$)return l(0,t);if(-$<=t&&t<0)return l(1,-(t+1))}return c(251),function(e){a(r(8).setFloat64(i,e))}(t);case"string":var s=[];for(n=0;n<t.length;++n){var h=t.charCodeAt(n);h<128?s.push(h):h<2048?(s.push(192|h>>6),s.push(128|63&h)):h<55296?(s.push(224|h>>12),s.push(128|h>>6&63),s.push(128|63&h)):(h=(1023&h)<<10,h|=1023&t.charCodeAt(++n),h+=65536,s.push(240|h>>18),s.push(128|h>>12&63),s.push(128|h>>6&63),s.push(128|63&h))}return l(3,s.length),o(s);default:var u;if(Array.isArray(t))for(l(4,u=t.length),n=0;n<u;++n)e(t[n]);else if(t instanceof Uint8Array)l(2,t.length),o(t);else{var d=Object.keys(t);for(l(5,u=d.length),n=0;n<u;++n){var g=d[n];e(g),e(t[g])}}}}(e),"slice"in n)return n.slice(0,i);for(var h=new ArrayBuffer(i),u=new DataView(h),d=0;d<i;++d)u.setUint8(d,s.getUint8(d));return h}function Q(e,t,n){var s=new DataView(e),i=0;function r(e,t){return i+=e,t}function a(t){return r(t,new Uint8Array(e,i,t))}function c(){return r(1,s.getUint8(i))}function o(){return r(2,s.getUint16(i))}function l(){return r(4,s.getUint32(i))}function h(){return 255===s.getUint8(i)&&(i+=1,!0)}function u(e){if(e<24)return e;if(24===e)return c();if(25===e)return o();if(26===e)return l();if(27===e)return l()*P+l();if(31===e)return-1;throw"Invalid length encoding"}function d(e){var t=c();if(255===t)return-1;var n=u(31&t);if(n<0||t>>5!==e)throw"Invalid indefinite length element";return n}function g(e,t){for(var n=0;n<t;++n){var s=c();128&s&&(s<224?(s=(31&s)<<6|63&c(),t-=1):s<240?(s=(15&s)<<12|(63&c())<<6|63&c(),t-=2):(s=(15&s)<<18|(63&c())<<12|(63&c())<<6|63&c(),t-=3)),s<65536?e.push(s):(s-=65536,e.push(55296|s>>10),e.push(56320|1023&s))}}"function"!=typeof t&&(t=function(e){return e}),"function"!=typeof n&&(n=function(){});var f=function e(){var l,f,_=c(),p=_>>5,v=31&_;if(7===p)switch(v){case 25:return function(){var e=new ArrayBuffer(4),t=new DataView(e),n=o(),s=32768&n,i=31744&n,r=1023&n;if(31744===i)i=261120;else if(0!==i)i+=114688;else if(0!==r)return(s?-1:1)*r*j;return t.setUint32(0,s<<16|i<<13|r<<13),t.getFloat32(0)}();case 26:return r(4,s.getFloat32(i));case 27:return r(8,s.getFloat64(i))}if((f=u(v))<0&&(p<2||6<p))throw"Invalid length";switch(p){case 0:return f;case 1:return-1-f;case 2:if(f<0){for(var w=[],m=0;(f=d(p))>=0;)m+=f,w.push(a(f));var E=new Uint8Array(m),I=0;for(l=0;l<w.length;++l)E.set(w[l],I),I+=w[l].length;return E}return a(f);case 3:var y=[];if(f<0)for(;(f=d(p))>=0;)g(y,f);else g(y,f);return String.fromCharCode.apply(null,y);case 4:var b;if(f<0)for(b=[];!h();)b.push(e());else for(b=new Array(f),l=0;l<f;++l)b[l]=e();return b;case 5:var A={};for(l=0;l<f||f<0&&!h();++l){A[e()]=e()}return A;case 6:return t(e(),f);case 7:switch(f){case 20:return!1;case 21:return!0;case 22:return null;case 23:return;default:return n(f)}}}();if(i!==e.byteLength)throw"Remaining bytes";return f}const O={encode:J,decode:Q},A={READ:0,READ_RSP:1,WRITE:2,WRITE_RSP:3},w={OS:0,IMAGE:1,STAT:2,CONFIG:3,LOG:4,CRASH:5,SPLIT:6,RUN:7,FS:8,SHELL:9},R={ECHO:0,CONS_ECHO_CTRL:1,TASKSTAT:2,MPSTAT:3,DATETIME_STR:4,RESET:5},S={STATE:0,UPLOAD:1,FILE:2,CORELIST:3,CORELOAD:4,ERASE:5};class X{constructor(e={}){this.SMP_SERVICE_UUID="8d53dc1d-1db7-4cd3-868b-8a527460aa84",this.SMP_CHARACTERISTIC_UUID="da2e7828-fbce-4e01-ae9e-261174997c48",this._mtu=140,this._device=null,this._service=null,this._characteristic=null,this._connectCallback=null,this._connectingCallback=null,this._disconnectCallback=null,this._connectionLossCallback=null,this._messageCallback=null,this._imageUploadProgressCallback=null,this._uploadIsInProgress=!1,this._buffer=new Uint8Array,this._logger=e.logger||{info:console.log,error:console.error},this._seq=0,this._userRequestedDisconnect=!1}async _requestDevice(e){const t={acceptAllDevices:!1,optionalServices:[this.SMP_SERVICE_UUID]};return e&&(t.filters=e,t.acceptAllDevices=!1),navigator.bluetooth.requestDevice(t)}async connect(e){try{this._device=await this._requestDevice(e),this._logger.info(`Connecting to device ${this.name}...`),this._device.addEventListener("gattserverdisconnected",(async e=>{this._logger.info(e),!1===this._userRequestedDisconnect?(this._logger.info("Trying to reconnect"),await new Promise((e=>setTimeout(e,1e3))),this._connectionLossCallback&&this._connectionLossCallback(),await this._connect()):this._disconnected()})),await this._connect()}catch(e){return this._logger.error(e),void await this._disconnected()}}async _connect(){try{this._connectingCallback&&this._connectingCallback();const e=await this._device.gatt.connect();this._logger.info("Server connected."),this._service=await e.getPrimaryService(this.SMP_SERVICE_UUID),this._logger.info("Service connected."),this._characteristic=await this._service.getCharacteristic(this.SMP_CHARACTERISTIC_UUID),this._characteristic.addEventListener("characteristicvaluechanged",this._notification.bind(this)),await this._characteristic.startNotifications(),await this._connected(),this._uploadIsInProgress&&this._uploadNext()}catch(e){this._logger.error(e),await this._disconnected()}}disconnect(){return this._userRequestedDisconnect=!0,this._device.gatt.disconnect()}onConnecting(e){return this._connectingCallback=e,this}onConnect(e){return this._connectCallback=e,this}onDisconnect(e){return this._disconnectCallback=e,this}onConnectionLoss(e){return this._connectionLossCallback=e,this}onMessage(e){return this._messageCallback=e,this}onImageUploadProgress(e){return this._imageUploadProgressCallback=e,this}onImageUploadFinished(e){return this._imageUploadFinishedCallback=e,this}async _connected(){this._connectCallback&&this._connectCallback()}async _disconnected(){this._logger.info("Disconnected."),this._disconnectCallback&&this._disconnectCallback(),this._device=null,this._service=null,this._characteristic=null,this._uploadIsInProgress=!1,this._userRequestedDisconnect=!1}get name(){return this._device&&this._device.name}async _sendMessage(e,t,n,s){let i=[];typeof s<"u"&&(i=[...new Uint8Array(O.encode(s))]);const r=255&i.length,a=[e,0,i.length>>8,r,t>>8,255&t,this._seq,n,...i];await this._characteristic.writeValueWithoutResponse(Uint8Array.from(a)),this._seq=(this._seq+1)%256}_notification(e){const t=new Uint8Array(e.target.value.buffer);this._buffer=new Uint8Array([...this._buffer,...t]);const n=256*this._buffer[2]+this._buffer[3];this._buffer.length<n+8||(this._processMessage(this._buffer.slice(0,n+8)),this._buffer=this._buffer.slice(n+8))}_processMessage(e){const[t,n,s,i,r,a,c,o]=e,l=O.decode(e.slice(8).buffer),h=256*s+i,u=256*r+a;if(u===w.IMAGE&&o===S.UPLOAD&&(0===l.rc||void 0===l.rc)&&l.off)return this._uploadOffset=l.off,void this._uploadNext();this._messageCallback&&this._messageCallback({op:t,group:u,id:o,data:l,length:h})}cmdReset(){return this._sendMessage(A.WRITE,w.OS,R.RESET)}smpEcho(e){return this._sendMessage(A.WRITE,w.OS,R.ECHO,{d:e})}cmdImageState(){return this._sendMessage(A.READ,w.IMAGE,S.STATE)}cmdImageErase(){return this._sendMessage(A.WRITE,w.IMAGE,S.ERASE,{})}cmdImageTest(e){return this._sendMessage(A.WRITE,w.IMAGE,S.STATE,{hash:e,confirm:!1})}cmdImageConfirm(e){return this._sendMessage(A.WRITE,w.IMAGE,S.STATE,{hash:e,confirm:!0})}_hash(e){return crypto.subtle.digest("SHA-256",e)}async _uploadNext(){if(this._uploadOffset>=this._uploadImage.byteLength)return this._uploadIsInProgress=!1,void this._imageUploadFinishedCallback();const e={data:new Uint8Array,off:this._uploadOffset};0===this._uploadOffset&&(e.len=this._uploadImage.byteLength,e.sha=new Uint8Array(await this._hash(this._uploadImage))),this._imageUploadProgressCallback({percentage:Math.floor(this._uploadOffset/this._uploadImage.byteLength*100)});const t=this._mtu-O.encode(e).byteLength-8;e.data=new Uint8Array(this._uploadImage.slice(this._uploadOffset,this._uploadOffset+t)),this._uploadOffset+=t,this._sendMessage(A.WRITE,w.IMAGE,S.UPLOAD,e)}async cmdUpload(e,t=0){this._uploadIsInProgress?this._logger.error("Upload is already in progress."):(this._uploadIsInProgress=!0,this._uploadOffset=0,this._uploadImage=e,this._uploadSlot=t,this._uploadNext())}async imageInfo(e){const t={},n=new Uint8Array(e);if(n.length<32)throw new Error("Invalid image (too short file)");if(61!==n[0]||184!==n[1]||243!==n[2]||150!==n[3])throw new Error("Invalid image (wrong magic bytes)");if(0!==n[4]||0!==n[5]||0!==n[6]||0!==n[7])throw new Error("Invalid image (wrong load address)");const s=n[8]+256*n[9];if(0!==n[10]||0!==n[11])throw new Error("Invalid image (wrong protected TLV area size)");const i=n[12]+256*n[13]+65536*n[14]+n[15]*2**24;if(t.imageSize=i,n.length<i+s)throw new Error("Invalid image (wrong image size)");if(0!==n[16]||0!==n[17]||0!==n[18]||0!==n[19])throw new Error("Invalid image (wrong flags)");const r=`${n[20]}.${n[21]}.${n[22]+256*n[23]}`;return t.version=r,t.hash=[...new Uint8Array(await this._hash(e.slice(0,i+32)))].map((e=>e.toString(16).padStart(2,"0"))).join(""),t}}class B{constructor(e){this.current=e,void 0!==this.current&&(document.getElementById(this.current).style.display="block")}set(e){void 0!==this.current&&document.getElementById(this.current).style.removeProperty("display"),this.current=e,void 0!==this.current&&(document.getElementById(this.current).style.display="block")}get(){return this.current}}const V="MONKEY",F="r2",K={MONKEY:{r1:"0.6.1",r2:"0.6.2"}},W=new B("initial-screen"),z=new B,T=new B("update-waiting-screen"),D=document.getElementById("button-connect"),Z=document.getElementById("button-disconnect"),ee=document.getElementById("device-name"),te=document.getElementById("device-fw-version"),ne=document.getElementById("latest-fw-version"),se=document.getElementById("update-button"),ie=document.getElementById("upload-status");navigator&&navigator.bluetooth&&navigator.bluetooth.getAvailability()?z.set("bt-available-screen"):z.set("bt-unavailable-screen");const p=new X;p.onConnecting((()=>{console.log("Connecting..."),D.disabled=!0,D.innerText="Connecting..."})),p.onConnect((()=>{ee.innerText=p.name,p.cmdImageState(),ne.innerHTML=K[V][F],W.set("connected-screen")})),p.onDisconnect((()=>{D.disabled=!1,D.innerText="Conncet via Bluetooth",W.set("initial-screen")})),p.onConnectionLoss((()=>{W.set("reconnect-screen")})),p.onMessage((({op:e,group:t,id:n,data:s,length:i})=>{switch(t){case w.OS:switch(n){case R.ECHO:alert(s.r);break;case R.TASKSTAT:console.table(s.tasks);break;case R.MPSTAT:console.log(s)}break;case w.IMAGE:if(n===S.STATE)s.images.forEach((e=>{e.active&&(te.innerHTML=e.version,e.version==K[V][F]?T.set("update-good-screen"):T.set("update-idle-screen"))}));break;default:console.log("Unknown group")}})),p.onImageUploadProgress((({percentage:e})=>{0!=e&&"update-uploading-screen"!=T.get()&&T.set("update-uploading-screen"),ie.innerText=`${e}%`})),p.onImageUploadFinished((()=>{T.set("update-complete-screen")})),D.addEventListener("click",(async()=>{let e=[{namePrefix:"WAVY MONKEY",services:["03B80E5A-EDE8-4B33-A751-6CE34EC4C700".toLowerCase()]}];await p.connect(e)})),Z.addEventListener("click",(async()=>{p.disconnect()})),se.addEventListener("click",(async()=>{try{T.set("update-prepare-screen"),fetch(`/assets/firmware/${V}/${F}/app_update.bin`).then((e=>e.arrayBuffer())).then((e=>{p.cmdUpload(e)}))}catch{T.set("update-idle-screen")}}));